{"version":3,"sources":["../../../es6/directives/gameTemplate/spray.js"],"names":[],"mappings":"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","file":"spray.js","sourcesContent":["'use strict';\n\nangular.module('clickApp.directives')\n  .factory('sprayTemplateElement', [\n    '$window',\n    'template',\n    'sprayTemplate',\n    'gameTemplateSelection',\n    'gameModels',\n    'gameFactions',\n    'gameMap',\n    'labelElement',\n    function($window,\n             templateService,\n             sprayTemplateService,\n             gameTemplateSelectionService,\n             gameModelsService,\n             gameFactionsService,\n             gameMapService,\n             labelElementService) {\n      var POINTS = {\n        6: '8.75,0 5.125,-59 10,-60 14.875,-59 11.25,0',\n        8: '8.75,0 3.5,-78.672 10,-80 16.5,-78.672 11.25,0',\n        10: '8.75,0 1.875,-98.34 10,-100 18.125,-98.34 11.25,0',\n      };\n      var sprayTemplateElementService = {\n        create: function sprayTemplateElementServiceCreate(svgNS, parent, spray) {\n          var over_models = document.getElementById('game-over-models');\n          \n          var group = document.createElementNS(svgNS, 'g');\n          parent.appendChild(group);\n\n          var polygon = document.createElementNS(svgNS, 'polygon');\n          polygon.classList.add('template');\n          polygon.classList.add('spray');\n          polygon.setAttribute('data-stamp', spray.state.stamp);\n          group.appendChild(polygon);\n\n          var label = labelElementService.create(svgNS, group);\n\n          var origin = document.createElementNS(svgNS, 'circle');\n          origin.classList.add('spray-origin');\n          origin.setAttribute('cx', '0');\n          origin.setAttribute('cy', '0');\n          origin.setAttribute('r', '0');\n          origin.style.visibility = 'hidden';\n          over_models.appendChild(origin);\n\n          return { container: group,\n                   spray: polygon,\n                   label: label,\n                   origin: origin,\n                 };\n        },\n        update: function sprayTemplateElementUpdate(map, scope, template, spray) {\n          var selection = scope.game.template_selection;\n          var local =\n              gameTemplateSelectionService.in('local', template.state.stamp,\n                                              selection);\n          var remote =\n              gameTemplateSelectionService.in('remote', template.state.stamp,\n                                              selection);\n          var selected = (local || remote);\n          var stroke_color = ( selected ?\n                               ( local ? '#0F0' : '#FFF') :\n                               '#C60'\n                             );\n          \n          var map_flipped = gameMapService.isFlipped(map);\n          var zoom_factor = gameMapService.zoomFactor(map);\n          var label_flip_center = template.state;\n          var label_text_center = { x: template.state.x,\n                                    y: template.state.y + 5\n                                  };\n          var label_text = templateService.fullLabel(template);\n          $window.requestAnimationFrame(function _sprayTemplateElementUpdate() {\n            updateContainer(template, spray.container);\n            updateSpray(stroke_color, template, spray.spray);\n            labelElementService.update(map_flipped,\n                                       zoom_factor,\n                                       label_flip_center,\n                                       label_text_center,\n                                       label_text,\n                                       spray.label);\n            $window.requestAnimationFrame(function _aoeTemplateElementUpdate2() {\n              if(gameTemplateSelectionService.inSingle('local', template.state.stamp,\n                                                       scope.game.template_selection)) {\n                scope.gameEvent('changeSingleAoESelection', null);\n              }\n            });\n          });\n\n          R.pipeP(\n            function() {\n              return self.Promise\n                .resolve(sprayTemplateService.origin(template));\n            },\n            function(origin) {\n              if(R.isNil(origin)) return;\n              \n              return gameModelsService.findStamp(origin, scope.game.models);\n            },\n            function(origin_model) {\n              updateOrigin(scope.factions, local, origin_model, spray.origin);\n            }\n          )();\n        },\n      };\n      function updateContainer(template, container) {\n        container.setAttribute('transform', [\n          'rotate(',\n          template.state.r,\n          ',',\n          template.state.x,\n          ',',\n          template.state.y,\n          ')'\n        ].join(''));\n      }\n      function updateSpray(stroke_color, template, spray) {\n        spray.setAttribute('transform', [\n          'translate(',\n          template.state.x-10,\n          ',',\n          template.state.y,\n          ')'\n        ].join(''));\n        spray.setAttribute('points', POINTS[template.state.s+'']);\n        spray.style.stroke = stroke_color;\n      }\n      function updateOrigin(factions, local, model, origin) {\n        $window.requestAnimationFrame(function _aoeTemplateElementUpdateOrigin() {\n          if(!local ||\n             R.isNil(model)) {\n            origin.style.visibility = 'hidden';\n            return;\n          }\n          R.pipeP(\n            gameFactionsService.getModelInfo$(model.state.info),\n            function(info) {\n              origin.setAttribute('cx', model.state.x+'');\n              origin.setAttribute('cy', model.state.y+'');\n              origin.setAttribute('r', info.base_radius+'');\n              origin.style.visibility = 'visible';\n            }\n          )(factions);\n        });\n      }\n      return sprayTemplateElementService;\n    }\n  ]);\n"]}