{"version":3,"sources":["../../../es6/services/game/connection.js"],"names":[],"mappings":"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","file":"connection.js","sourcesContent":["'use strict';\n\nangular.module('clickApp.services')\n  .factory('gameConnection', [\n    'pubSub',\n    'websocket',\n    'commands',\n    function gameConnectionServiceFactory(pubSubService,\n                                          websocketService,\n                                          commandsService) {\n      var gameConnectionService = {\n        create: function gameConnectionInit(game) {\n          var connection = {\n            state: { socket: null },\n            channel: pubSubService.init()\n          };\n          return R.assoc('connection', connection, game);\n        },\n        open: function gameConnectionOpen(user_name, scope, game) {\n          if(R.exists(game.connection.state.socket)) {\n            return self.Promise.resolve(game.connection);\n          }\n          user_name = s.trim(user_name);\n\n          var handlers = {\n            close: closeHandler$(game),\n            chat: chatHandler$(scope, game),\n            replayCmd: replayCmdHandler$(scope, game),\n            undoCmd: undoCmdHandler$(scope, game),\n            cmdBatch: cmdBatchHandler$(scope, game),\n            setCmds: setCmdsHandler$(scope, game),\n            players: playersHandler$(scope, game),\n          };\n\n          game.connection.state = R.assoc('socket', null,\n                                          game.connection.state);\n\n          var url = [\n            '/api/games',\n            ( R.prop('private_stamp', game) ?\n              'private' :\n              'public'\n            ),\n            ( R.prop('private_stamp', game) ?\n              R.prop('private_stamp', game) :\n              R.prop('public_stamp', game)\n            )\n          ].join('/');\n          url += '?name='+user_name;\n          \n          return R.pipeP(\n            function() {\n              return websocketService\n                .create(url, 'game', handlers);\n            },\n            function(socket) {\n              game.connection.state = R.assoc('socket', socket,\n                                              game.connection.state);\n              return game;\n            }\n          )();\n        },\n        close: function gameConnectionClose(game) {\n          return R.pipeP(\n            function() {\n              if(R.isNil(game.connection.state.socket)) {\n                return self.Promise.resolve();\n              }\n              return websocketService\n                .close(game.connection.state.socket);\n            },\n            function() {\n              cleanupConnection(game.connection);\n              return game;\n            }\n          )();\n        },\n        active: function gameConnectionActive(game) {\n          return R.pipe(\n            R.path(['connection','state','socket']),\n            R.exists\n          )(game);\n        },\n        sendEvent: function gameConnectionSendEvent(event, game) {\n          if(!gameConnectionService.active(game)) {\n            return self.Promise.reject('Not active');\n          }\n          return websocketService\n            .send(event, game.connection.state.socket);\n        },\n      };\n      function cleanupConnection(connection) {\n        connection.state = R.assoc('socket', null,\n                                   connection.state);\n      }\n      function closeHandler$(game) {\n        return function closeHandler() {\n          console.log('Game connection: close');\n          cleanupConnection(game.connection);\n          pubSubService.publish('close', game.connection.channel);\n        };\n      }\n      var replayCmdHandler$ = R.curry(function replayCmdHandler(scope, game, msg) {\n        console.log('Game connection: replayCmd event', msg);\n        return R.pipeP(\n          R.bind(self.Promise.resolve, self.Promise),\n          function(command) {\n            if(R.find(R.propEq('stamp', command.stamp), game.commands_log)) {\n              game.commands_log = R.reject(R.propEq('stamp', command.stamp),\n                                           game.commands_log);\n              console.log('Game connection: replayCmd log', msg);\n              return;\n            }\n            return commandsService.replay(command, scope, game);\n          },  \n          function() {\n            game.undo = R.reject(R.propEq('stamp', msg.cmd.stamp),\n                                 game.undo);\n            if(!msg.cmd.do_not_log) {\n              game.commands = R.append(msg.cmd, game.commands);\n            }\n            scope.gameEvent('command', 'replay');\n\n            return scope.saveGame(game);\n          }\n        )(msg.cmd);\n      });\n      var undoCmdHandler$ = R.curry(function undoCmdHandler(scope, game, msg) {\n        console.log('Game connection: undoCmd event', msg);\n        return R.pipeP(\n          R.bind(self.Promise.resolve, self.Promise),\n          function(command) {\n            if(R.find(R.propEq('stamp', command.stamp), game.undo_log)) {\n              game.undo_log = R.reject(R.propEq('stamp', command.stamp),\n                                       game.undo_log);\n              console.log('Game connection: undoCmd log', msg);\n              return;\n            }\n            return commandsService.undo(command, scope, game);\n          },\n          function() {\n            game.commands = R.reject(R.propEq('stamp', msg.cmd.stamp),\n                                     game.commands);\n            game.undo = R.append(msg.cmd, game.undo);\n\n            scope.gameEvent('command', 'undo');\n\n            return scope.saveGame(game);\n          }\n        )(msg.cmd);\n      });\n      var cmdBatchHandler$ = R.curry(function cmdBatchHandler(scope, game, msg) {\n        console.log('Game connection: cmdBatch event', msg);\n        scope.gameEvent('gameLoading');\n        return R.pipeP(\n          function() {\n            return commandsService\n              .replayBatch(msg.cmds, scope, game);\n          },\n          function() {\n            game.commands = R.concat(game.commands, msg.cmds);\n            if(msg.end) scope.gameEvent('gameLoaded');\n\n            return scope.saveGame(game);\n          }\n        )();\n      });\n      var chatHandler$ = R.curry(function chatHandler(scope, game, msg) {\n        console.log('Game connection: chat event', msg);\n        game.chat = R.append(msg.chat, game.chat);\n\n        scope.gameEvent('chat');\n        return scope.saveGame(game);\n      });\n      var setCmdsHandler$ = R.curry(function setCmdsHandler(scope, game, msg) {\n        console.log('Game connection: setCmds event', msg);\n        game[msg.where] = msg.cmds;\n\n        return scope.saveGame(game);\n      });\n      var playersHandler$ = R.curry(function playersHandler(scope, game, msg) {\n        console.log('Game connection: players event', msg);\n        game.players = msg.players;\n\n        return scope.saveGame(game);\n      });\n      R.curryService(gameConnectionService);\n      return gameConnectionService;\n    }\n  ]);\n"]}