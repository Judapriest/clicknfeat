{"version":3,"sources":["../../es6/services/userConnection.js"],"names":[],"mappings":"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","file":"userConnection.js","sourcesContent":["'use strict';\n\nangular.module('clickApp.services')\n  .factory('userConnection', [\n    'http',\n    'pubSub',\n    'websocket',\n    function userConnectionServiceFactory(httpService,\n                                          pubSubService,\n                                          websocketService) {\n      var userConnectionService = {\n        create: function userConnectionInit(user) {\n          var connection = {\n            state: { socket: null },\n            channel: pubSubService.init()\n          };\n          return R.assoc('connection', connection, user);\n        },\n        open: function userConnectionOpen(user) {\n          if(R.exists(user.connection.state.socket)) {\n            return self.Promise.resolve(user.connection);\n          }\n\n          var handlers = {\n            close: closeHandler$(user.connection),\n            users: usersMessageHandler$(user.connection),\n            games: gamesMessageHandler$(user.connection),\n            chat: chatMessageHandler$(user.connection),\n          };\n\n          user.connection.state = R.assoc('socket', null,\n                                          user.connection.state);\n          \n          return R.pipeP(\n            function() {\n              return websocketService\n                .create('/api/users/'+user.state.stamp, 'user', handlers);\n            },\n            function(socket) {\n              user.connection.state = R.assoc('socket', socket,\n                                              user.connection.state);\n              return user;\n            }\n          )();\n        },\n        close: function userConnectionClose(user) {\n          return R.pipeP(\n            function() {\n              if(R.isNil(user.connection.state.socket)) {\n                return self.Promise.resolve();\n              }\n              return websocketService\n                .close(user.connection.state.socket);\n            },\n            function() {\n              cleanupConnection(user.connection);\n              return user;\n            }\n          )();\n        },\n        active: function userConnectionActive(user) {\n          return R.pipe(\n            R.path(['connection','state','socket']),\n            R.exists\n          )(user);\n        },\n        sendChat: function userConnectionSendChat(dest, msg) {\n          var args = Array.prototype.slice.apply(arguments);\n          var user = R.last(args);\n          \n          if(!userConnectionService.active(user)) {\n            return self.Promise.reject('Not active');\n          }\n          \n          return websocketService.send({\n            type: 'chat',\n            from: user.state.stamp,\n            to: dest,\n            msg: msg,\n            link: ( R.length(args) === 4 ?\n                    R.nth(2, args) :\n                    null\n                  )\n          }, user.connection.state.socket);\n        },\n        userNameForStamp: function userNameForStamp(stamp, user) {\n          return R.pipe(\n            userForStamp$(stamp),\n            R.defaultTo({ name: 'Unknown' }),\n            R.prop('name'),\n            function(n) {\n              return s(n).trim().capitalize().value();\n            }\n          )(user.connection);\n        },\n        usersNamesForStamps: function usersNamesForStamps(stamps, user) {\n          return R.pipe(\n            R.defaultTo({}),\n            R.propOr({}, 'connection'),\n            usersForStamps$(R.defaultTo([], stamps)),\n            R.pluck('name'),\n            function(names) {\n              return ( R.isEmpty(names) ?\n                       [ 'Unknown' ] :\n                       names\n                     );\n            },\n            R.map(function(n) {\n              return s(n).trim().capitalize().value();\n            })\n          )(user);\n        },\n      };\n      function cleanupConnection(connection) {\n        connection.state = R.assoc('socket', null,\n                                   connection.state);\n        connection.users = [];\n      }\n      function closeHandler$(connection) {\n        return function closeHandler() {\n          console.log('User connection: close');\n          cleanupConnection(connection);\n          pubSubService.publish('close', connection.channel);\n        };\n      }\n      var usersMessageHandler$ = R.curry(function usersMessageHandler(connection, msg) {\n        console.log('User connection: users list', msg);\n        connection.users = R.pipe(\n          R.propOr([], 'users'),\n          R.sortBy(R.compose(R.toLower, R.prop('name')))\n        )(msg);\n        pubSubService.publish('users', connection.users, connection.channel);\n      });\n      var gamesMessageHandler$ = R.curry(function gamesMessageHandler(connection, msg) {\n        console.log('User connection: games list', msg);\n        connection.games = R.pipe(\n          R.propOr([], 'games')\n        )(msg);\n        pubSubService.publish('games', connection.games, connection.channel);\n      });\n      var chatMessageHandler$ = R.curry(function chatMessageHandler(connection, msg) {\n        console.log('User connection: chat msg', msg);\n        connection.chat = R.pipe(\n          R.defaultTo([]),\n          R.append(msg)\n        )(connection.chat);\n        pubSubService.publish('chat', connection.chat, connection.channel);\n      });\n      var userForStamp$ = R.curry(function userForStamp(stamp, connection) {\n        return R.pipe(\n          R.prop('users'),\n          R.find(R.propEq('stamp', stamp))\n        )(connection);\n      });\n      var usersForStamps$ = R.curry(function usersForStamps(stamps, connection) {\n        return R.pipe(\n          R.map(R.flip(userForStamp$)(connection)),\n          R.reject(R.isNil)\n        )(stamps);\n      });\n      return userConnectionService;\n    }\n  ]);\n"]}