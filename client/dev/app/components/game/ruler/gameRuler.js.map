{"version":3,"sources":["gameRuler.es6"],"names":[],"mappings":"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","file":"gameRuler.js","sourcesContent":["(function() {\n  angular.module('clickApp.directives')\n    .directive('clickGameRuler', gameRulerDirectiveFactory);\n\n  gameRulerDirectiveFactory.$inject = [\n    'gameMap',\n    'labelElement',\n    'gameRuler',\n    'gameModels',\n    'gameFactions',\n    'modes',\n  ];\n  function gameRulerDirectiveFactory(gameMapModel,\n                                     labelElementModel,\n                                     gameRulerModel,\n                                     gameModelsModel,\n                                     gameFactionsModel,\n                                     modesModel) {\n    return {\n      restrict: 'A',\n      link: link\n    };\n    function link(scope, parent) {\n      const map = document.getElementById('map');\n      const svgNS = map.namespaceURI;\n\n      const state = scope.state;\n      const local_element = createRulerElement(svgNS, parent[0]);\n      const remote_element = createRulerElement(svgNS, parent[0]);\n\n      scope.onStateChangeEvent('Game.ruler.local.change', updateLocalRuler, scope);\n      scope.onStateChangeEvent('Game.ruler.remote.change', updateRemoteRuler, scope);\n      scope.onStateChangeEvent('Game.map.flipped', updateOnMapFlipped, scope);\n\n      function updateLocalRuler() {\n        updateRuler(map, state.game.ruler.local, local_element);\n      }\n      function updateRemoteRuler() {\n        updateRuler(map, state.game.ruler.remote, remote_element);\n\n        const display = ( gameRulerModel.isDisplayed(state.game.ruler) ||\n                          'Ruler' === modesModel.currentModeName(state.modes)\n                        );\n        updateOrigin(state.factions, state.game.models,\n                     state.game.ruler, display,\n                     remote_element.origin);\n        updateTarget(state.factions, state.game.models,\n                     state.game.ruler, display,\n                     remote_element.target);\n      }\n      function updateOnMapFlipped() {\n        updateRulerOnMapFlipped(map, state.game.ruler.local, local_element);\n        updateRulerOnMapFlipped(map, state.game.ruler.remote, remote_element);\n      }\n    }\n    function createRulerElement(svgNS, parent) {\n      const group = document.createElementNS(svgNS, 'g');\n      parent.appendChild(group);\n\n      const line = document.createElementNS(svgNS, 'line');\n      line.style['marker-start'] = 'url(#ruler-start)';\n      line.style['marker-end'] = 'url(#ruler-end)';\n      group.appendChild(line);\n\n      const label = labelElementModel.create(svgNS, group);\n\n      const origin = document.createElementNS(svgNS, 'circle');\n      origin.classList.add('ruler-origin');\n      origin.setAttribute('cx', '0');\n      origin.setAttribute('cy', '0');\n      origin.setAttribute('r', '0');\n      origin.style.visibility = 'hidden';\n      parent.appendChild(origin);\n\n      const target = document.createElementNS(svgNS, 'circle');\n      target.classList.add('ruler-target');\n      target.setAttribute('cx', '0');\n      target.setAttribute('cy', '0');\n      target.setAttribute('r', '0');\n      target.style.visibility = 'hidden';\n      parent.appendChild(target);\n\n      return { container: group,\n               line: line,\n               label: label,\n               origin: origin,\n               target: target\n             };\n    }\n    function updateRuler(map, ruler, element) {\n      const map_flipped = gameMapModel.isFlipped(map);\n      const zoom_factor = gameMapModel.zoomFactor(map);\n      const label_flip_center = {\n        x: (ruler.end.x - ruler.start.x) / 2 + ruler.start.x,\n        y: (ruler.end.y - ruler.start.y) / 2 + ruler.start.y\n      };\n      const label_text = ruler.display ? ruler.length : '';\n      updateLine(ruler.display, ruler, element.line);\n      labelElementModel.update(map_flipped,\n                               zoom_factor,\n                               label_flip_center,\n                               label_flip_center,\n                               label_text,\n                               element.label);\n    }\n    function updateRulerOnMapFlipped(map, ruler, element) {\n      const label_flip_center = {\n        x: (ruler.end.x - ruler.start.x) / 2 + ruler.start.x,\n        y: (ruler.end.y - ruler.start.y) / 2 + ruler.start.y\n      };\n      labelElementModel.updateOnFlipMap(map, label_flip_center, element.label);\n    }\n    function updateLine(visible, ruler, line) {\n      line.style['visibility'] = visible ? 'visible' : 'hidden';\n      line.setAttribute('x1', ruler.start.x+'');\n      line.setAttribute('y1', ruler.start.y+'');\n      line.setAttribute('x2', ruler.end.x+'');\n      line.setAttribute('y2', ruler.end.y+'');\n    }\n    function updateOrigin(factions, models, ruler, display, element) {\n      const origin = gameRulerModel.origin(ruler);\n      element.style.visibility = 'hidden';\n      R.threadP(origin)(\n        findOriginModelP,\n        R.rejectIfP(checkOriginDisplay, 'no display'),\n        (origin_model) => R.threadP(factions)(\n          gameFactionsModel.getModelInfoP$(origin_model.state.info),\n          (info) => {\n            element.setAttribute('cx', origin_model.state.x+'');\n            element.setAttribute('cy', origin_model.state.y+'');\n            element.setAttribute('r', info.base_radius+'');\n            element.style.visibility = 'visible';\n          }\n        )\n      ).catch(R.always(null));\n\n      function findOriginModelP(origin) {\n        return R.threadP(origin)(\n          R.rejectIfP(R.isNil, 'no origin'),\n          (origin) => gameModelsModel\n            .findStampP(origin, models)\n        );\n      }\n      function checkOriginDisplay(origin_model) {\n        return ( !display ||\n                 R.isNil(origin_model)\n               );\n      }\n    }\n    function updateTarget(factions, models, ruler, display, element) {\n      const target = gameRulerModel.target(ruler);\n      element.style.visibility = 'hidden';\n      R.threadP(target)(\n        findTargetModelP,\n        R.rejectIfP(checkTargetDisplay, 'no display'),\n        (target_model) => R.threadP(factions)(\n          gameFactionsModel.getModelInfoP$(target_model.state.info),\n          (info) => {\n            element.setAttribute('cx', target_model.state.x+'');\n            element.setAttribute('cy', target_model.state.y+'');\n            element.setAttribute('r', info.base_radius+'');\n            element.style.visibility = 'visible';\n          }\n        ),\n        checkTargetReached\n      ).catch(R.always(null));\n\n      function findTargetModelP(target) {\n        return R.threadP(target)(\n          R.rejectIfP(R.isNil, 'no target'),\n          (target) => gameModelsModel\n            .findStampP(target, models)\n        );\n      }\n      function checkTargetDisplay(target_model) {\n        return ( !display ||\n                 R.isNil(target_model)\n               );\n      }\n      function checkTargetReached() {\n        if(gameRulerModel.targetReached(ruler)) {\n          element.classList.add('reached');\n        }\n        else {\n          element.classList.remove('reached');\n        }\n      }\n    }\n  }\n})();\n"]}