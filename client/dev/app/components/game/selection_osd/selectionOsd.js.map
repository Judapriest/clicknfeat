{"version":3,"sources":["selectionOsd.es6"],"names":[],"mappings":"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","file":"selectionOsd.js","sourcesContent":["(function() {\n  angular.module('clickApp.directives')\n    .controller('clickGameSelectionDetailCtrl', gameSelectionDetailCtrl)\n    .directive('clickGameSelectionDetail', gameSelectionDetailDirectiveFactory);\n\n  gameSelectionDetailCtrl.$inject = [\n    '$scope',\n    'appGame',\n    'gameModels',\n    'gameTemplates',\n  ];\n  function gameSelectionDetailCtrl($scope,\n                                   appGameService,\n                                   gameModelsModel,\n                                   gameTemplatesModel) {\n    const vm = this;\n    console.log('init clickGameSelectionDetailCtrl');\n\n    vm.edit = { label: '',\n                max_deviation: 0\n              };\n    vm.show = { info: false };\n    vm.onOpen = onOpen;\n    vm.labelDisplay = labelDisplay;\n\n    vm.doSetMaxDeviation = doSetMaxDeviation;\n    vm.doAddLabel = doAddLabel;\n    vm.doRemoveLabel = doRemoveLabel;\n\n    activate();\n\n    function activate() {\n      $scope.listenSignal(updateTemplateElement,\n                          appGameService.templates.changes,\n                          $scope);\n      $scope.listenSignal(updateModelElement,\n                          appGameService.models.changes,\n                          $scope);\n    }\n    function onOpen() {\n      vm.show.info = false;\n      if(R.isNil(vm.type)) return;\n\n      if('template' === vm.type) {\n        const templates = appGameService.templates\n                .templates.sample();\n        updateTemplateElement([templates, [vm.element.stamp]]);\n      }\n      if('model' === vm.type) {\n        const models = appGameService.models\n                .models.sample();\n        updateModelElement([models, [vm.element.stamp]]);\n      }\n    }\n    function updateTemplateElement([templates, stamps]) {\n      if(!R.find(R.equals(vm.element.stamp), stamps)) {\n        return;\n      }\n      R.thread(templates)(\n        gameTemplatesModel.findStamp$(vm.element.stamp),\n        R.when(\n          R.exists,\n          (template) => {\n            vm.element = template.state;\n            vm.edit.max_deviation = R.propOr(0, 'm', vm.element);\n          }\n        )\n      );\n    }\n    function updateModelElement([models, stamps]) {\n      if(!R.find(R.equals(vm.element.stamp), stamps)) {\n        return;\n      }\n      R.thread(models)(\n        gameModelsModel.findStamp$(vm.element.stamp),\n        (model) => {\n          vm.element = model.state;\n          vm.info = model.info;\n        }\n      );\n    }\n    function labelDisplay(l) {\n      return s.truncate(l, 12);\n    }\n    function doSetMaxDeviation() {\n      const max = ( vm.edit.max_deviation > 0\n                    ? vm.edit.max_deviation\n                    : null\n                  );\n      $scope.sendAction('Game.command.execute',\n                        'onTemplates',\n                        [ 'setMaxDeviation', [max],\n                          [vm.element.stamp]\n                        ]);\n    }\n    function doAddLabel() {\n      const cmd = ( vm.type === 'template'\n                    ? 'onTemplates'\n                    : 'onModels'\n                  );\n      const new_label = s.trim(vm.edit.label);\n      if(R.length(new_label) === 0) return;\n\n      $scope.sendAction('Game.command.execute',\n                        cmd,\n                        [ 'addLabel', [new_label],\n                          [vm.element.stamp]\n                        ]);\n      vm.edit.label = '';\n    }\n    function doRemoveLabel(label) {\n      const cmd = ( vm.type === 'template'\n                    ? 'onTemplates'\n                    : 'onModels'\n                  );\n      $scope.sendAction('Game.command.execute',\n                        cmd,\n                        [ 'removeLabel', [label],\n                          [vm.element.stamp]\n                        ]);\n    }\n  }\n\n  gameSelectionDetailDirectiveFactory.$inject = [\n    'appGame',\n    'gameMap',\n  ];\n  function gameSelectionDetailDirectiveFactory(appGameService,\n                                               gameMapService) {\n    const gameSelectionDetailDirective = {\n      restrict: 'A',\n      scope: true,\n      controller: 'clickGameSelectionDetailCtrl',\n      controllerAs: 'selection',\n      link: link\n    };\n    return gameSelectionDetailDirective;\n\n    function link(scope, element) {\n      console.log('gameSelectionDetail');\n      element = element[0];\n      const viewport = document.getElementById('viewport');\n      const map = document.getElementById('map');\n      const vm = scope.selection;\n\n      vm.type = 'model';\n      closeSelectionDetail();\n      scope.listenSignal((detail) => {\n        if(R.isNil(R.prop('type', detail))) {\n          closeSelectionDetail();\n        }\n        else {\n          openSelectionDetail(detail);\n        }\n      }, appGameService.view.detail, scope);\n      vm.doClose = closeSelectionDetail;\n\n      function openSelectionDetail({type, element }) {\n        console.info('openSelectionDetail');\n        vm.type = type;\n        vm.element = element.state;\n        vm.edit = { label: '',\n                    max_deviation: 0\n                  };\n        vm.onOpen();\n        self.window.requestAnimationFrame(displaySelectionDetail);\n      }\n      function closeSelectionDetail() {\n        // console.log('closeSelectionDetail');\n        vm.type = null;\n        vm.element = {};\n        element.style.display = 'none';\n        element.style.visibility = 'hidden';\n        element.style.left = 0+'px';\n        element.style.top = 0+'px';\n      }\n      function displaySelectionDetail() {\n        // console.log('displaySelectionDetail');\n        element.style.display = 'initial';\n        element.style.visibility = 'hidden';\n        self.window.requestAnimationFrame(showSelectionDetail);\n      }\n      function showSelectionDetail() {\n        // console.log('showSelectionDetail');\n        placeSelectionDetail();\n        element.style.visibility = 'visible';\n      }\n      function placeSelectionDetail() {\n        // console.log('placeSelectionDetail');\n        const detail_rect = element.getBoundingClientRect();\n        const screen_pos = gameMapService\n                .mapToScreenCoordinates(map, vm.element);\n        const viewport_rect = viewport.getBoundingClientRect();\n        if(detailCanFitRight(viewport_rect, detail_rect, screen_pos)) {\n          element.style.left = alignRight(detail_rect, screen_pos);\n        }\n        else {\n          element.style.left = alignLeft(detail_rect, screen_pos);\n        }\n        if(detailCanFitBottom(viewport_rect, detail_rect, screen_pos)) {\n          element.style.top = alignBottom(detail_rect, screen_pos);\n        }\n        else {\n          element.style.top = alignTop(detail_rect, screen_pos);\n        }\n      }\n      function detailCanFitRight(viewport_rect, detail_rect, screen_pos) {\n        return screen_pos.x + detail_rect.width <= viewport_rect.right;\n      }\n      function alignRight(_detail_rect_, screen_pos) {\n        return screen_pos.x+'px';\n      }\n      function alignLeft(detail_rect, screen_pos) {\n        return Math.max(0, screen_pos.x-detail_rect.width)+'px';\n      }\n      function detailCanFitBottom(viewport_rect, detail_rect, screen_pos) {\n        return screen_pos.y + detail_rect.height <= viewport_rect.bottom;\n      }\n      function alignBottom(_detail_rect_, screen_pos) {\n        return screen_pos.y+'px';\n      }\n      function alignTop(detail_rect, screen_pos) {\n        return Math.max(0, screen_pos.y-detail_rect.height)+'px';\n      }\n    }\n  }\n})();\n"]}