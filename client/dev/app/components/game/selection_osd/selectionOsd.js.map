{"version":3,"sources":["selectionOsd.es6"],"names":[],"mappings":";;AAAA,CAAC,YAAW;AACV,UAAQ,MAAR,CAAe,qBAAf,EACG,UADH,CACc,8BADd,EAC8C,uBAD9C,EAEG,SAFH,CAEa,0BAFb,EAEyC,mCAFzC,EADU;;AAKV,0BAAwB,OAAxB,GAAkC,CAChC,QADgC,EAEhC,cAFgC,EAGhC,YAHgC,EAIhC,eAJgC,CAAlC,CALU;AAWV,WAAS,uBAAT,CAAiC,MAAjC,EACiC,iBADjC,EAEiC,eAFjC,EAGiC,kBAHjC,EAGqD;AACnD,QAAM,KAAK,IAAL,CAD6C;AAEnD,QAAM,QAAQ,OAAO,KAAP,CAFqC;AAGnD,YAAQ,GAAR,CAAY,mCAAZ,EAHmD;;AAKnD,OAAG,IAAH,GAAU,EAAE,OAAO,EAAP;AACA,qBAAe,CAAf;KADZ,CALmD;AAQnD,OAAG,IAAH,GAAU,EAAE,MAAM,KAAN,EAAZ,CARmD;AASnD,OAAG,MAAH,GAAY,MAAZ,CATmD;AAUnD,OAAG,aAAH,GAAmB,aAAnB,CAVmD;AAWnD,OAAG,YAAH,GAAkB,YAAlB,CAXmD;;AAanD,OAAG,iBAAH,GAAuB,iBAAvB,CAbmD;AAcnD,OAAG,UAAH,GAAgB,UAAhB,CAdmD;AAenD,OAAG,aAAH,GAAmB,aAAnB,CAfmD;;AAiBnD,QAAM,mBAAmB;AACvB,gBAAU,qBAAV;AACA,aAAO,kBAAP;KAFI,CAjB6C;AAqBnD,aAAS,MAAT,GAAkB;AAChB,SAAG,IAAH,CAAQ,IAAR,GAAe,KAAf,CADgB;AAEhB,aAAO,eAAP,CAFgB;KAAlB;AAIA,aAAS,aAAT,GAAyB;AACvB,aAAO,EAAE,OAAF,GACL;eAAM,iBAAiB,GAAG,IAAH,CAAjB;OAAN,EACA,YAAM;AAAE,eAAO,OAAP,GAAF;OAAN,CAFF,CADuB;KAAzB;AAMA,aAAS,qBAAT,GAAiC;AAC/B,aAAO,EAAE,OAAF,CAAU,MAAM,IAAN,CAAV,CACL,EAAE,IAAF,CAAO,WAAP,CADK,EAEL,mBAAmB,WAAnB,CAA+B,GAAG,OAAH,CAAW,KAAX,CAF1B,EAGL,UAAC,QAAD,EAAc;AACZ,WAAG,OAAH,GAAa,SAAS,KAAT,CADD;AAEZ,WAAG,IAAH,CAAQ,aAAR,GAAwB,EAAE,MAAF,CAAS,CAAT,EAAY,GAAZ,EAAiB,GAAG,OAAH,CAAzC,CAFY;OAAd,CAHF,CAD+B;KAAjC;AAUA,aAAS,kBAAT,GAA8B;AAC5B,aAAO,EAAE,OAAF,CAAU,MAAM,IAAN,CAAV,CACL,EAAE,IAAF,CAAO,QAAP,CADK,EAEL,gBAAgB,WAAhB,CAA4B,GAAG,OAAH,CAAW,KAAX,CAFvB,EAGL,UAAC,KAAD,EAAW;AACT,WAAG,OAAH,GAAa,MAAM,KAAN,CADJ;OAAX,EAGA;eAAM,kBAAkB,aAAlB,CAAgC,GAAG,OAAH,CAAW,IAAX,EAAiB,MAAM,QAAN;OAAvD,EACA,UAAC,IAAD,EAAU;AACR,WAAG,IAAH,GAAU,IAAV,CADQ;OAAV,CAPF,CAD4B;KAA9B;AAaA,aAAS,YAAT,CAAsB,CAAtB,EAAyB;AACvB,aAAO,EAAE,QAAF,CAAW,CAAX,EAAc,EAAd,CAAP,CADuB;KAAzB;AAGA,aAAS,iBAAT,GAA6B;AAC3B,UAAM,MAAQ,GAAG,IAAH,CAAQ,aAAR,GAAwB,CAAxB,GACE,GAAG,IAAH,CAAQ,aAAR,GACA,IAFF,CADa;AAK3B,aACG,UADH,CACc,sBADd,EAEc,aAFd,EAGc,CAAE,iBAAF,EAAqB,CAAC,GAAD,CAArB,EACE,CAAC,GAAG,OAAH,CAAW,KAAX,CADH,CAHd,EAMG,IANH,CAMQ,aANR,EAL2B;KAA7B;AAaA,aAAS,UAAT,GAAsB;AACpB,UAAM,MAAQ,GAAG,IAAH,KAAY,UAAZ,GACE,aADF,GAEE,UAFF,CADM;AAKpB,UAAM,YAAY,EAAE,IAAF,CAAO,GAAG,IAAH,CAAQ,KAAR,CAAnB,CALc;AAMpB,UAAG,EAAE,MAAF,CAAS,SAAT,MAAwB,CAAxB,EAA2B,OAA9B;;AAEA,aACG,UADH,CACc,sBADd,EAEc,GAFd,EAGc,CAAE,UAAF,EAAc,CAAC,SAAD,CAAd,EACE,CAAC,GAAG,OAAH,CAAW,KAAX,CADH,CAHd,EAMG,IANH,CAMQ,aANR,EARoB;AAepB,SAAG,IAAH,CAAQ,KAAR,GAAgB,EAAhB,CAfoB;KAAtB;AAiBA,aAAS,aAAT,CAAuB,KAAvB,EAA8B;AAC5B,UAAM,MAAQ,GAAG,IAAH,KAAY,UAAZ,GACE,aADF,GAEE,UAFF,CADc;AAK5B,aACG,UADH,CACc,sBADd,EAEc,GAFd,EAGc,CAAE,aAAF,EAAiB,CAAC,KAAD,CAAjB,EACE,CAAC,GAAG,OAAH,CAAW,KAAX,CADH,CAHd,EAMG,IANH,CAMQ,aANR,EAL4B;KAA9B;GA1FF;;AAyGA,sCAAoC,OAApC,GAA8C,CAC5C,MAD4C,EAE5C,SAF4C,CAA9C,CApHU;AAwHV,WAAS,mCAAT,CAA6C,WAA7C,EAC6C,cAD7C,EAC6D;AAC3D,QAAM,+BAA+B;AACnC,gBAAU,GAAV;AACA,aAAO,IAAP;AACA,kBAAY,8BAAZ;AACA,oBAAc,WAAd;AACA,YAAM,IAAN;KALI,CADqD;AAQ3D,WAAO,4BAAP,CAR2D;;AAU3D,aAAS,IAAT,CAAc,KAAd,EAAqB,OAArB,EAA8B;AAC5B,cAAQ,GAAR,CAAY,qBAAZ,EAD4B;AAE5B,gBAAU,QAAQ,CAAR,CAAV,CAF4B;AAG5B,UAAM,WAAW,SAAS,cAAT,CAAwB,UAAxB,CAAX,CAHsB;AAI5B,UAAM,MAAM,SAAS,cAAT,CAAwB,KAAxB,CAAN,CAJsB;AAK5B,UAAM,KAAK,MAAM,SAAN,CALiB;;AAO5B,SAAG,IAAH,GAAU,OAAV,CAP4B;AAQ5B,6BAR4B;AAS5B,YAAM,kBAAN,CAAyB,2BAAzB,EACyB,mBADzB,EAC8C,KAD9C,EAT4B;AAW5B,YAAM,kBAAN,CAAyB,4BAAzB,EACyB,oBADzB,EAC+C,KAD/C,EAX4B;AAa5B,SAAG,OAAH,GAAa,oBAAb,CAb4B;;AAe5B,eAAS,mBAAT,CAA6B,MAA7B,EAAqC,IAArC,EAA2C,OAA3C,EAAoD;;AAElD,WAAG,IAAH,GAAU,IAAV,CAFkD;AAGlD,WAAG,OAAH,GAAa,QAAQ,KAAR,CAHqC;AAIlD,WAAG,IAAH,GAAU,EAAE,OAAO,EAAP;AACA,yBAAe,CAAf;SADZ,CAJkD;AAOlD,WAAG,MAAH,GAAY,IAAZ,CAAiB,YAAM;AACrB,eAAK,MAAL,CAAY,qBAAZ,CAAkC,sBAAlC,EADqB;SAAN,CAAjB,CAPkD;OAApD;AAWA,eAAS,oBAAT,GAAgC;;AAE9B,WAAG,OAAH,GAAa,EAAb,CAF8B;AAG9B,gBAAQ,KAAR,CAAc,OAAd,GAAwB,MAAxB,CAH8B;AAI9B,gBAAQ,KAAR,CAAc,UAAd,GAA2B,QAA3B,CAJ8B;AAK9B,gBAAQ,KAAR,CAAc,IAAd,GAAqB,IAAE,IAAF,CALS;AAM9B,gBAAQ,KAAR,CAAc,GAAd,GAAoB,IAAE,IAAF,CANU;OAAhC;AAQA,eAAS,sBAAT,GAAkC;;AAEhC,gBAAQ,KAAR,CAAc,OAAd,GAAwB,SAAxB,CAFgC;AAGhC,gBAAQ,KAAR,CAAc,UAAd,GAA2B,QAA3B,CAHgC;AAIhC,aAAK,MAAL,CAAY,qBAAZ,CAAkC,mBAAlC,EAJgC;OAAlC;AAMA,eAAS,mBAAT,GAA+B;;AAE7B,+BAF6B;AAG7B,gBAAQ,KAAR,CAAc,UAAd,GAA2B,SAA3B,CAH6B;OAA/B;AAKA,eAAS,oBAAT,GAAgC;;AAE9B,YAAM,cAAc,QAAQ,qBAAR,EAAd,CAFwB;AAG9B,YAAM,aAAa,eACV,sBADU,CACa,GADb,EACkB,GAAG,OAAH,CAD/B,CAHwB;AAK9B,YAAM,gBAAgB,SAAS,qBAAT,EAAhB,CALwB;AAM9B,YAAG,kBAAkB,aAAlB,EAAiC,WAAjC,EAA8C,UAA9C,CAAH,EAA8D;AAC5D,kBAAQ,KAAR,CAAc,IAAd,GAAqB,WAAW,WAAX,EAAwB,UAAxB,CAArB,CAD4D;SAA9D,MAGK;AACH,kBAAQ,KAAR,CAAc,IAAd,GAAqB,UAAU,WAAV,EAAuB,UAAvB,CAArB,CADG;SAHL;AAMA,YAAG,mBAAmB,aAAnB,EAAkC,WAAlC,EAA+C,UAA/C,CAAH,EAA+D;AAC7D,kBAAQ,KAAR,CAAc,GAAd,GAAoB,YAAY,WAAZ,EAAyB,UAAzB,CAApB,CAD6D;SAA/D,MAGK;AACH,kBAAQ,KAAR,CAAc,GAAd,GAAoB,SAAS,WAAT,EAAsB,UAAtB,CAApB,CADG;SAHL;OAZF;AAmBA,eAAS,iBAAT,CAA2B,aAA3B,EAA0C,WAA1C,EAAuD,UAAvD,EAAmE;AACjE,eAAO,WAAW,CAAX,GAAe,YAAY,KAAZ,IAAqB,cAAc,KAAd,CADsB;OAAnE;AAGA,eAAS,UAAT,CAAoB,WAApB,EAAiC,UAAjC,EAA6C;AAC3C,eAAO,WAAW,CAAX,GAAa,IAAb,CADoC;OAA7C;AAGA,eAAS,SAAT,CAAmB,WAAnB,EAAgC,UAAhC,EAA4C;AAC1C,eAAO,KAAK,GAAL,CAAS,CAAT,EAAY,WAAW,CAAX,GAAa,YAAY,KAAZ,CAAzB,GAA4C,IAA5C,CADmC;OAA5C;AAGA,eAAS,kBAAT,CAA4B,aAA5B,EAA2C,WAA3C,EAAwD,UAAxD,EAAoE;AAClE,eAAO,WAAW,CAAX,GAAe,YAAY,MAAZ,IAAsB,cAAc,MAAd,CADsB;OAApE;AAGA,eAAS,WAAT,CAAqB,WAArB,EAAkC,UAAlC,EAA8C;AAC5C,eAAO,WAAW,CAAX,GAAa,IAAb,CADqC;OAA9C;AAGA,eAAS,QAAT,CAAkB,WAAlB,EAA+B,UAA/B,EAA2C;AACzC,eAAO,KAAK,GAAL,CAAS,CAAT,EAAY,WAAW,CAAX,GAAa,YAAY,MAAZ,CAAzB,GAA6C,IAA7C,CADkC;OAA3C;KA/EF;GAXF;CAxHD,CAAD","file":"selectionOsd.js","sourcesContent":["(function() {\n  angular.module('clickApp.directives')\n    .controller('clickGameSelectionDetailCtrl', gameSelectionDetailCtrl)\n    .directive('clickGameSelectionDetail', gameSelectionDetailDirectiveFactory);\n\n  gameSelectionDetailCtrl.$inject = [\n    '$scope',\n    'gameFactions',\n    'gameModels',\n    'gameTemplates',\n  ];\n  function gameSelectionDetailCtrl($scope,\n                                   gameFactionsModel,\n                                   gameModelsModel,\n                                   gameTemplatesModel) {\n    const vm = this;\n    const state = $scope.state;\n    console.log('init clickGameSelectionDetailCtrl');\n\n    vm.edit = { label: '',\n                max_deviation: 0\n              };\n    vm.show = { info: false };\n    vm.onOpen = onOpen;\n    vm.updateElement = updateElement;\n    vm.labelDisplay = labelDisplay;\n\n    vm.doSetMaxDeviation = doSetMaxDeviation;\n    vm.doAddLabel = doAddLabel;\n    vm.doRemoveLabel = doRemoveLabel;\n\n    const updateOnOpenType = {\n      template: updateTemplateElement,\n      model: updateModelElement\n    };\n    function onOpen() {\n      vm.show.info = false;\n      return updateElement();\n    }\n    function updateElement() {\n      return R.threadP()(\n        () => updateOnOpenType[vm.type](),\n        () => { $scope.$digest(); }\n      );\n    }\n    function updateTemplateElement() {\n      return R.threadP(state.game)(\n        R.prop('templates'),\n        gameTemplatesModel.findStampP$(vm.element.stamp),\n        (template) => {\n          vm.element = template.state;\n          vm.edit.max_deviation = R.propOr(0, 'm', vm.element);\n        }\n      );\n    }\n    function updateModelElement() {\n      return R.threadP(state.game)(\n        R.prop('models'),\n        gameModelsModel.findStampP$(vm.element.stamp),\n        (model) => {\n          vm.element = model.state;\n        },\n        () => gameFactionsModel.getModelInfoP(vm.element.info, state.factions),\n        (info) => {\n          vm.info = info;\n        }\n      );\n    }\n    function labelDisplay(l) {\n      return s.truncate(l, 12);\n    }\n    function doSetMaxDeviation() {\n      const max = ( vm.edit.max_deviation > 0\n                    ? vm.edit.max_deviation\n                    : null\n                  );\n      $scope\n        .stateEvent('Game.command.execute',\n                    'onTemplates',\n                    [ 'setMaxDeviation', [max],\n                      [vm.element.stamp]\n                    ])\n        .then(updateElement);\n    }\n    function doAddLabel() {\n      const cmd = ( vm.type === 'template'\n                    ? 'onTemplates'\n                    : 'onModels'\n                  );\n      const new_label = s.trim(vm.edit.label);\n      if(R.length(new_label) === 0) return;\n\n      $scope\n        .stateEvent('Game.command.execute',\n                    cmd,\n                    [ 'addLabel', [new_label],\n                      [vm.element.stamp]\n                    ])\n        .then(updateElement);\n      vm.edit.label = '';\n    }\n    function doRemoveLabel(label) {\n      const cmd = ( vm.type === 'template'\n                    ? 'onTemplates'\n                    : 'onModels'\n                  );\n      $scope\n        .stateEvent('Game.command.execute',\n                    cmd,\n                    [ 'removeLabel', [label],\n                      [vm.element.stamp]\n                    ])\n        .then(updateElement);\n    }\n  }\n\n  gameSelectionDetailDirectiveFactory.$inject = [\n    'game',\n    'gameMap',\n  ];\n  function gameSelectionDetailDirectiveFactory(gameService,\n                                               gameMapService) {\n    const gameSelectionDetailDirective = {\n      restrict: 'A',\n      scope: true,\n      controller: 'clickGameSelectionDetailCtrl',\n      controllerAs: 'selection',\n      link: link\n    };\n    return gameSelectionDetailDirective;\n\n    function link(scope, element) {\n      console.log('gameSelectionDetail');\n      element = element[0];\n      const viewport = document.getElementById('viewport');\n      const map = document.getElementById('map');\n      const vm = scope.selection;\n\n      vm.type = 'model';\n      closeSelectionDetail();\n      scope.onStateChangeEvent('Game.selectionDetail.open',\n                               openSelectionDetail, scope);\n      scope.onStateChangeEvent('Game.selectionDetail.close',\n                               closeSelectionDetail, scope);\n      vm.doClose = closeSelectionDetail;\n\n      function openSelectionDetail($event, type, element) {\n        // console.log('openSelectionDetail');\n        vm.type = type;\n        vm.element = element.state;\n        vm.edit = { label: '',\n                    max_deviation: 0\n                  };\n        vm.onOpen().then(() => {\n          self.window.requestAnimationFrame(displaySelectionDetail);\n        });\n      }\n      function closeSelectionDetail() {\n        // console.log('closeSelectionDetail');\n        vm.element = {};\n        element.style.display = 'none';\n        element.style.visibility = 'hidden';\n        element.style.left = 0+'px';\n        element.style.top = 0+'px';\n      }\n      function displaySelectionDetail() {\n        // console.log('displaySelectionDetail');\n        element.style.display = 'initial';\n        element.style.visibility = 'hidden';\n        self.window.requestAnimationFrame(showSelectionDetail);\n      }\n      function showSelectionDetail() {\n        // console.log('showSelectionDetail');\n        placeSelectionDetail();\n        element.style.visibility = 'visible';\n      }\n      function placeSelectionDetail() {\n        // console.log('placeSelectionDetail');\n        const detail_rect = element.getBoundingClientRect();\n        const screen_pos = gameMapService\n                .mapToScreenCoordinates(map, vm.element);\n        const viewport_rect = viewport.getBoundingClientRect();\n        if(detailCanFitRight(viewport_rect, detail_rect, screen_pos)) {\n          element.style.left = alignRight(detail_rect, screen_pos);\n        }\n        else {\n          element.style.left = alignLeft(detail_rect, screen_pos);\n        }\n        if(detailCanFitBottom(viewport_rect, detail_rect, screen_pos)) {\n          element.style.top = alignBottom(detail_rect, screen_pos);\n        }\n        else {\n          element.style.top = alignTop(detail_rect, screen_pos);\n        }\n      }\n      function detailCanFitRight(viewport_rect, detail_rect, screen_pos) {\n        return screen_pos.x + detail_rect.width <= viewport_rect.right;\n      }\n      function alignRight(detail_rect, screen_pos) {\n        return screen_pos.x+'px';\n      }\n      function alignLeft(detail_rect, screen_pos) {\n        return Math.max(0, screen_pos.x-detail_rect.width)+'px';\n      }\n      function detailCanFitBottom(viewport_rect, detail_rect, screen_pos) {\n        return screen_pos.y + detail_rect.height <= viewport_rect.bottom;\n      }\n      function alignBottom(detail_rect, screen_pos) {\n        return screen_pos.y+'px';\n      }\n      function alignTop(detail_rect, screen_pos) {\n        return Math.max(0, screen_pos.y-detail_rect.height)+'px';\n      }\n    }\n  }\n})();\n"]}