{"version":3,"sources":["terrain.es6"],"names":[],"mappings":"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","file":"terrain.js","sourcesContent":["angular.module('clickApp.directives')\n  .directive('clickGameTerrain', [\n    'gameMap',\n    'gameTerrains',\n    'gameTerrainInfo',\n    'gameTerrainSelection',\n    function(gameMapService,\n             gameTerrainsService,\n             gameTerrainInfoService,\n             gameTerrainSelectionService) {\n      var clickGameTerrainDirective = {\n        restrict: 'A',\n        link: (scope, parent) => {\n          let state = scope.state;\n          R.pipeP(\n            () => {\n              return gameTerrainInfoService\n                .getInfo(scope.terrain.state.info, state.terrains)\n                .catch((reason) => {\n                  console.error('clickGameTerrain', reason);\n                  return self.Promise.reject(reason);\n                });\n            },\n            (info) => {\n              console.log('gameTerrain', scope.terrain, info);\n\n              return buildTerrainElement(state, info, scope.terrain,\n                                         parent[0], scope);\n            }\n          )();\n        }\n      };\n      function buildTerrainElement(state, info, terrain, parent, scope) {\n        var element = createTerrainElement(info, terrain, parent);\n\n        var updateTerrain = gameTerrainOnUpdate(state, info,\n                                                scope, element);\n        scope.onStateChangeEvent(`Game.terrain.change.${terrain.state.stamp}`,\n                                 updateTerrain, scope);\n        updateTerrain();\n      }\n      function createTerrainElement(info, terrain, parent) {\n        var map = document.getElementById('map');\n        var svgNS = map.namespaceURI;\n\n        var image = document.createElementNS(svgNS, 'image');\n        image.classList.add('terrain-image');\n        image.setAttribute('data-stamp', terrain.state.stamp);\n        image.setAttribute('x', '0');\n        image.setAttribute('y', '0');\n        image.setAttribute('width', info.img.width+'');\n        image.setAttribute('height', info.img.height+'');\n        image.setAttributeNS('http://www.w3.org/1999/xlink', 'href', info.img.link);\n        parent.appendChild(image);\n\n        var direction = document.createElementNS(svgNS, 'line');\n        direction.classList.add('terrain-los');\n        direction.setAttribute('x1', (info.img.width/2)+'');\n        direction.setAttribute('y1', (info.img.height/2)+'');\n        direction.setAttribute('x2', (info.img.width/2)+'');\n        direction.setAttribute('y2', '0');\n        parent.appendChild(direction);\n\n        var edge = document.createElementNS(svgNS, 'rect');\n        edge.classList.add('terrain-edge');\n        edge.setAttribute('x', '0');\n        edge.setAttribute('y', '0');\n        edge.setAttribute('width', (info.img.width)+'');\n        edge.setAttribute('height', (info.img.height)+'');\n        parent.appendChild(edge);\n\n        return { container: parent,\n                 image: image,\n                 direction: direction,\n                 edge: edge\n               };\n      }\n      function gameTerrainOnUpdate(state, info, scope, element) {\n        return () => {\n          R.pipeP(\n            () => {\n              return gameTerrainsService\n                .findStamp(scope.terrain.state.stamp,\n                           scope.state.game.terrains);\n            },\n            (terrain) => {\n              updateTerrainPosition(info.img, terrain, element);\n              updateTerrainSelection(state.game.terrain_selection,\n                                     terrain, element);\n            }\n          )();\n        };\n      }\n      function updateTerrainPosition(img, terrain, element) {\n        element.container.setAttribute('transform', [\n          'translate(',\n          terrain.state.x-img.width/2,\n          ',',\n          terrain.state.y-img.height/2,\n          ') rotate(',\n          terrain.state.r,\n          ',',\n          img.width/2,\n          ',',\n          img.height/2,\n          ')'\n        ].join(''));\n      }\n      function updateTerrainSelection(selection, terrain, element) {\n        var container = element.container;\n        var stamp = terrain.state.stamp;\n        if(gameTerrainSelectionService.in('local', stamp, selection)) {\n          container.classList.add('local-selection');\n        }\n        else {\n          container.classList.remove('local-selection');\n        }\n        if(gameTerrainSelectionService.in('remote', stamp, selection)) {\n          container.classList.add('remote-selection');\n        }\n        else {\n          container.classList.remove('remote-selection');\n        }\n      }\n      return clickGameTerrainDirective;\n    }\n  ])\n  .directive('clickGameTerrainsList', [\n    function() {\n      return {\n        restrict: 'A',\n        templateUrl: 'partials/game/terrains_list.html',\n        scope: true,\n        link: function(scope, element) {\n          scope.type = element[0].getAttribute('click-game-terrains-list');\n          scope.digestOnStateChangeEvent('Game.terrain.create', scope);\n          console.log('clickGameTerrainsList', scope.type);\n        }\n      };\n    }\n  ]);\n"]}