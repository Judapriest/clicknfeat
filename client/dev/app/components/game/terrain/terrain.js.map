{"version":3,"sources":["terrain.es6"],"names":[],"mappings":"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","file":"terrain.js","sourcesContent":["(function() {\n  angular.module('clickApp.directives')\n    .directive('clickGameTerrain', clickGameTerrainDirectiveFactory)\n    .directive('clickGameTerrainsList', clickGameTerrainsListDirectiveFactory);\n\n  clickGameTerrainDirectiveFactory.$inject = [\n    'gameMap',\n    'gameTerrains',\n    'gameTerrainInfo',\n    'gameTerrainSelection',\n  ];\n  function clickGameTerrainDirectiveFactory(gameMapModel,\n                                            gameTerrainsModel,\n                                            gameTerrainInfoModel,\n                                            gameTerrainSelectionModel) {\n    return {\n      restrict: 'A',\n      link: link\n    };\n\n    function link(scope, parent) {\n      const state = scope.state;\n      R.threadP()(\n        () => {\n          return gameTerrainInfoModel\n            .getInfoP(scope.terrain.state.info, state.terrains)\n            .catch((reason) => {\n              console.error('clickGameTerrain', reason);\n              return self.Promise.reject(reason);\n            });\n        },\n        (info) => {\n          console.log('gameTerrain', scope.terrain, info);\n\n          return buildTerrainElement(state, info, scope.terrain,\n                                     parent[0], scope);\n        }\n      );\n    }\n    function buildTerrainElement(state, info, terrain, parent, scope) {\n      const element = createTerrainElement(info, terrain, parent);\n\n      const updateTerrain = gameTerrainOnUpdate(state, info,\n                                                scope, element);\n      scope.onStateChangeEvent(`Game.terrain.change.${terrain.state.stamp}`,\n                               updateTerrain, scope);\n      updateTerrain();\n    }\n    function createTerrainElement(info, terrain, parent) {\n      const map = document.getElementById('map');\n      const svgNS = map.namespaceURI;\n\n      const image = document.createElementNS(svgNS, 'image');\n      image.classList.add('terrain-image');\n      image.setAttribute('data-stamp', terrain.state.stamp);\n      image.setAttribute('x', '0');\n      image.setAttribute('y', '0');\n      image.setAttribute('width', info.img.width+'');\n      image.setAttribute('height', info.img.height+'');\n      image.setAttributeNS('http://www.w3.org/1999/xlink', 'href', info.img.link);\n      parent.appendChild(image);\n\n      const direction = document.createElementNS(svgNS, 'line');\n      direction.classList.add('terrain-los');\n      direction.setAttribute('x1', (info.img.width/2)+'');\n      direction.setAttribute('y1', (info.img.height/2)+'');\n      direction.setAttribute('x2', (info.img.width/2)+'');\n      direction.setAttribute('y2', '0');\n      parent.appendChild(direction);\n\n      const edge = document.createElementNS(svgNS, 'rect');\n      edge.classList.add('terrain-edge');\n      edge.setAttribute('x', '0');\n      edge.setAttribute('y', '0');\n      edge.setAttribute('width', (info.img.width)+'');\n      edge.setAttribute('height', (info.img.height)+'');\n      parent.appendChild(edge);\n\n      return { container: parent,\n               image: image,\n               direction: direction,\n               edge: edge\n             };\n    }\n    function gameTerrainOnUpdate(state, info, scope, element) {\n      return () => {\n        R.threadP(scope.state.game.terrains)(\n          gameTerrainsModel.findStampP$(scope.terrain.state.stamp),\n          (terrain) => {\n            updateTerrainPosition(info.img, terrain, element);\n            updateTerrainSelection(state.game.terrain_selection,\n                                   terrain, element);\n          }\n        ).catch(R.spyAndDiscardError());\n      };\n    }\n    function updateTerrainPosition(img, terrain, element) {\n      element.container.setAttribute('transform', [\n        'translate(',\n        terrain.state.x-img.width/2,\n        ',',\n        terrain.state.y-img.height/2,\n        ') rotate(',\n        terrain.state.r,\n        ',',\n        img.width/2,\n        ',',\n        img.height/2,\n        ')'\n      ].join(''));\n    }\n    function updateTerrainSelection(selection, terrain, element) {\n      const container = element.container;\n      const stamp = terrain.state.stamp;\n      if(gameTerrainSelectionModel.in('local', stamp, selection)) {\n        container.classList.add('local-selection');\n      }\n      else {\n        container.classList.remove('local-selection');\n      }\n      if(gameTerrainSelectionModel.in('remote', stamp, selection)) {\n        container.classList.add('remote-selection');\n      }\n      else {\n        container.classList.remove('remote-selection');\n      }\n    }\n  }\n\n  clickGameTerrainsListDirectiveFactory.$inject = [];\n  function clickGameTerrainsListDirectiveFactory() {\n    return {\n      restrict: 'A',\n      templateUrl: 'app/components/game/terrain/terrains_list.html',\n      scope: true,\n      link: link\n    };\n\n    function link(scope, element) {\n      scope.type = element[0].getAttribute('click-game-terrains-list');\n      scope.digestOnStateChangeEvent('Game.terrain.create', scope);\n      console.log('clickGameTerrainsList', scope.type);\n    }\n  }\n})();\n"]}