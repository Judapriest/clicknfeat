{"version":3,"sources":["map.es6"],"names":[],"mappings":"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","file":"map.js","sourcesContent":["angular.module('clickApp.directives')\n  .directive('clickGameMap', [\n    '$window',\n    'gameMap',\n    'terrain',\n    'defaultMode',\n    function($window,\n             gameMapService,\n             terrainService,\n             defaultModeService) {\n      function _eventModifiers(e) {\n        let modifiers = [];\n\n        if (e.shiftKey) {\n          modifiers.push('shift');\n        }\n\n        if (e.altKey) {\n          modifiers.push('alt');\n        }\n\n        if (e.ctrlKey) {\n          modifiers.push('ctrl');\n        }\n\n        if (e.metaKey) {\n          modifiers.push('meta');\n        }\n\n        return modifiers.sort();\n      }\n      return {\n        restrict: 'A',\n        link: function(scope, element) {\n          let log = true ? R.bind(console.log, console) : function() {}; // eslint-disable-line\n\n          let viewport = document.querySelector('#viewport');\n          let map = element[0];\n          let state = scope.state;\n\n          let mouseEvents = (function() {\n            let drag = {\n              active: false,\n              start: null,\n              target: null,\n              now: null\n            };\n            function blurInputs() {\n              let inputs = [\n                ...document.querySelectorAll('input'),\n                ...document.querySelectorAll('select'),\n                ...document.querySelectorAll('textarea'),\n              ];\n              R.forEach((e) => { e.blur(); }, inputs);\n            }\n            function mouseDownMap(event) {\n              log('mouseDownMap', event, map.getBoundingClientRect());\n              blurInputs();\n              event.preventDefault();\n              if(event.which !== 1) return;\n\n              map.addEventListener('mousemove', dragMap);\n              let start = gameMapService.eventToMapCoordinates(map, event);\n              gameMapService.findEventTarget(state.game, event)\n                .then((target) => {\n                  drag = {\n                    active: false,\n                    start: start,\n                    target: target,\n                    now: null\n                  };\n                });\n            }\n            function dragMap(event) {\n              log('dragMap', event);\n              event.preventDefault();\n              if(event.which !== 1) return;\n\n              drag.now = gameMapService.eventToMapCoordinates(map, event);\n              if(!drag.active &&\n                 Math.abs(drag.now.x - drag.start.x) < defaultModeService.moves().DragEpsilon &&\n                 Math.abs(drag.now.y - drag.start.y) < defaultModeService.moves().DragEpsilon) {\n                return;\n              }\n              let emit = drag.active ? 'drag' : 'dragStart';\n              drag.active = true;\n\n              if('Terrain' === drag.target.type &&\n                 terrainService.isLocked(drag.target.target)) {\n                drag.target = { type: 'Map',\n                                target: null\n                              };\n              }\n              scope.stateEvent('Modes.current.action',\n                               emit+drag.target.type,\n                               [ { target: drag.target.target,\n                                   start: drag.start,\n                                   now: drag.now\n                                 },\n                                 event\n                               ]);\n            }\n            function mouseLeaveMap(event) {\n              log('mouseLeaveMap', event);\n              event.preventDefault();\n\n              map.removeEventListener('mousemove', dragMap);\n              if(drag.active) {\n                drag.active = false;\n                scope.stateEvent('Modes.current.action',\n                                 'dragEnd'+drag.target.type,\n                                 [ { target: drag.target.target,\n                                     start: drag.start,\n                                     now: drag.now\n                                   },\n                                   event\n                                 ]);\n              }\n            }\n            function clickMap(event) {\n              log('clickMap', event);\n              event.preventDefault();\n              if(event.which !== 1) return;\n\n              map.removeEventListener('mousemove', dragMap);\n\n              let now = gameMapService.eventToMapCoordinates(map, event);\n              if(drag.active) {\n                drag.active = false;\n                scope.stateEvent('Modes.current.action',\n                                 'dragEnd'+drag.target.type,\n                                 [ { target: drag.target.target,\n                                     start: drag.start,\n                                     now: now\n                                   },\n                                   event\n                                 ]);\n              }\n              else {\n                gameMapService.findEventTarget(state.game, event)\n                  .then((target) => {\n                    let event_name = R.pipe(\n                      R.append('click'+target.type),\n                      R.join('+')\n                    )(_eventModifiers(event));\n                    event['click#'] = {\n                      target: target.target,\n                      x: now.x,\n                      y: now.y\n                    };\n                    state.changeEvent('Game.selectionDetail.close');\n                    state.changeEvent('Game.editLabel.close');\n                    state.changeEvent('Game.editDamage.close');\n                    Mousetrap.trigger(event_name, undefined, event);\n                  });\n              }\n            }\n            function rightClickMap(event) {\n              log('rightClickMap', event);\n              event.preventDefault();\n\n              let now = gameMapService.eventToMapCoordinates(map, event);\n              gameMapService.findEventTarget(state.game, event)\n                .then((target) => {\n                  let event_name = R.pipe(\n                    R.append('rightClick'+target.type),\n                    R.join('+')\n                  )(_eventModifiers(event));\n                  event['click#'] = {\n                    target: target.target,\n                    x: now.x,\n                    y: now.y\n                  };\n                  state.changeEvent('Game.selectionDetail.close');\n                  state.changeEvent('Game.editLabel.close');\n                  state.changeEvent('Game.editDamage.close');\n                  Mousetrap.trigger(event_name, undefined, event);\n                });\n            }\n            function moveMap(event) {\n              log('moveMap', event);\n              event.preventDefault();\n\n              let now = gameMapService.eventToMapCoordinates(map, event);\n              scope.stateEvent('Modes.current.action',\n                               'moveMap', [now, event]);\n            }\n            return {\n              down: mouseDownMap,\n              drag: dragMap,\n              leave: mouseLeaveMap,\n              click: clickMap,\n              rightClick: rightClickMap,\n              move: moveMap\n            };\n          })();\n\n          let moveEvents = (function() {\n            let move_enabled = false;\n            function onEnableMove() {\n              if(move_enabled) return;\n              map.addEventListener('mousemove', mouseEvents.move);\n              move_enabled = true;\n            }\n            function onDisableMove() {\n              if(!move_enabled) return;\n              map.removeEventListener('mousemove', mouseEvents.move);\n              move_enabled = false;\n            }\n            return {\n              enable: onEnableMove,\n              disable: onDisableMove\n            };\n          })();\n\n          let flipMap = (function() {\n            let deploiement_labels;\n            state.ui_state = R.assoc('flip_map', false, R.propOr({}, 'ui_state', state));\n            map.classList.remove('flipped');\n            return function onFlipMap() {\n              deploiement_labels = document.querySelector('#deploiement-labels');\n              state.ui_state.flip_map = !map.classList.contains('flipped');\n              map.classList.toggle('flipped');\n              if(state.ui_state.flip_map) {\n                deploiement_labels\n                  .setAttribute('transform','rotate(180,240,240)');\n              }\n              else {\n                deploiement_labels\n                  .setAttribute('transform','');\n              }\n              state.changeEvent('Game.map.flipped');\n            };\n          })();\n\n          let zoomEvents = (function() {\n            function zoomReset() {\n              let rect = viewport.getBoundingClientRect();\n              let hw = Math.min(rect.width, rect.height);\n              setMapDimensions(hw-15);\n            }\n            function zoomIn() {\n              let [[cx,cy],[vw,vh]] = findViewportCenter();\n\n              let rect = map.getBoundingClientRect();\n              cx = (vw > rect.width) ? rect.width / 2 : cx;\n              cy = (vh > rect.height) ? rect.height / 2 : cy;\n\n              setMapDimensions(rect.width*2);\n              setViewportCenter(cx*2, cy*2, vw, vh);\n            }\n            function zoomOut() {\n              let [[cx,cy],[vw,vh]] = findViewportCenter();\n              let hw = Math.min(vw, vh);\n\n              let rect = map.getBoundingClientRect();\n\n              setMapDimensions(Math.max(hw-15, rect.width/2));\n              setViewportCenter(cx/2, cy/2, vw, vh);\n            }\n            return {\n              in: zoomIn,\n              out: zoomOut,\n              reset: zoomReset\n            };\n          })();\n\n          let scrollEvents = (function() {\n            let scroll_indent = 30;\n            function scrollLeft() {\n              let left = viewport.scrollLeft;\n              $window.requestAnimationFrame(() => {\n                viewport.scrollLeft = left - scroll_indent;\n              });\n            }\n            function scrollRight() {\n              let left = viewport.scrollLeft;\n              $window.requestAnimationFrame(() => {\n                viewport.scrollLeft = left + scroll_indent;\n              });\n            }\n            function scrollUp() {\n              let top = viewport.scrollTop;\n              $window.requestAnimationFrame(() => {\n                viewport.scrollTop = top - scroll_indent;\n              });\n            }\n            function scrollDown() {\n              let top = viewport.scrollTop;\n              $window.requestAnimationFrame(() => {\n                viewport.scrollTop = top + scroll_indent;\n              });\n            }\n            return {\n              left: scrollLeft,\n              right: scrollRight,\n              up: scrollUp,\n              down: scrollDown\n            };\n          })();\n\n          function setMapDimensions(dim) {\n            map.style.width = dim+'px';\n            map.style.height = dim+'px';\n          }\n\n          function findViewportCenter() {\n            let rect = viewport.getBoundingClientRect();\n            let vw = rect.width;\n            let vh = rect.height;\n\n            let cx = viewport.scrollLeft + vw/2;\n            let cy = viewport.scrollTop + vh/2;\n\n            return [[cx, cy], [vw, vh]];\n          }\n\n          function setViewportCenter(cx, cy, vw, vh) {\n            viewport.scrollLeft = cx - vw/2;\n            viewport.scrollTop = cy - vh/2;\n          }\n\n          map.addEventListener('mouseup', mouseEvents.click);\n          map.addEventListener('mousedown', mouseEvents.down);\n          map.addEventListener('mouseleave', mouseEvents.leave);\n          map.addEventListener('dragstart', (event) => {\n            event.preventDefault();\n          });\n          map.addEventListener('contextmenu', mouseEvents.rightClick);\n\n          scope.onStateChangeEvent('Game.view.flipMap', flipMap, scope);\n          scope.onStateChangeEvent('Game.moveMap.enable', moveEvents.enable, scope);\n          scope.onStateChangeEvent('Game.moveMap.disable', moveEvents.disable, scope);\n          scope.onStateChangeEvent('Game.view.zoomIn', zoomEvents.in, scope);\n          scope.onStateChangeEvent('Game.view.zoomOut', zoomEvents.out, scope);\n          scope.onStateChangeEvent('Game.view.zoomReset', zoomEvents.reset, scope);\n          scope.onStateChangeEvent('Game.view.scrollLeft', scrollEvents.left, scope);\n          scope.onStateChangeEvent('Game.view.scrollRight', scrollEvents.right, scope);\n          scope.onStateChangeEvent('Game.view.scrollUp', scrollEvents.up, scope);\n          scope.onStateChangeEvent('Game.view.scrollDown', scrollEvents.down, scope);\n\n          $window.requestAnimationFrame(zoomEvents.reset);\n        }\n      };\n    }\n  ]);\n"]}