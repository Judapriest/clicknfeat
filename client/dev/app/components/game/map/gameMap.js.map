{"version":3,"sources":["gameMap.es6"],"names":[],"mappings":"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","file":"gameMap.js","sourcesContent":["(function() {\n  angular.module('clickApp.directives')\n    .directive('clickGameMap', clickGameMapDirectiveFactory);\n\n  clickGameMapDirectiveFactory.$inject = [\n    'appState',\n    'gameMap',\n    'terrain',\n    'commonMode',\n  ];\n  function clickGameMapDirectiveFactory(appStateService,\n                                        gameMapService,\n                                        terrainModel,\n                                        commonModeModel) {\n    const log = true // eslint-disable-line\n            ? R.bind(console.log, console)\n            : function() {};\n    return {\n      restrict: 'A',\n      link: link\n    };\n\n    function link(scope, element) {\n      const viewport = document.querySelector('#viewport');\n      const map = element[0];\n\n      const mouseEvents = buildMouseEvents();\n      const moveEvents = buildMoveEvents();\n      const flipMap = buildFlipMap();\n      const zoomEvents = buildZoomEvents();\n      const scrollEvents = buildScrollEvents();\n\n      map.addEventListener('mouseup', mouseEvents.click);\n      map.addEventListener('mousedown', mouseEvents.down);\n      map.addEventListener('mouseleave', mouseEvents.leave);\n      map.addEventListener('dragstart', (event) => {\n        event.preventDefault();\n      });\n      // map.addEventListener('contextmenu', mouseEvents.rightClick);\n\n      scope.onStateChangeEvent('Game.view.flipMap', flipMap, scope);\n      scope.onStateChangeEvent('Game.moveMap.enable', moveEvents.enable, scope);\n      scope.onStateChangeEvent('Game.moveMap.disable', moveEvents.disable, scope);\n      scope.onStateChangeEvent('Game.view.zoomIn', zoomEvents.in, scope);\n      scope.onStateChangeEvent('Game.view.zoomOut', zoomEvents.out, scope);\n      scope.onStateChangeEvent('Game.view.zoomReset', zoomEvents.reset, scope);\n      scope.onStateChangeEvent('Game.view.scrollLeft', scrollEvents.left, scope);\n      scope.onStateChangeEvent('Game.view.scrollRight', scrollEvents.right, scope);\n      scope.onStateChangeEvent('Game.view.scrollUp', scrollEvents.up, scope);\n      scope.onStateChangeEvent('Game.view.scrollDown', scrollEvents.down, scope);\n\n      self.window.requestAnimationFrame(zoomEvents.reset);\n\n      function buildMouseEvents() {\n        let drag = {\n          active: false,\n          start: null,\n          target: null,\n          now: null\n        };\n        return {\n          down: mouseDownMap,\n          // drag: dragMap,\n          leave: mouseLeaveMap,\n          click: clickMap,\n      //     rightClick: rightClickMap,\n          move: moveMap\n        };\n\n        function mouseDownMap(event) {\n          log('mouseDownMap', event, map.getBoundingClientRect());\n          blurInputs();\n          event.preventDefault();\n          if(event.which !== 1) return;\n\n          const state = appStateService.current();\n          const start = gameMapService.eventToMapCoordinates(map, event);\n          const target = gameMapService.findEventTarget(state.game, event);\n          dragStart(start, target);\n          map.addEventListener('mousemove', dragMap);\n        }\n\n        function dragMap(event) {\n          log('dragMap', event);\n          event.preventDefault();\n          if(event.which !== 1) return;\n\n          drag.now = gameMapService.eventToMapCoordinates(map, event);\n          if(!drag.active &&\n             currentDragIsBellowThreshold()) {\n            return;\n          }\n          const emit = drag.active ? 'drag' : 'dragStart';\n          drag.active = true;\n\n          if('Terrain' === drag.target.type &&\n             terrainModel.isLocked(drag.target.target)) {\n            drag.target = { type: 'Map',\n                            target: null\n                          };\n          }\n          scope.stateEvent('Modes.current.action',\n                           emit+drag.target.type,\n                           [ { target: drag.target.target,\n                               start: drag.start,\n                               now: drag.now\n                             },\n                             event\n                           ]);\n\n        }\n\n        function mouseLeaveMap(event) {\n          log('mouseLeaveMap', event);\n          event.preventDefault();\n\n          map.removeEventListener('mousemove', dragMap);\n          if(drag.active) dragEnd(event);\n        }\n\n        function clickMap(event) {\n          log('clickMap', event);\n          event.preventDefault();\n          if(event.which !== 1) return;\n\n          map.removeEventListener('mousemove', dragMap);\n\n          const state = appStateService.current();\n          const now = gameMapService.eventToMapCoordinates(map, event);\n          if(drag.active) {\n            drag.now = now;\n            dragEnd(event);\n          }\n          else {\n            const target = gameMapService\n                    .findEventTarget(state.game, event);\n            emitClickEvent('click', event, now, target);\n          }\n        }\n\n      //   function rightClickMap(event) {\n      //     log('rightClickMap', event);\n      //     event.preventDefault();\n\n      //     const now = gameMapService.eventToMapCoordinates(map, event);\n      //     gameMapService.findEventTarget(state.game, event)\n      //       .then(emitClickEvent$('rightClick', event, now));\n      //   }\n\n        function moveMap(event) {\n          log('moveMap', event);\n          event.preventDefault();\n\n          const now = gameMapService.eventToMapCoordinates(map, event);\n          scope.stateEvent('Modes.current.action',\n                           'moveMap', [now, event]);\n        }\n\n        function blurInputs() {\n          const inputs = [\n              ...document.querySelectorAll('input'),\n              ...document.querySelectorAll('select'),\n              ...document.querySelectorAll('textarea'),\n          ];\n          R.forEach((e) => { e.blur(); }, inputs);\n        }\n        function emitClickEvent(type, event, now, target) {\n          const event_name = R.thread(event)(\n            _eventModifiers,\n            R.append(type + target.type),\n            R.join('+')\n          );\n          event['click#'] = {\n            target: target.target,\n            x: now.x,\n            y: now.y\n          };\n          // state.queueChangeEventP('Game.selectionDetail.close');\n          // state.queueChangeEventP('Game.editLabel.close');\n          // state.queueChangeEventP('Game.editDamage.close');\n          Mousetrap.trigger(event_name, undefined, event);\n        }\n\n        function dragStart(start, target) {\n          drag = {\n            active: false,\n            start: start,\n            target: target,\n            now: null\n          };\n        }\n        function dragEnd(event) {\n          scope.stateEvent('Modes.current.action',\n                           'dragEnd'+drag.target.type,\n                           [ { target: drag.target.target,\n                               start: drag.start,\n                               now: drag.now\n                             },\n                             event\n                           ]);\n          drag = {\n            active: false,\n            start: null,\n            target: null,\n            now: null\n          };\n        }\n        function currentDragIsBellowThreshold() {\n          const epsilon = commonModeModel.settings().DragEpsilon;\n          return ( Math.abs(drag.now.x - drag.start.x) < epsilon &&\n                   Math.abs(drag.now.y - drag.start.y) < epsilon\n                 );\n        }\n      }\n\n      function buildMoveEvents() {\n        let move_enabled = false;\n        return {\n          enable: onEnableMove,\n          disable: onDisableMove\n        };\n\n        function onEnableMove() {\n          if(move_enabled) return;\n          map.addEventListener('mousemove', mouseEvents.move);\n          move_enabled = true;\n        }\n\n        function onDisableMove() {\n          if(!move_enabled) return;\n          map.removeEventListener('mousemove', mouseEvents.move);\n          move_enabled = false;\n        }\n      }\n\n      function buildFlipMap() {\n        let deploiement_labels;\n        init();\n        return onFlipMap;\n\n        function init() {\n          map.classList.remove('flipped');\n        }\n\n        function onFlipMap(_event_, [flipped]) {\n          deploiement_labels = document.querySelector('#deploiement-labels');\n          if(flipped) {\n            map.classList.add('flipped');\n            deploiement_labels\n              .setAttribute('transform','rotate(180,240,240)');\n          }\n          else {\n            map.classList.remove('flipped');\n            deploiement_labels\n              .setAttribute('transform','');\n          }\n        }\n      }\n\n      function buildZoomEvents() {\n        return {\n          'in': zoomIn,\n          out: zoomOut,\n          reset: zoomReset\n        };\n\n        function zoomReset() {\n          const rect = viewport.getBoundingClientRect();\n          const hw = Math.min(rect.width, rect.height);\n          setMapDimensions(hw-15);\n        }\n        function zoomIn() {\n          const zoom_factor = commonModeModel.settings().ZoomFactor;\n          let [[cx,cy],[vw,vh]] = findViewportCenter();\n\n          const rect = map.getBoundingClientRect();\n          cx = (vw > rect.width) ? rect.width / zoom_factor : cx;\n          cy = (vh > rect.height) ? rect.height / zoom_factor : cy;\n\n          setMapDimensions(rect.width * zoom_factor);\n          setViewportCenter(cx * zoom_factor, cy * zoom_factor, vw, vh);\n        }\n        function zoomOut() {\n          const zoom_factor = commonModeModel.settings().ZoomFactor;\n          const [[cx,cy],[vw,vh]] = findViewportCenter();\n          const hw = Math.min(vw, vh);\n\n          const rect = map.getBoundingClientRect();\n\n          setMapDimensions(Math.max(hw-15, rect.width / zoom_factor));\n          setViewportCenter(cx / zoom_factor, cy / zoom_factor, vw, vh);\n        }\n      }\n\n      function buildScrollEvents() {\n        return {\n          left: scrollLeft,\n          right: scrollRight,\n          up: scrollUp,\n          down: scrollDown\n        };\n\n        function scrollLeft() {\n          const scroll_step = commonModeModel.settings().ScrollStep;\n          const left = viewport.scrollLeft;\n          self.window.requestAnimationFrame(() => {\n            viewport.scrollLeft = left - scroll_step;\n          });\n        }\n        function scrollRight() {\n          const scroll_step = commonModeModel.settings().ScrollStep;\n          const left = viewport.scrollLeft;\n          self.window.requestAnimationFrame(() => {\n            viewport.scrollLeft = left + scroll_step;\n          });\n        }\n        function scrollUp() {\n          const scroll_step = commonModeModel.settings().ScrollStep;\n          const top = viewport.scrollTop;\n          self.window.requestAnimationFrame(() => {\n            viewport.scrollTop = top - scroll_step;\n          });\n        }\n        function scrollDown() {\n          const scroll_step = commonModeModel.settings().ScrollStep;\n          const top = viewport.scrollTop;\n          self.window.requestAnimationFrame(() => {\n            viewport.scrollTop = top + scroll_step;\n          });\n        }\n      }\n\n      function setMapDimensions(dim) {\n        map.style.width = dim+'px';\n        map.style.height = dim+'px';\n      }\n      function findViewportCenter() {\n        const rect = viewport.getBoundingClientRect();\n        const vw = rect.width;\n        const vh = rect.height;\n\n        const cx = viewport.scrollLeft + vw/2;\n        const cy = viewport.scrollTop + vh/2;\n\n        return [[cx, cy], [vw, vh]];\n      }\n      function setViewportCenter(cx, cy, vw, vh) {\n        viewport.scrollLeft = cx - vw/2;\n        viewport.scrollTop = cy - vh/2;\n      }\n    }\n  }\n  function _eventModifiers(e) {\n    const modifiers = [];\n\n    if (e.shiftKey) {\n      modifiers.push('shift');\n    }\n\n    if (e.altKey) {\n      modifiers.push('alt');\n    }\n\n    if (e.ctrlKey) {\n      modifiers.push('ctrl');\n    }\n\n    if (e.metaKey) {\n      modifiers.push('meta');\n    }\n\n    return modifiers.sort();\n  }\n})();\n"]}