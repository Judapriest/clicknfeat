{"version":3,"sources":["damage.es6"],"names":[],"mappings":"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","file":"damage.js","sourcesContent":["(function() {\n  angular.module('clickApp.services')\n    .factory('modelDamage', modelDamageModelFactory);\n\n  modelDamageModelFactory.$inject = [\n    'gameFactions',\n  ];\n  function modelDamageModelFactory(gameFactionsModel) {\n    const DMG_LENS = R.lensPath(['state','dmg']);\n    const DMG_FIELD_LENS = R.lensPath(['state','dmg','f']);\n    return () => {\n      const modelDamageModel = {\n        resetDamage: modelResetDamage,\n        setWarriorDamage: modelSetWarriorDamage,\n        setFieldDamage: modelSetFieldDamage,\n        setGridDamage: modelSetGridDamage,\n        setGridColDamage: modelSetGridColDamage,\n        renderDamage: modelRenderDamage\n      };\n      return modelDamageModel;\n\n      function modelResetDamage(model) {\n        return R.over(DMG_LENS, R.pipe(\n          R.keys,\n          R.reduce(resetDamageEntry, {})\n        ), model);\n\n        function resetDamageEntry(mem, key) {\n          let value = model.state.dmg[key];\n          if('Array' === R.type(value)) {\n            value = R.map(R.always(0), value);\n          }\n          else {\n            value = 0;\n          }\n          return R.assoc(key, value, mem);\n        }\n      }\n      function modelSetWarriorDamage(factions, i, model) {\n        return R.thread(factions)(\n          gameFactionsModel.getModelInfo$(model.state.info),\n          R.ifElse(\n            R.isNil,\n            () => model,\n            (info) => {\n              let value = R.defaultTo(0, model.state.dmg.n);\n              value = (value === i) ? 0 : i;\n              value = Math.min(value, info.damage.n);\n              return R.over(DMG_LENS, R.pipe(\n                R.assoc('n', value),\n                R.assoc('t', value)\n              ), model);\n            }\n          )\n        );\n      }\n      function modelSetFieldDamage(factions, i, model) {\n        return R.thread(factions)(\n          gameFactionsModel.getModelInfo$(model.state.info),\n          R.ifElse(\n            R.isNil,\n            () => model,\n            (info) => {\n              let value = R.defaultTo(0, model.state.dmg.f);\n              value = (value === i) ? 0 : i;\n              value = Math.min(value, info.damage.field);\n              return R.set(DMG_FIELD_LENS, value, model);\n            }\n          )\n        );\n      }\n      function modelSetGridDamage(factions, line, col, model) {\n        return R.thread(factions)(\n          gameFactionsModel.getModelInfo$(model.state.info),\n          R.ifElse(\n            R.isNil,\n            () => model,\n            (info) => {\n              let value = model.state.dmg[col][line];\n              value = (value === 0) ? 1 : 0;\n              value = R.exists(info.damage[col][line]) ? value : 0;\n              return R.over(DMG_LENS, R.pipe(\n                R.over(R.lensProp(col), R.update(line, value)),\n                (dmg) => R.assoc('t', computeTotalGridDamage(dmg), dmg)\n              ), model);\n            }\n          )\n        );\n      }\n      function modelSetGridColDamage(factions, col, model) {\n        return R.thread(factions)(\n          gameFactionsModel.getModelInfo$(model.state.info),\n          R.ifElse(\n            R.isNil,\n            () => model,\n            (info) => {\n              const full = R.thread(model.state.dmg[col])(\n                R.addIndex(R.filter)((_val_, line) => R.exists(info.damage[col][line])),\n                R.reject(R.equals(1)),\n                R.isEmpty\n              );\n              const value = full ? 0 : 1;\n              return R.over(DMG_LENS, R.pipe(\n                R.over(R.lensProp(col),\n                       R.addIndex(R.map)((_val_, line) => {\n                         return R.exists(info.damage[col][line]) ? value : 0;\n                       })\n                      ),\n                (dmg) => R.assoc('t', computeTotalGridDamage(dmg), dmg)\n              ), model);\n            }\n          )\n        );\n      }\n      function computeTotalGridDamage(damage) {\n        return R.thread(damage)(\n          R.keys,\n          R.reject(R.equals('t')),\n          R.reject(R.equals('f')),\n          R.reject(R.equals('n')),\n          R.reduce((mem, col) => {\n            return mem + R.reduce(R.add, 0, damage[col]);\n          }, 0)\n        );\n      }\n      function modelRenderDamage({ cx, cy,\n                                   info,\n                                   radius }, state) {\n        const state_dmg = R.propOr({}, 'dmg', state);\n        const percent_damage = state_dmg.t / info.damage.total;\n        const damage_x = cx - radius + 2 * radius * percent_damage;\n        const dmg = {\n          show: !( info.damage.type === 'warrior' &&\n                   info.damage.n === 1),\n          lx: cx - radius,\n          ly: cy + radius + 2,\n          rx: cx + radius,\n          ry: cx + radius + 2,\n          x: damage_x\n        };\n        const percent_field = state_dmg.f / info.damage.field;\n        const field_x = cx - radius + 2 * radius * percent_field;\n        const field = {\n          show: R.exists(info.damage.field),\n          lx: dmg.lx,\n          ly: dmg.ly + 1,\n          rx: dmg.rx,\n          ry: dmg.ry + 1,\n          x: field_x\n        };\n        return { dmg, field };\n      }\n    };\n  }\n})();\n"]}