{"version":3,"sources":["charge.es6"],"names":[],"mappings":"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","file":"charge.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('modelCharge', [\n    'point',\n    function modelChargeServiceFactory(pointService) {\n      var CHARGE_EPSILON = 0.1;\n      return (MOVES, modelService) => {\n        var modelChargeService = {\n          startCharge: function modelStartCharge(model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            return R.assocPath(['state','cha'], {\n              s: R.pick(['x','y','r'], model.state),\n              t: null\n            }, model);\n          },\n          isCharging: function modelIsCharging(model) {\n            return R.exists(model.state.cha);\n          },\n          chargeTarget: function modelChargeTarget(model) {\n            return new self.Promise(function(resolve, reject) {\n              if(!modelService.isCharging(model)) {\n                reject('Model is not charging');\n                return;\n              }\n              resolve(R.path(['state','cha','t'], model));\n            });\n          },\n          endCharge: function modelEndCharge(model) {\n            return R.assocPath(['state','cha'], null, model);\n          },\n          setChargeTarget: function modelSetChargeTarget(factions, other, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            if(R.exists(other)) {\n              model = R.pipe(\n                R.over(R.lensPath(['state','cha']),\n                       R.assoc('t', other.state.stamp)),\n                R.over(R.lensProp('state'),\n                       R.assoc('r', pointService.directionTo(other.state, model.state)))\n              )(model);\n            }\n            else {\n              model = R.assocPath(['state','cha','t'], null, model);\n            }\n            return modelService.checkState(factions, other, model);\n          },\n          chargeMaxLength: function modelChargeMaxLength(model) {\n            return R.path(['state','cml'], model);\n          },\n          setChargeMaxLength: function modelSetChargeMaxLength(factions, value, model) {\n            model = R.assocPath(['state','cml'], value, model);\n            return modelService.checkState(factions, null, model);\n          },\n          moveFrontCharge: function modelMoveFrontCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'MoveSmall' : 'Move'];\n            var direction = model.state.cha.s.r;\n            model = R.over(R.lensProp('state'),\n                           pointService.translateInDirection$(dist, direction),\n                           model);\n            return modelService.checkState(factions, target, model);\n          },\n          moveBackCharge: function modelMoveBackCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'MoveSmall' : 'Move'];\n            var direction = model.state.cha.s.r+180;\n            var distance = pointService.distanceTo(model.state, model.state.cha.s);\n            if(dist > distance) dist = distance;\n            model = R.over(R.lensProp('state'),\n                           pointService.translateInDirection$(dist, direction),\n                           model);\n            return modelService.checkState(factions, target, model);\n          },\n          rotateLeftCharge: function modelRotateLeftCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var angle = MOVES[small ? 'RotateChargeSmall' : 'RotateCharge'];\n            model = R.pipe(\n              R.over(R.lensProp('state'),\n                     pointService.rotateLeftAround$(angle, model.state.cha.s)),\n              R.over(R.lensPath(['state','cha','s','r']),\n                     R.subtract(R.__, angle))\n            )(model);\n            return modelService.checkState(factions, target, model);\n          },\n          rotateRightCharge: function modelRotateRightCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var angle = MOVES[small ? 'RotateChargeSmall' : 'RotateCharge'];\n            model = R.pipe( \n              R.over(R.lensProp('state'),\n                     pointService.rotateRightAround$(angle, model.state.cha.s)),\n              R.over(R.lensPath(['state','cha','s','r']), R.add(angle))\n            )(model);\n            return modelService.checkState(factions, target, model);\n          },\n          shiftLeftCharge: function modelShiftLeftCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'ShiftSmall' : 'Shift'];\n            model = R.over(R.lensProp('state'),\n                           pointService.shiftLeft$(dist),\n                           model);\n            return modelService.checkState(factions, target, model);\n          },\n          shiftRightCharge: function modelShiftRightCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'ShiftSmall' : 'Shift'];\n            model = R.over(R.lensProp('state'),\n                           pointService.shiftRight$(dist),\n                           model);\n            return modelService.checkState(factions, target, model);\n          },\n          shiftUpCharge: function modelShiftUpCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'ShiftSmall' : 'Shift'];\n            model = R.over(R.lensProp('state'),\n                           pointService.shiftUp$(dist),\n                           model);\n            return modelService.checkState(factions, target, model);\n          },\n          shiftDownCharge: function modelShiftDownCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'ShiftSmall' : 'Shift'];\n            model = R.over(R.lensProp('state'),\n                           pointService.shiftDown$(dist),\n                           model);\n            return modelService.checkState(factions, target, model);\n          }\n        };\n        var ensureChargeLength = R.curry(function _ensureChargeLength(info, target, state) {\n          if(R.exists(state.cha) &&\n             R.exists(state.cml) &&\n             state.cml > 0) {\n            var distance = pointService.distanceTo(state, state.cha.s);\n            if(distance > state.cml*10) {\n              var direction = pointService.directionTo(state, state.cha.s);\n              var position = pointService.translateInDirection(state.cml*10, direction,\n                                                               state.cha.s);\n              return R.pipe(\n                R.assoc('x', position.x),\n                R.assoc('y', position.y)\n              )(state);\n            }\n          }\n          return state;\n        });\n        modelService.state_checkers = R.append(ensureChargeLength, modelService.state_checkers);\n        var ensureChargeOrientation = R.curry(function _ensureChargeOrientation(info, target, state) {\n          if(R.exists(state.cha)) {\n            if(R.exists(target)) {\n              return R.assoc('r', pointService.directionTo(target.state, state), state);\n            }\n            var distance = pointService.distanceTo(state, state.cha.s);\n            var direction = CHARGE_EPSILON > distance ? state.r :\n                pointService.directionTo(state, state.cha.s);\n            return R.assoc('r', direction, state);\n          }\n          return state;\n        });\n        modelService.state_checkers = R.append(ensureChargeOrientation, modelService.state_checkers);\n        \n        var updateChargeDirection = R.curry(function _updateChargeDirection(state) {\n          if(R.exists(state.cha)) {\n            var distance = pointService.distanceTo(state, state.cha.s);\n            if(distance > CHARGE_EPSILON) {\n              var direction = pointService.directionTo(state, state.cha.s);\n              return R.assocPath(['cha','s','r'], direction, state);\n            }\n          }\n          return state;\n        });\n        modelService.state_updaters = R.append(updateChargeDirection, modelService.state_updaters);\n\n        return modelChargeService;\n      };\n    }\n  ]);\n"]}