{"version":3,"sources":["game.es6"],"names":[],"mappings":"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","file":"game.js","sourcesContent":["(function() {\n  angular.module('clickApp.services')\n    .factory('stateGame', stateGameModelFactory);\n\n  stateGameModelFactory.$inject = [\n    'games',\n    'game',\n    'gameBoard',\n    'gameConnection',\n    'gameFactions',\n    'gameModels',\n    'gameModelSelection',\n    'gameScenario',\n    'gameTerrains',\n    'gameTemplates',\n    'gameTemplateSelection',\n    'fileImport',\n    'stateExports',\n    'allCommands',\n    'allTemplates',\n  ];\n  function stateGameModelFactory(gamesModel,\n                                 gameModel,\n                                 gameBoardModel,\n                                 gameConnectionModel,\n                                 gameFactionsModel,\n                                 gameModelsModel,\n                                 gameModelSelectionModel,\n                                 gameScenarioModel,\n                                 gameTerrainsModel,\n                                 gameTemplatesModel,\n                                 gameTemplateSelectionModel,\n                                 fileImportService,\n                                 stateExportsModel) {\n    const stateGameModel = {\n      create: stateGamesCreate,\n      save: stateGameSave,\n      onGameLoad: stateGameOnLoad,\n      onGameConnectionClose: stateGameOnConnectionClose,\n      onGameCommandExecute: stateGameOnCommandExecute,\n      onGameCommandUndo: stateGameOnCommandUndo,\n      onGameCommandUndoLast: stateGameOnCommandUndoLast,\n      onGameCommandReplay: stateGameOnCommandReplay,\n      onGameCommandReplayNext: stateGameOnCommandReplayNext,\n      onGameCommandReplayBatch: stateGameOnCommandReplayBatch,\n      onGameSetCmds: stateGameOnSetCmds,\n      onGameSetPlayers: stateGameOnSetPlayers,\n      onGameNewChatMsg: stateGameOnNewChatMsg,\n      onGameUpdate: stateGameOnUpdate,\n      onGameInvitePlayer: stateGameOnInvitePlayer,\n      onGameModelCreate: stateGameOnModelCreate,\n      onGameModelCopy: stateGameOnModelCopy,\n      onGameModelImportList: stateGameOnModelImportList,\n      onGameModelImportFile: stateGameOnModelImportFile,\n      onGameModelSelectionLocalChange: stateGameOnModelSelectionLocalChange,\n      onGameTemplateCreate: stateGameOnTemplateCreate,\n      onGameTemplateSelectionLocalChange: stateGameOnTemplateSelectionLocalChange,\n      onGameTerrainCreate: stateGameOnTerrainCreate,\n      onGameTerrainReset: stateGameOnTerrainReset,\n      onGameBoardSet: stateGameOnBoardSet,\n      onGameBoardSetRandom: stateGameOnBoardSetRandom,\n      onGameBoardImportFile: stateGameOnBoardImportFile,\n      onGameScenarioSet: stateGameOnScenarioSet,\n      onGameScenarioSetRandom: stateGameOnScenarioSetRandom,\n      onGameScenarioRefresh: stateGameOnScenarioRefresh,\n      onGameScenarioGenerateObjectives: stateGameOnScenarioGenerateObjectives,\n      onGameSelectionLocalChange: stateGameOnSelectionLocalChange\n    };\n\n    const setGame$ = R.curry(setGame);\n    const exportCurrentGame = stateExportsModel\n            .exportP$('game', R.prop('game'));\n    const exportCurrentBoard = stateExportsModel\n            .exportP$('board', exportBoardData);\n\n    R.curryService(stateGameModel);\n    return stateGameModel;\n\n    function stateGamesCreate(state) {\n      state.game = null;\n\n      state.onEvent('Game.load',\n                    stateGameModel.onGameLoad$(state));\n      state.onEvent('Game.connection.close',\n                    stateGameModel.onGameConnectionClose$(state));\n      state.onEvent('Game.command.execute',\n                    stateGameModel.onGameCommandExecute$(state));\n      state.onEvent('Game.command.undo',\n                    stateGameModel.onGameCommandUndo$(state));\n      state.onEvent('Game.command.replay',\n                    stateGameModel.onGameCommandReplay$(state));\n      state.onEvent('Game.command.replayBatch',\n                    stateGameModel.onGameCommandReplayBatch$(state));\n      state.onEvent('Game.command.undoLast',\n                    stateGameModel.onGameCommandUndoLast$(state));\n      state.onEvent('Game.command.replayNext',\n                    stateGameModel.onGameCommandReplayNext$(state));\n      state.onEvent('Game.setCmds',\n                    stateGameModel.onGameSetCmds$(state));\n      state.onEvent('Game.setPlayers',\n                    stateGameModel.onGameSetPlayers$(state));\n      state.onEvent('Game.newChatMsg',\n                    stateGameModel.onGameNewChatMsg$(state));\n      state.onEvent('Game.update',\n                    stateGameModel.onGameUpdate$(state));\n      state.onEvent('Game.invitePlayer',\n                    stateGameModel.onGameInvitePlayer$(state));\n      state.onEvent('Game.model.create',\n                    stateGameModel.onGameModelCreate$(state));\n      state.onEvent('Game.model.copy',\n                    stateGameModel.onGameModelCopy$(state));\n      state.onEvent('Game.model.importList',\n                    stateGameModel.onGameModelImportList$(state));\n      state.onEvent('Game.model.importFile',\n                    stateGameModel.onGameModelImportFile$(state));\n      state.onChangeEvent('Game.model.selection.local.change',\n                          stateGameModel.onGameModelSelectionLocalChange$(state));\n      state.onEvent('Game.template.create',\n                    stateGameModel.onGameTemplateCreate$(state));\n      state.onChangeEvent('Game.template.selection.local.change',\n                          stateGameModel.onGameTemplateSelectionLocalChange$(state));\n      state.onEvent('Game.terrain.create',\n                    stateGameModel.onGameTerrainCreate$(state));\n      state.onEvent('Game.terrain.reset',\n                    stateGameModel.onGameTerrainReset$(state));\n      state.onEvent('Game.board.set',\n                    stateGameModel.onGameBoardSet$(state));\n      state.onEvent('Game.board.setRandom',\n                    stateGameModel.onGameBoardSetRandom$(state));\n      state.onEvent('Game.board.importFile',\n                    stateGameModel.onGameBoardImportFile$(state));\n      state.onEvent('Game.scenario.set',\n                    stateGameModel.onGameScenarioSet$(state));\n      state.onEvent('Game.scenario.setRandom',\n                    stateGameModel.onGameScenarioSetRandom$(state));\n      state.onEvent('Game.scenario.refresh',\n                    stateGameModel.onGameScenarioRefresh$(state));\n      state.onEvent('Game.scenario.generateObjectives',\n                    stateGameModel.onGameScenarioGenerateObjectives$(state));\n      state.onChangeEvent('Game.selection.local.change',\n                          stateGameModel.onGameSelectionLocalChange$(state));\n\n      return state;\n    }\n    function stateGameSave(state) {\n      return R.thread()(\n        () => saveCurrentGame(state),\n        () => exportCurrentGame(state),\n        () => exportCurrentModelSelectionP(state),\n        () => exportCurrentBoard(state)\n      );\n    }\n    function stateGameOnLoad(state, _event_, is_online, is_private, id) {\n      return R.threadP(waitForDataReady())(\n        loadStoredGameDataP,\n        broadcast('Game.loading'),\n        setGame$(state),\n        resetModes,\n        gameModel.loadP$(state),\n        // (game) => {\n        //   return new self.Promise((resolve, reject) => {\n        //     setTimeout(resolve, 3000);\n        //   });\n        // },\n        R.tap(() => { state.queueChangeEventP('Game.loaded'); }),\n        connectOnlineGame,\n        setGame$(state),\n        broadcast('Game.load.success')\n      ).catch(onError);\n\n      function waitForDataReady() {\n        return R.promiseAll([\n          state.data_ready,\n          state.user_ready,\n          state.games_ready\n        ]);\n      }\n      function loadStoredGameDataP() {\n        return ( is_online\n                 ? gamesModel.loadOnlineGameP(is_private, id)\n                 : gamesModel.loadLocalGameP(id, state.local_games)\n               );\n      }\n      function broadcast(event) {\n        return R.tap(() => {\n          state.changeEventP(event);\n        });\n      }\n      function resetModes(game) {\n        return state.eventP('Modes.reset')\n          .then(R.always(game));\n      }\n      function connectOnlineGame(game) {\n        return R.when(\n          () => is_online,\n          gameConnectionModel\n            .openP$(R.path(['user','state','name'], state), state),\n          game\n        );\n      }\n      function onError(error) {\n        state.changeEventP('Game.load.error', error);\n      }\n    }\n    function stateGameOnConnectionClose(state, _event_) {\n      return R.thread(state.game)(\n        gameConnectionModel.cleanup,\n        setGame$(state)\n      );\n    }\n    function stateGameOnCommandExecute(state, _event_, cmd, args) {\n      return R.threadP(state.game)(\n        gameModel.executeCommandP$(cmd, args, state),\n        setGame$(state)\n      ).catch(gameModel.actionError$(state));\n    }\n    function stateGameOnCommandUndo(state, _event_, cmd) {\n      return R.threadP(state.game)(\n        gameModel.undoCommandP$(cmd, state),\n        setGame$(state)\n      ).catch(gameModel.actionError$(state));\n    }\n    function stateGameOnCommandUndoLast(state, _event_) {\n      return R.threadP(state.game)(\n        gameModel.undoLastCommandP$(state),\n        setGame$(state)\n      ).catch(gameModel.actionError$(state));\n    }\n    function stateGameOnCommandReplay(state, _event_, cmd) {\n      return R.threadP(state.game)(\n        gameModel.replayCommandP$(cmd, state),\n        setGame$(state)\n      ).catch(gameModel.actionError$(state));\n    }\n    function stateGameOnCommandReplayBatch(state, _event_, cmds) {\n      return R.threadP(state.game)(\n        gameModel.replayCommandsBatchP$(cmds, state),\n        setGame$(state)\n      ).catch(gameModel.actionError$(state));\n    }\n    function stateGameOnCommandReplayNext(state, _event_) {\n      return R.threadP(state.game)(\n        gameModel.replayNextCommandP$(state),\n        setGame$(state)\n      ).catch(gameModel.actionError$(state));\n    }\n    function stateGameOnSetCmds(state, _event_, set) {\n      return R.thread(state.game)(\n        R.assoc(set.where, set.cmds),\n        R.when(\n          () => (set.where = 'chat'),\n          R.tap(() => { state.queueChangeEventP('Game.chat'); })\n        ),\n        setGame$(state)\n      );\n    }\n    function stateGameOnSetPlayers(state, _event_, players) {\n      return R.thread(state.game)(\n        R.assoc('players', players),\n        R.tap(() => { state.queueChangeEventP('Game.players.change'); }),\n        setGame$(state)\n      );\n    }\n    function stateGameOnNewChatMsg(state, _event_, msg) {\n      return R.thread(state.game)(\n        R.over(R.lensProp('chat'),\n               R.compose(R.append(msg.chat), R.defaultTo([]))),\n        setGame$(state),\n        () => { state.queueChangeEventP('Game.chat', msg.chat); }\n      );\n    }\n    function stateGameOnUpdate(state, _event_, lens, update) {\n      return R.thread(state.game)(\n        R.over(lens, update),\n        setGame$(state)\n      );\n    }\n    function stateGameOnInvitePlayer(state, _event_, to) {\n      const msg = [\n        s.capitalize(R.pathOr('Unknown', ['user','state','name'], state)),\n        'has invited you to join a game'\n      ].join(' ');\n      const link = self.window.location.hash;\n      console.log('Invite player', to, msg, link);\n\n      return state.eventP('User.sendChatMsg',\n                          { to: [to], msg: msg, link: link });\n    }\n    function stateGameOnModelCreate(state, _event_, model_path, repeat = 1) {\n      state.create = {\n        base: { x: 240, y: 240, r: 0 },\n        models: R.times((i) => ({\n          info: model_path,\n          x: 20*i, y: 0, r: 0\n        }), repeat)\n      };\n      return state.eventP('Modes.switchTo', 'CreateModel');\n    }\n    function stateGameOnModelCopy(state, _event_, create) {\n      state.create = create;\n      return state.eventP('Modes.switchTo', 'CreateModel');\n    }\n    function stateGameOnModelImportList(state, _event_, list) {\n      const user = R.pathOr('Unknown', ['user','state','name'], state);\n      state.create = gameFactionsModel\n        .buildModelsList(list, user, state.factions.references);\n      console.info('doImportList', list, state.create);\n      return state.eventP('Modes.switchTo', 'CreateModel');\n    }\n    function stateGameOnModelImportFile(state, _event_, file) {\n      return R.threadP(file)(\n        fileImportService.readP$('json'),\n        (create) => {\n          state.create = create;\n          return state.eventP('Modes.switchTo', 'CreateModel');\n        }\n      ).catch(gameModel.actionError$(state));\n    }\n    function stateGameOnModelSelectionLocalChange(state, _event_) {\n      // console.warn('onModelSelectionLocalChange', arguments);\n      const local_model_selection = gameModelSelectionModel\n              .get('local', state.game.model_selection);\n      const length = R.length(local_model_selection);\n      const previous_selection = R.path(['_model_selection_listener','stamp'], state);\n      if(length === 1 &&\n         local_model_selection[0] === previous_selection) {\n        return;\n      }\n      cleanupModelSelectionListener(state);\n      if(length === 1) {\n        setupModelSelectionListener(local_model_selection[0], state);\n      }\n      else {\n        state.queueChangeEventP('Game.model.selection.local.updateSingle',\n                                null, null);\n      }\n    }\n    function setupModelSelectionListener(stamp, state) {\n      // console.warn('setupModelSelectionListener', arguments);\n      state._model_selection_listener = {\n        stamp: stamp,\n        unsubscribe: state\n          .onChangeEvent(`Game.model.change.${stamp}`,\n                         onModelSelectionChange(stamp, state))\n      };\n    }\n    function onModelSelectionChange(stamp, state) {\n      return () => {\n        // console.warn('onModelSelectionChange', arguments);\n        return R.threadP(state.game)(\n          R.prop('models'),\n          gameModelsModel.findStampP$(stamp),\n          (model) => {\n            state.queueChangeEventP('Game.model.selection.local.updateSingle',\n                                    stamp, model);\n          }\n        );\n      };\n    }\n    function cleanupModelSelectionListener(state) {\n      // console.warn('cleanupModelSelectionListener', arguments);\n      const unsubscribe = R.thread(state)(\n        R.path(['_model_selection_listener','unsubscribe']),\n        R.defaultTo(() => {})\n      );\n      unsubscribe();\n      state._model_selection_listener = {};\n    }\n    function stateGameOnTemplateCreate(state, _event_, type) {\n      state.create = {\n        base: { x: 240, y: 240, r: 0 },\n        templates: [ { type: type, x: 0, y: 0, r: 0 } ]\n      };\n      return state.eventP('Modes.switchTo', 'CreateTemplate');\n    }\n    function stateGameOnTemplateSelectionLocalChange(state, _event_) {\n      console.warn('onTemplateSelectionLocalChange', arguments);\n      const local_template_selection = gameTemplateSelectionModel\n              .get('local', state.game.template_selection);\n      const length = R.length(local_template_selection);\n      const previous_selection =\n              R.path(['_template_selection_listener','stamp'], state);\n      if(length === 1 &&\n         local_template_selection[0] === previous_selection) {\n        return;\n      }\n      cleanupTemplateSelectionListener(state);\n      if(length === 1) {\n        setupTemplateSelectionListener(local_template_selection[0], state);\n      }\n      else {\n        state.queueChangeEventP('Game.template.selection.local.updateSingle',\n                                null, null);\n      }\n    }\n    function setupTemplateSelectionListener(stamp, state) {\n      console.warn('setupTemplateSelectionListener', arguments);\n      state._template_selection_listener = {\n        stamp: stamp,\n        unsubscribe: state\n          .onChangeEvent(`Game.template.change.${stamp}`,\n                         onTemplateSelectionChange(stamp, state))\n      };\n    }\n    function onTemplateSelectionChange(stamp, state) {\n      return () => {\n        console.warn('onTemplateSelectionChange', arguments);\n        return R.threadP(state.game)(\n          R.prop('templates'),\n          gameTemplatesModel.findStampP$(stamp),\n          (template) => {\n            state.queueChangeEventP('Game.template.selection.local.updateSingle',\n                                    stamp, template);\n          }\n        );\n      };\n    }\n    function cleanupTemplateSelectionListener(state) {\n      console.warn('cleanupTemplateSelectionListener', arguments);\n      const unsubscribe = R.thread(state)(\n        R.path(['_template_selection_listener','unsubscribe']),\n        R.defaultTo(() => {})\n      );\n      unsubscribe();\n      state._template_selection_listener = {};\n    }\n    function stateGameOnTerrainCreate(state, _event_, path) {\n      state.create = {\n        base: { x: 240, y: 240, r: 0 },\n        terrains: [ {\n          info: path,\n          x: 0, y: 0, r: 0\n        } ]\n      };\n      return state.eventP('Modes.switchTo', 'CreateTerrain');\n    }\n    function stateGameOnTerrainReset(state, _event_) {\n      return R.threadP(state.game)(\n        R.prop('terrains'),\n        gameTerrainsModel.all,\n        R.pluck('state'),\n        R.pluck('stamp'),\n        (stamps) => state.eventP('Game.command.execute',\n                                 'deleteTerrain', [stamps])\n      ).catch(gameModel.actionError$(state));\n    }\n    function stateGameOnBoardSet(state, _event_, name) {\n      let board = gameBoardModel.forName(name, state.boards);\n      return state.eventP('Game.command.execute',\n                          'setBoard', [board]);\n    }\n    function stateGameOnBoardSetRandom(state, _event_) {\n      let board, name = gameBoardModel.name(state.game.board);\n      while(name === gameBoardModel.name(state.game.board)) {\n        board = state.boards[R.randomRange(0, state.boards.length-1)];\n        name = gameBoardModel.name(board);\n      }\n      return state.eventP('Game.command.execute',\n                          'setBoard', [board]);\n    }\n    function stateGameOnBoardImportFile(state, _event_, file) {\n      return R.threadP(file)(\n        fileImportService.readP$('json'),\n        (data) => R.threadP(data)(\n          R.prop('board'),\n          R.rejectIf(R.isNil, 'No board'),\n          () => state.eventP('Game.command.execute',\n                             'setBoard', [data.board]),\n          R.always(data),\n          R.path(['terrain', 'terrains']),\n          R.rejectIf(R.isEmpty, 'No terrain'),\n          () => state.eventP('Game.terrain.reset'),\n          () => state.eventP('Game.command.execute',\n                             'createTerrain', [data.terrain, false])\n        )\n      ).catch(R.spyAndDiscardError('Import board file'));\n    }\n    function stateGameOnScenarioSet(state, _event_, name, group) {\n      const scenario = gameScenarioModel.forName(name, group);\n      return state.eventP('Game.command.execute',\n                          'setScenario', [scenario]);\n    }\n    function stateGameOnScenarioSetRandom(state, _event_) {\n      const group = gameScenarioModel.group('SR15', state.scenarios);\n      let scenario, name = gameScenarioModel.name(state.game.scenario);\n      while(name === gameScenarioModel.name(state.game.scenario)) {\n        scenario = group[1][R.randomRange(0, group[1].length-1)];\n        name = gameScenarioModel.name(scenario);\n      }\n      return state.eventP('Game.command.execute',\n                          'setScenario', [scenario]);\n    }\n    function stateGameOnScenarioRefresh(state, _event_) {\n      state.queueChangeEventP('Game.scenario.refresh');\n    }\n    function stateGameOnScenarioGenerateObjectives(state, _event_) {\n      return R.threadP(state.game)(\n        deleteCurrentObjectivesP,\n        () => gameScenarioModel\n          .createObjectivesP(state.game.scenario),\n        (objectives) => {\n          const is_flipped = R.path(['ui_state','flip_map'], state);\n          return state.eventP('Game.command.execute',\n                              'createModel',\n                              [objectives, is_flipped]);\n        }\n      ).catch(gameModel.actionError$(state));\n\n      function deleteCurrentObjectivesP(game) {\n        return R.threadP(game)(\n          R.prop('models'),\n          gameModelsModel.all,\n          R.filter(R.pipe(\n            R.path(['state','info']),\n            R.head,\n            R.equals('scenario')\n          )),\n          R.map(R.path(['state','stamp'])),\n          R.unless(\n            R.isEmpty,\n            (stamps) => state.eventP('Game.command.execute',\n                                     'deleteModel', [stamps])\n          )\n        );\n      }\n    }\n    function stateGameOnSelectionLocalChange(state, _event_) {\n      state.queueEventP('Modes.switchTo', 'Default');\n    }\n    function setGame(state, game) {\n      state.game = game;\n      console.log('stateGame', state.game);\n      state.queueChangeEventP('Game.change');\n      return game;\n    }\n    function saveCurrentGame(state) {\n      if(state._game === state.game) return null;\n      state._game = state.game;\n\n      if(R.isNil(R.path(['game','local_stamp'], state))) {\n        return null;\n      }\n      return R.thread(state.local_games)(\n        gamesModel.updateLocalGame$(state.game),\n        (games) => {\n          state.local_games = games;\n          console.log('stateSetLocalGames', state.local_games);\n          state.queueChangeEventP('Games.local.change');\n        }\n      );\n    }\n    function exportCurrentModelSelectionP(state) {\n      return stateExportsModel\n        .exportP('models', (state) => R.threadP(state)(\n          R.path(['game','model_selection']),\n          R.rejectIf(R.isNil, 'selection is nil'),\n          gameModelSelectionModel.get$('local'),\n          R.rejectIf(R.isEmpty, 'selection is empty'),\n          (stamps) => gameModelsModel\n            .copyStampsP(stamps, R.path(['game', 'models'], state)),\n          R.rejectIf(R.isEmpty, 'selection models not found')\n        ), state);\n    }\n    function exportBoardData(state) {\n      return R.thread(state)(\n        R.prop('game'),\n        (game) => ({\n          board: game.board,\n          terrain: {\n            base: { x: 0, y: 0, r: 0 },\n            terrains: R.thread(game.terrains)(\n              gameTerrainsModel.all,\n              R.pluck('state'),\n              R.map(R.pick(['x','y','r','info','lk']))\n            )\n          }\n        })\n      );\n    }\n  }\n})();\n"]}