{"version":3,"sources":["los.es6"],"names":[],"mappings":"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","file":"los.js","sourcesContent":["'use strict';\n\nangular.module('clickApp.services')\n  .factory('gameLos', [\n    'point',\n    'circle',\n    'gameFactions',\n    'gameModels',\n    function gameLosServiceFactory(pointService,\n                                   circleService,\n                                   gameFactionsService,\n                                   gameModelsService) {\n      var gameLosService = {\n        create: function gameLosCreate() {\n          return {\n            local: {\n              display: false,\n              start: { x: 0, y: 0 },\n              end: { x: 0, y: 0 }\n            },\n            remote: {\n              display: false,\n              start: { x: 0, y: 0 },\n              end: { x: 0, y: 0 }\n            },\n            computed: {}\n          };\n        },\n        isDisplayed: function gameLosIsDisplayed(los) {\n          return R.path(['remote','display'], los);\n        },\n        origin: function gameLosOrigin(los) {\n          return R.path(['remote', 'origin'], los);\n        },\n        clearOrigin: function gameLosClearOrigin(state, game, los) {\n          return setOriginTarget(null, los.remote.target, null, false,\n                                 state, game, los);\n        },\n        setOrigin: function gameLosSetOrigin(origin_model, state, game, los) {\n          var origin = origin_model.state.stamp;\n          var target = gameLosService.target(los);\n          target = (target === origin) ? null : target;\n          let display = (target && origin);\n          return setOriginTarget(origin, target, null, display,\n                                 state, game, los);\n        },\n        setOriginResetTarget: function gameLosSetOriginResetTarget(origin_model, state, game, los) {\n          var origin = origin_model.state.stamp;\n          return setOriginTarget(origin, null, null, false,\n                                 state, game, los);\n        },\n        target: function gameLosTarget(los) {\n          return R.path(['remote', 'target'], los);\n        },\n        clearTarget: function gameLosClearTarget(state, game, los) {\n          return setOriginTarget(los.remote.origin, null, null, false,\n                                 state, game, los);\n        },\n        setTarget: function gameLosSetTarget(target_model, state, game, los) {\n          var origin = gameLosService.origin(los);\n          var target = target_model.state.stamp;\n          origin = (origin === target) ? null : origin;\n          let display = (target && origin);\n          return setOriginTarget(origin, target, null, display,\n                                 state, game, los);\n        },\n        toggleIgnoreModel: function(model, state, game, los) {\n          let ignore = R.pathOr([], ['remote','ignore'], los);\n          let is_ignored = R.find(R.equals(model.state.stamp),\n                                  ignore);\n          ignore = ( is_ignored ?\n                     R.reject(R.equals(model.state.stamp), ignore) :\n                     R.append(model.state.stamp, ignore)\n                   );\n          console.log('toggleIgnoreModel', ignore);\n          \n          return setOriginTarget(los.remote.origin,\n                                 los.remote.target,\n                                 ignore,\n                                 los.remote.display,\n                                 state, game, los);\n        },\n        updateOriginTarget(state, game, los) {\n          return setOriginTarget(los.remote.origin,\n                                 los.remote.target,\n                                 los.remote.ignore,\n                                 los.remote.display,\n                                 state, game, los);\n        },\n        toggleDisplay: function gameLosToggleDisplay(state, game, los) {\n          let path = ['remote','display'];\n          let display = !R.path(path, los);\n\n          return setOriginTarget(los.remote.origin,\n                                 los.remote.target,\n                                 los.remote.ignore,\n                                 display,\n                                 state, game, los);\n        },\n        setLocal: function gameLosSetLocal(start, end, state, los) {\n          return R.pipe(\n            R.prop('local'),\n            R.assoc('start', R.clone(start)),\n            R.assoc('end', R.clone(end)),\n            R.assoc('display', true),\n            function(local) {\n              state.changeEvent('Game.los.local.change');\n\n              return R.assoc('local', local, los);\n            }\n          )(los);\n        },\n        setRemote: function gameLosSetRemote(start, end, state, game, los) {\n          los = R.assocPath(['local','display'], false, los);          \n          state.changeEvent('Game.los.local.change');\n\n          los = R.pipe(\n            R.assocPath(['remote','start'], R.clone(start)),\n            R.assocPath(['remote','end'], R.clone(end))\n          )(los);\n          state.changeEvent('Game.los.remote.change');\n          \n          return setOriginTarget(los.remote.origin,\n                                 los.remote.target,\n                                 los.remote.ignore,\n                                 true,\n                                 state, game, los);\n        },\n        saveRemoteState: function gameLosSaveRemoteState(los) {\n          return R.clone(R.prop('remote', los));\n        },\n        resetRemote: function gameLosResetRemote(remote, state, game, los) {\n          los = R.assoc('remote', R.clone(remote), los);\n          return setOriginTarget(los.remote.origin,\n                                 los.remote.target,\n                                 los.remote.ignore,\n                                 los.remote.display,\n                                 state, game, los);\n        }\n      };\n      function setOriginTarget(origin, target, ignore, display,\n                               state, game, los) {\n        los = R.pipe(\n          R.assocPath(['remote','origin'], origin),\n          R.assocPath(['remote','target'], target),\n          R.assocPath(['remote','display'], display),\n          R.assocPath(['remote','ignore'], [])\n        )(los);\n        los = R.pipe(\n          R.assocPath(['computed','envelope'], null),\n          R.assocPath(['computed','darkness'], []),\n          R.assocPath(['computed','shadow'], [])\n        )(los);\n\n        if( !los.remote.origin ||\n            !los.remote.target ) {\n          state.changeEvent('Game.los.remote.change');\n          return self.Promise.resolve(los);\n        }\n\n        los = R.over(R.lensPath(['remote','ignore']),\n                     R.defaultTo([]), los);\n        return R.pipeP(\n          () => {\n            return getOriginTargetInfo(state, game,\n                                       los.remote.origin,\n                                       los.remote.target);\n          },\n          ([origin_state, origin_info, target_state, target_info]) => {\n            let origin_circle = {\n              x: origin_state.x,\n              y: origin_state.y,\n              radius: origin_info.base_radius\n            };\n            let target_circle = {\n              x: target_state.x,\n              y: target_state.y,\n              radius: target_info.base_radius\n            };\n            let envelope = circleService.envelopeTo(target_circle, origin_circle);\n            los = R.assocPath(['computed','envelope'], envelope, los);\n\n            return R.pipeP(\n              () => {\n                return computeIntervenings(state, game, los.remote.ignore,\n                                           target, target_circle,\n                                           origin, envelope);\n              },\n              (intervenings) => {\n                return [ origin_circle, intervenings ];\n              }\n            )();\n          },\n          ([ origin_circle, intervenings ]) => {\n            // console.log('gameLos intervenings', intervenings);\n\n            let darkness = computeDarkness(origin_circle, intervenings);\n            los = R.assocPath(['computed','darkness'], darkness, los);\n\n            let shadow = computeShadow(origin_circle, intervenings);\n            los = R.assocPath(['computed','shadow'], shadow, los);\n\n            state.changeEvent('Game.los.remote.change');\n\n            return los;\n          }\n        )();\n      }\n      function getOriginTargetInfo(state, game, origin, target) {\n        return R.pipePromise(\n          () => {\n            return [\n              gameModelsService.findStamp(origin, game.models),\n              gameModelsService.findStamp(target, game.models),\n            ];\n          },\n          R.promiseAll,\n          ([{ state: origin_state }, { state: target_state }]) => {\n            return R.pipePromise(\n              () => {\n                return [\n                  gameFactionsService.getModelInfo(origin_state.info, state.factions),\n                  gameFactionsService.getModelInfo(target_state.info, state.factions),\n                ];\n              },\n              R.promiseAll,\n              ([origin_info, target_info]) => {\n                return [\n                  origin_state, origin_info,\n                  target_state, target_info,\n                ];\n              }\n            )();\n          }\n        )();\n      }\n      function computeIntervenings(state, game, ignore,\n                                   target, target_circle,\n                                   origin, envelope) {\n        return R.pipePromise(\n          gameModelsService.all,\n          R.map((model) => {\n            return R.pipeP(\n              () => {\n                return gameFactionsService\n                  .getModelInfo(model.state.info, state.factions);\n              },\n              (info) => {\n                return R.assoc('radius', info.base_radius, model.state);\n              }\n            )();\n          }),\n          R.promiseAll,\n          R.reject((circle) => {\n            return (target === circle.stamp ||\n                    origin === circle.stamp ||\n                    target_circle.radius > circle.radius ||\n                    R.find(R.equals(circle.stamp), ignore)\n                   );\n          }),\n          R.filter(circleService.isInEnvelope$(envelope))\n        )(game.models);\n      }                                      \n      function computeDarkness(origin_circle,\n                               intervenings) {\n        return R.map((circle) => {\n          return circleService\n            .outsideEnvelopeTo(circle, [], origin_circle);\n        }, intervenings);\n      }\n      function computeShadow(origin_circle,\n                             intervenings) {\n        return R.map((circle) => {\n          return circleService\n            .outsideEnvelopeTo(circle, intervenings, origin_circle);\n        }, intervenings);\n      }\n      R.curryService(gameLosService);\n      return gameLosService;\n    }\n  ]);\n"]}