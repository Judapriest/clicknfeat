{"version":3,"sources":["connection.es6"],"names":[],"mappings":";;AAAA,CAAC,YAAW;AACV,UAAQ,MAAR,CAAe,mBAAf,EACG,OADH,CACW,gBADX,EAC6B,0BAD7B,EADU;;AAIV,6BAA2B,OAA3B,GAAqC,CACnC,WADmC,CAArC,CAJU;AAOV,WAAS,0BAAT,CAAoC,cAApC,EAAoD;AAClD,QAAM,sBAAsB;AAC1B,cAAQ,oBAAR;AACA,aAAO,mBAAP;AACA,aAAO,mBAAP;AACA,eAAS,qBAAT;AACA,cAAQ,oBAAR;AACA,0BAAoB,gCAApB;AACA,wBAAkB,8BAAlB;AACA,kBAAY,wBAAZ;KARI,CAD4C;AAWlD,QAAM,oBAAoB,EAAE,KAAF,CAAQ,gBAAR,CAApB,CAX4C;AAYlD,QAAM,kBAAkB,EAAE,KAAF,CAAQ,cAAR,CAAlB,CAZ4C;AAalD,QAAM,mBAAmB,EAAE,KAAF,CAAQ,eAAR,CAAnB,CAb4C;AAclD,QAAM,eAAe,EAAE,KAAF,CAAQ,WAAR,CAAf,CAd4C;AAelD,QAAM,kBAAkB,EAAE,KAAF,CAAQ,cAAR,CAAlB,CAf4C;AAgBlD,QAAM,kBAAkB,EAAE,KAAF,CAAQ,cAAR,CAAlB,CAhB4C;;AAkBlD,MAAE,YAAF,CAAe,mBAAf,EAlBkD;AAmBlD,WAAO,mBAAP,CAnBkD;;AAqBlD,aAAS,oBAAT,CAA8B,IAA9B,EAAoC;AAClC,UAAM,aAAa;AACjB,eAAO,EAAE,QAAQ,IAAR,EAAT;OADI,CAD4B;AAIlC,aAAO,EAAE,KAAF,CAAQ,YAAR,EAAsB,UAAtB,EAAkC,IAAlC,CAAP,CAJkC;KAApC;AAMA,aAAS,mBAAT,CAA6B,SAA7B,EAAwC,KAAxC,EAA+C,IAA/C,EAAqD;AACnD,UAAG,oBAAoB,MAApB,CAA2B,IAA3B,CAAH,EAAqC;AACnC,eAAO,EAAE,QAAF,CAAW,IAAX,CAAP,CADmC;OAArC;AAGA,kBAAY,EAAE,IAAF,CAAO,SAAP,CAAZ,CAJmD;AAKnD,UAAM,WAAW;AACf,eAAO,cAAc,KAAd,CAAP;AACA,cAAM,aAAa,KAAb,CAAN;AACA,mBAAW,kBAAkB,KAAlB,CAAX;AACA,iBAAS,gBAAgB,KAAhB,CAAT;AACA,kBAAU,iBAAiB,KAAjB,CAAV;AACA,iBAAS,gBAAgB,KAAhB,CAAT;AACA,iBAAS,gBAAgB,KAAhB,CAAT;OAPI,CAL6C;;AAenD,aAAO,EAAE,SAAF,CAAY,CAAC,YAAD,EAAc,OAAd,EAAsB,QAAtB,CAAZ,EAA6C,IAA7C,EAAmD,IAAnD,CAAP,CAfmD;AAgBnD,UAAI,MAAM,CACR,YADQ,EAEN,EAAE,IAAF,CAAO,eAAP,EAAwB,IAAxB,IACE,SADF,GAEE,QAFF,EAIA,EAAE,IAAF,CAAO,eAAP,EAAwB,IAAxB,IACE,EAAE,IAAF,CAAO,eAAP,EAAwB,IAAxB,CADF,GAEE,EAAE,IAAF,CAAO,cAAP,EAAuB,IAAvB,CAFF,CANM,CAUR,IAVQ,CAUH,GAVG,CAAN,CAhB+C;AA2BnD,aAAO,WAAS,SAAT,CA3B4C;;AA6BnD,aAAO,EAAE,OAAF,GACL;eAAM,eACH,OADG,CACK,GADL,EACU,MADV,EACkB,QADlB;OAAN,EAEA,UAAC,MAAD;eAAY,EAAE,SAAF,CAAY,CAAC,YAAD,EAAe,OAAf,EAAwB,QAAxB,CAAZ,EACY,MADZ,EACoB,IADpB;OAAZ,CAHF,CA7BmD;KAArD;AAoCA,aAAS,mBAAT,CAA6B,IAA7B,EAAmC;AACjC,UAAG,oBAAoB,MAApB,CAA2B,IAA3B,CAAH,EAAqC;AACnC,uBAAe,KAAf,CAAqB,KAAK,UAAL,CAAgB,KAAhB,CAAsB,MAAtB,CAArB,CADmC;OAArC;AAGA,aAAO,oBAAoB,OAApB,CAA4B,IAA5B,CAAP,CAJiC;KAAnC;AAMA,aAAS,qBAAT,CAA+B,IAA/B,EAAqC;AACnC,aAAO,EAAE,SAAF,CAAY,CAAC,YAAD,EAAc,OAAd,EAAsB,QAAtB,CAAZ,EAA6C,IAA7C,EAAmD,IAAnD,CAAP,CADmC;KAArC;AAGA,aAAS,oBAAT,CAA8B,IAA9B,EAAoC;AAClC,aAAO,EAAE,MAAF,CAAS,IAAT,EACL,EAAE,IAAF,CAAO,CAAC,YAAD,EAAc,OAAd,EAAsB,QAAtB,CAAP,CADK,EAEL,EAAE,MAAF,CAFF,CADkC;KAApC;AAMA,aAAS,gCAAT,CAA0C,OAA1C,EAAmD,IAAnD,EAAyD;AACvD,aAAO,EAAE,OAAF,CAAU,IAAV,EACL,oBAAoB,WAApB,CAAgC;AAC9B,cAAM,WAAN;AACA,aAAK,OAAL;OAFF,CADK,EAKL,EAAE,IAAF,CAAO,EAAE,QAAF,CAAW,cAAX,CAAP,EACO,EAAE,OAAF,CAAU,EAAE,MAAF,CAAS,OAAT,CAAV,EAA6B,EAAE,SAAF,CAAY,EAAZ,CAA7B,CADP,CALK,CAAP,CADuD;KAAzD;AAUA,aAAS,8BAAT,CAAwC,OAAxC,EAAiD,IAAjD,EAAuD;AACrD,aAAO,EAAE,OAAF,CAAU,IAAV,EACL,oBAAoB,WAApB,CAAgC;AAC9B,cAAM,SAAN;AACA,aAAK,OAAL;OAFF,CADK,EAKL,EAAE,IAAF,CAAO,EAAE,QAAF,CAAW,UAAX,CAAP,EACO,EAAE,OAAF,CAAU,EAAE,MAAF,CAAS,OAAT,CAAV,EAA6B,EAAE,SAAF,CAAY,EAAZ,CAA7B,CADP,CALK,CAAP,CADqD;KAAvD;AAUA,aAAS,wBAAT,CAAkC,KAAlC,EAAyC,IAAzC,EAA+C;AAC7C,aAAO,EAAE,OAAF,CAAU,IAAV,EACL,EAAE,QAAF,CAAW,EAAE,UAAF,CAAa,oBAAoB,MAApB,CAAxB,EACW,YADX,CADK,EAGL;eAAM,eACH,IADG,CACE,KADF,EACS,KAAK,UAAL,CAAgB,KAAhB,CAAsB,MAAtB;OADf,EAEA,EAAE,MAAF,CAAS,IAAT,CALK,CAAP,CAD6C;KAA/C;AASA,aAAS,aAAT,CAAuB,KAAvB,EAA8B;AAC5B,aAAO,YAAM;AACX,gBAAQ,KAAR,CAAc,wBAAd,EADW;AAEX,cAAM,WAAN,CAAkB,uBAAlB,EAFW;OAAN,CADqB;KAA9B;AAMA,aAAS,gBAAT,CAA0B,KAA1B,EAAiC,GAAjC,EAAsC;AACpC,cAAQ,GAAR,CAAY,4BAAZ,EAA0C,GAA1C,EADoC;AAEpC,YAAM,WAAN,CAAkB,qBAAlB,EAAyC,IAAI,GAAJ,CAAzC,CAFoC;KAAtC;AAIA,aAAS,cAAT,CAAwB,KAAxB,EAA+B,GAA/B,EAAoC;AAClC,cAAQ,GAAR,CAAY,0BAAZ,EAAwC,GAAxC,EADkC;AAElC,YAAM,WAAN,CAAkB,mBAAlB,EAAuC,IAAI,GAAJ,CAAvC,CAFkC;KAApC;AAIA,aAAS,eAAT,CAAyB,KAAzB,EAAgC,GAAhC,EAAqC;AACnC,cAAQ,GAAR,CAAY,2BAAZ,EAAyC,GAAzC,EADmC;AAEnC,YAAM,WAAN,CAAkB,0BAAlB,EAA8C,IAAI,IAAJ,CAA9C,CAFmC;KAArC;AAIA,aAAS,WAAT,CAAqB,KAArB,EAA4B,GAA5B,EAAiC;AAC/B,cAAQ,GAAR,CAAY,2BAAZ,EAAyC,GAAzC,EAD+B;AAE/B,YAAM,WAAN,CAAkB,iBAAlB,EAAqC,GAArC,EAF+B;KAAjC;AAIA,aAAS,cAAT,CAAwB,KAAxB,EAA+B,GAA/B,EAAoC;AAClC,cAAQ,GAAR,CAAY,0BAAZ,EAAwC,GAAxC,EADkC;AAElC,YAAM,WAAN,CAAkB,cAAlB,EAAkC,GAAlC,EAFkC;KAApC;AAIA,aAAS,cAAT,CAAwB,KAAxB,EAA+B,GAA/B,EAAoC;AAClC,cAAQ,GAAR,CAAY,0BAAZ,EAAwC,GAAxC,EADkC;AAElC,YAAM,WAAN,CAAkB,iBAAlB,EAAqC,IAAI,OAAJ,CAArC,CAFkC;KAApC;GArIF;CAPD,CAAD","file":"connection.js","sourcesContent":["(function() {\n  angular.module('clickApp.services')\n    .factory('gameConnection', gameConnectionModelFactory);\n\n  gameConnectionModelFactory.$inject = [\n    'websocket',\n  ];\n  function gameConnectionModelFactory(websocketModel) {\n    const gameConnectionModel = {\n      create: gameConnectionCreate,\n      openP: gameConnectionOpenP,\n      close: gameConnectionClose,\n      cleanup: gameConnectionCleanup,\n      active: gameConnectionActive,\n      sendReplayCommandP: gameConnectionSendReplayCommandP,\n      sendUndoCommandP: gameConnectionSendUndoCommandP,\n      sendEventP: gameConnectionSendEventP\n    };\n    const replayCmdHandler$ = R.curry(replayCmdHandler);\n    const undoCmdHandler$ = R.curry(undoCmdHandler);\n    const cmdBatchHandler$ = R.curry(cmdBatchHandler);\n    const chatHandler$ = R.curry(chatHandler);\n    const setCmdsHandler$ = R.curry(setCmdsHandler);\n    const playersHandler$ = R.curry(playersHandler);\n\n    R.curryService(gameConnectionModel);\n    return gameConnectionModel;\n\n    function gameConnectionCreate(game) {\n      const connection = {\n        state: { socket: null }\n      };\n      return R.assoc('connection', connection, game);\n    }\n    function gameConnectionOpenP(user_name, state, game) {\n      if(gameConnectionModel.active(game)) {\n        return R.resolveP(game);\n      }\n      user_name = s.trim(user_name);\n      const handlers = {\n        close: closeHandler$(state),\n        chat: chatHandler$(state),\n        replayCmd: replayCmdHandler$(state),\n        undoCmd: undoCmdHandler$(state),\n        cmdBatch: cmdBatchHandler$(state),\n        setCmds: setCmdsHandler$(state),\n        players: playersHandler$(state)\n      };\n\n      game = R.assocPath(['connection','state','socket'], null, game);\n      let url = [\n        '/api/games',\n        ( R.prop('private_stamp', game)\n          ? 'private'\n          : 'public'\n        ),\n        ( R.prop('private_stamp', game)\n          ? R.prop('private_stamp', game)\n          : R.prop('public_stamp', game)\n        )\n      ].join('/');\n      url += '?name='+user_name;\n\n      return R.threadP()(\n        () => websocketModel\n          .createP(url, 'game', handlers),\n        (socket) => R.assocPath(['connection', 'state', 'socket'],\n                                socket, game)\n      );\n    }\n    function gameConnectionClose(game) {\n      if(gameConnectionModel.active(game)) {\n        websocketModel.close(game.connection.state.socket);\n      }\n      return gameConnectionModel.cleanup(game);\n    }\n    function gameConnectionCleanup(game) {\n      return R.assocPath(['connection','state','socket'], null, game);\n    }\n    function gameConnectionActive(game) {\n      return R.thread(game)(\n        R.path(['connection','state','socket']),\n        R.exists\n      );\n    }\n    function gameConnectionSendReplayCommandP(command, game) {\n      return R.threadP(game)(\n        gameConnectionModel.sendEventP$({\n          type: 'replayCmd',\n          cmd: command\n        }),\n        R.over(R.lensProp('commands_log'),\n               R.compose(R.append(command), R.defaultTo([])))\n      );\n    }\n    function gameConnectionSendUndoCommandP(command, game) {\n      return R.threadP(game)(\n        gameConnectionModel.sendEventP$({\n          type: 'undoCmd',\n          cmd: command\n        }),\n        R.over(R.lensProp('undo_log'),\n               R.compose(R.append(command), R.defaultTo([])))\n      );\n    }\n    function gameConnectionSendEventP(event, game) {\n      return R.threadP(game)(\n        R.rejectIf(R.complement(gameConnectionModel.active),\n                   'Not active'),\n        () => websocketModel\n          .send(event, game.connection.state.socket),\n        R.always(game)\n      );\n    }\n    function closeHandler$(state) {\n      return () => {\n        console.error('Game connection: close');\n        state.queueEventP('Game.connection.close');\n      };\n    }\n    function replayCmdHandler(state, msg) {\n      console.log('Game connection: replayCmd', msg);\n      state.queueEventP('Game.command.replay', msg.cmd);\n    }\n    function undoCmdHandler(state, msg) {\n      console.log('Game connection: undoCmd', msg);\n      state.queueEventP('Game.command.undo', msg.cmd);\n    }\n    function cmdBatchHandler(state, msg) {\n      console.log('Game connection: cmdBatch', msg);\n      state.queueEventP('Game.command.replayBatch', msg.cmds);\n    }\n    function chatHandler(state, msg) {\n      console.log('Game connection: chat msg', msg);\n      state.queueEventP('Game.newChatMsg', msg);\n    }\n    function setCmdsHandler(state, msg) {\n      console.log('Game connection: setCmds', msg);\n      state.queueEventP('Game.setCmds', msg);\n    }\n    function playersHandler(state, msg) {\n      console.log('Game connection: players', msg);\n      state.queueEventP('Game.setPlayers', msg.players);\n    }\n  }\n})();\n"]}