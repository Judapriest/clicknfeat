{"version":3,"sources":["connection.es6"],"names":[],"mappings":"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","file":"connection.js","sourcesContent":["(function() {\n  angular.module('clickApp.services')\n    .factory('gameConnection', gameConnectionModelFactory);\n\n  gameConnectionModelFactory.$inject = [\n    'websocket',\n    'appState',\n  ];\n  function gameConnectionModelFactory(websocketModel,\n                                      appStateService) {\n    const SOCKET_LENS = R.lensPath(['connection','state','socket']);\n    const COMMANDS_LOG_LENS = R.lensProp('commands_log');\n    const UNDO_LOG_LENS = R.lensProp('undo_log');\n\n    const gameConnectionModel = {\n      create: gameConnectionCreate,\n      openP: gameConnectionOpenP,\n      close: gameConnectionClose,\n      cleanup: gameConnectionCleanup,\n      active: gameConnectionActive,\n      sendReplayCommand: gameConnectionSendReplayCommand,\n      sendUndoCommand: gameConnectionSendUndoCommand,\n      sendEvent: gameConnectionSendEvent\n    };\n    R.curryService(gameConnectionModel);\n    return gameConnectionModel;\n\n    function gameConnectionCreate(game) {\n      const connection = {\n        state: { socket: null }\n      };\n      return R.assoc('connection', connection, game);\n    }\n    function gameConnectionOpenP(user_name, game) {\n      if(gameConnectionModel.active(game)) {\n        return R.resolveP(game);\n      }\n      user_name = s.trim(user_name);\n      const action = {\n        close: 'Game.connection.close',\n        chat: 'Game.connection.chat',\n        replayCmd: 'Game.connection.replayCmd',\n        undoCmd: 'Game.connection.undoCmd',\n        cmdBatch: 'Game.connection.batchCmd',\n        setCmds: 'Game.connection.setCmds',\n        players: 'Game.connection.setPlayers'\n      };\n\n      game = R.set(SOCKET_LENS, null, game);\n      let url = [\n        '/api/games',\n        ( R.prop('private_stamp', game)\n          ? 'private'\n          : 'public'\n        ),\n        ( R.prop('private_stamp', game)\n          ? R.prop('private_stamp', game)\n          : R.prop('public_stamp', game)\n        )\n      ].join('/');\n      url += '?name='+user_name;\n\n      return R.threadP()(\n        () => websocketModel\n          .createP(url, 'game', action),\n        R.set(SOCKET_LENS, R.__, game)\n      );\n    }\n    function gameConnectionClose(game) {\n      if(gameConnectionModel.active(game)) {\n        websocketModel.close(game.connection.state.socket);\n      }\n      return gameConnectionModel.cleanup(game);\n    }\n    function gameConnectionCleanup(game) {\n      return R.set(SOCKET_LENS, null, game);\n    }\n    function gameConnectionActive(game) {\n      return R.thread(game)(\n        R.view(SOCKET_LENS),\n        R.exists\n      );\n    }\n    function gameConnectionSendReplayCommand(command, game) {\n      return R.thread(game)(\n        gameConnectionModel.sendEvent$({\n          type: 'replayCmd',\n          cmd: command\n        }),\n        R.over(COMMANDS_LOG_LENS,\n               R.compose(R.append(command), R.defaultTo([])))\n      );\n    }\n    function gameConnectionSendUndoCommand(command, game) {\n      return R.thread(game)(\n        gameConnectionModel.sendEvent$({\n          type: 'undoCmd',\n          cmd: command\n        }),\n        R.over(UNDO_LOG_LENS,\n               R.compose(R.append(command), R.defaultTo([])))\n      );\n    }\n    function gameConnectionSendEvent(event, game) {\n      return R.thread(game)(\n        R.ifElse(\n          gameConnectionModel.active,\n          () => websocketModel\n            .send(event, R.view(SOCKET_LENS, game)),\n          () => appStateService\n            .emit('Error', 'gameConnection', 'sendEvent/not active')\n        ),\n        R.always(game)\n      );\n    }\n  }\n})();\n"]}