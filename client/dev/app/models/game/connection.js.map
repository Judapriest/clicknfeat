{"version":3,"sources":["connection.es6"],"names":[],"mappings":"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","file":"connection.js","sourcesContent":["(function() {\n  angular.module('clickApp.services')\n    .factory('gameConnection', gameConnectionModelFactory);\n\n  gameConnectionModelFactory.$inject = [\n    'websocket',\n    'appState',\n  ];\n  function gameConnectionModelFactory(websocketModel,\n                                      appStateService) {\n    const gameConnectionModel = {\n      create: gameConnectionCreate,\n      openP: gameConnectionOpenP,\n      close: gameConnectionClose,\n      cleanup: gameConnectionCleanup,\n      active: gameConnectionActive,\n      sendReplayCommand: gameConnectionSendReplayCommand,\n      sendUndoCommand: gameConnectionSendUndoCommand,\n      sendEvent: gameConnectionSendEvent\n    };\n    R.curryService(gameConnectionModel);\n    return gameConnectionModel;\n\n    function gameConnectionCreate(game) {\n      const connection = {\n        state: { socket: null }\n      };\n      return R.assoc('connection', connection, game);\n    }\n    function gameConnectionOpenP(user_name, game) {\n      if(gameConnectionModel.active(game)) {\n        return R.resolveP(game);\n      }\n      user_name = s.trim(user_name);\n      const handlers = {\n        close: closeHandler,\n        chat: chatHandler,\n        replayCmd: replayCmdHandler,\n        undoCmd: undoCmdHandler,\n        cmdBatch: cmdBatchHandler,\n        setCmds: setCmdsHandler,\n        players: playersHandler\n      };\n\n      game = R.assocPath(['connection','state','socket'], null, game);\n      let url = [\n        '/api/games',\n        ( R.prop('private_stamp', game)\n          ? 'private'\n          : 'public'\n        ),\n        ( R.prop('private_stamp', game)\n          ? R.prop('private_stamp', game)\n          : R.prop('public_stamp', game)\n        )\n      ].join('/');\n      url += '?name='+user_name;\n\n      return R.threadP()(\n        () => websocketModel\n          .createP(url, 'game', handlers),\n        (socket) => R.assocPath(['connection', 'state', 'socket'],\n                                socket, game)\n      );\n    }\n    function gameConnectionClose(game) {\n      if(gameConnectionModel.active(game)) {\n        websocketModel.close(game.connection.state.socket);\n      }\n      return gameConnectionModel.cleanup(game);\n    }\n    function gameConnectionCleanup(game) {\n      return R.assocPath(['connection','state','socket'], null, game);\n    }\n    function gameConnectionActive(game) {\n      return R.thread(game)(\n        R.path(['connection','state','socket']),\n        R.exists\n      );\n    }\n    function gameConnectionSendReplayCommand(command, game) {\n      return R.threadP(game)(\n        gameConnectionModel.sendEvent$({\n          type: 'replayCmd',\n          cmd: command\n        }),\n        R.over(R.lensProp('commands_log'),\n               R.compose(R.append(command), R.defaultTo([])))\n      );\n    }\n    function gameConnectionSendUndoCommand(command, game) {\n      return R.thread(game)(\n        gameConnectionModel.sendEvent$({\n          type: 'undoCmd',\n          cmd: command\n        }),\n        R.over(R.lensProp('undo_log'),\n               R.compose(R.append(command), R.defaultTo([])))\n      );\n    }\n    function gameConnectionSendEvent(event, game) {\n      return R.thread(game)(\n        R.ifElse(\n          gameConnectionModel.active,\n          () => websocketModel\n            .send(event, game.connection.state.socket),\n          () => appStateService\n            .emit('Error', 'gameConnection', 'sendEvent/not active')\n        ),\n        R.always(game)\n      );\n    }\n    function closeHandler() {\n      appStateService.reduce('Game.connection.close');\n    }\n    function replayCmdHandler(msg) {\n      appStateService.reduce('Game.command.replay', msg.cmd);\n    }\n    function undoCmdHandler(msg) {\n      appStateService.reduce('Game.command.undo', msg.cmd);\n    }\n    function cmdBatchHandler(msg) {\n      appStateService.reduce('Game.command.replayBatch', msg.cmds);\n    }\n    function chatHandler(msg) {\n      appStateService.reduce('Game.newChatMsg', msg);\n    }\n    function setCmdsHandler(msg) {\n      appStateService.reduce('Game.setCmds', msg);\n    }\n    function playersHandler(msg) {\n      appStateService.reduce('Game.setPlayers', msg.players);\n    }\n  }\n})();\n"]}