{"version":3,"sources":["ruler.es6"],"names":[],"mappings":"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","file":"ruler.js","sourcesContent":["(function() {\n  angular.module('clickApp.services')\n    .factory('gameRuler', gameRulerModelFactory);\n\n  gameRulerModelFactory.$inject = [\n    'gameSegment',\n    'point',\n    'model',\n    'gameModels',\n  ];\n  function gameRulerModelFactory(gameSegmentModel,\n                                 pointModel,\n                                 modelModel,\n                                 gameModelsModel) {\n    const base = gameSegmentModel();\n    const gameRulerModel = Object.create(base);\n    R.deepExtend(gameRulerModel, {\n      create: gameRulerCreate,\n      maxLength: gameRulerMaxLength,\n      setMaxLength: gameRulerSetMaxLength,\n      setLocal: gameRulerSetLocal,\n      setRemote: gameRulerSetRemote,\n      origin: gameRulerOrigin,\n      clearOrigin: gameRulerClearOrigin,\n      setOrigin: gameRulerSetOrigin,\n      setOriginResetTarget: gameRulerSetOriginResetTarget,\n      target: gameRulerTarget,\n      targetReached: gameRulerTargetReached,\n      clearTarget: gameRulerClearTarget,\n      setTarget: gameRulerSetTarget,\n      updateOriginTarget: gameRulerUpdateOriginTarget,\n      targetAoEPosition: gameRulerTargetAoEPosition\n    });\n    const enforceEndToMaxLength$ = R.curry(enforceEndToMaxLength);\n    const setupRemoteRuler$ = R.curry(setupRemoteRuler);\n    R.curryService(gameRulerModel);\n    return gameRulerModel;\n\n    function gameRulerCreate() {\n      return R.deepExtend(base.create(), {\n        local: { length: null },\n        remote: { length: null }\n      });\n    }\n    function gameRulerMaxLength(ruler) {\n      return R.pathOr(0, ['remote','max'], ruler);\n    }\n    function gameRulerSetMaxLength(length, state, ruler) {\n      return R.thread(ruler)(\n        R.assocPath(['local', 'max'], length),\n        R.assocPath(['remote', 'max'], length),\n        setupRemoteRuler$(state)\n      );\n    }\n    function gameRulerOrigin(ruler) {\n      return R.path(['remote', 'origin'], ruler);\n    }\n    function gameRulerClearOrigin(state, ruler) {\n      return setOriginTarget({ origin: null },\n                             state, ruler);\n    }\n    function gameRulerSetOrigin(origin_model, state, ruler) {\n      const origin = origin_model.state.stamp;\n      let target = gameRulerModel.target(ruler);\n      target = (target === origin) ? null : target;\n      const max_length = R.defaultTo(R.path(['remote', 'max'], ruler),\n                                     modelModel.rulerMaxLength(origin_model));\n      return setOriginTarget({ origin: origin,\n                               target: target,\n                               max_length: max_length\n                             }, state, ruler);\n    }\n    function gameRulerSetOriginResetTarget(origin_model, state, ruler) {\n      const origin = origin_model.state.stamp;\n      const max_length = R.defaultTo(R.path(['remote', 'max'], ruler),\n                                     modelModel.rulerMaxLength(origin_model));\n      return setOriginTarget({ origin: origin,\n                               target: null,\n                               max_length: max_length\n                             }, state, ruler);\n    }\n    function gameRulerTarget(ruler) {\n      return R.path(['remote', 'target'], ruler);\n    }\n    function gameRulerTargetReached(ruler) {\n      return R.path(['remote', 'reached'], ruler);\n    }\n    function gameRulerClearTarget(state, ruler) {\n      return setOriginTarget({ target: null\n                             }, state, ruler);\n    }\n    function gameRulerSetTarget(target_model, state, ruler) {\n      let origin = gameRulerModel.origin(ruler);\n      const target = target_model.state.stamp;\n      origin = (origin === target) ? null : origin;\n      return setOriginTarget({ origin: origin,\n                               target: target\n                             }, state, ruler);\n    }\n    function gameRulerUpdateOriginTarget(state, ruler) {\n      return setupRemoteRuler(state, ruler);\n    }\n    function gameRulerSetLocal(start, end, ruler) {\n      return R.over(R.lensProp('local'), R.pipe(\n        R.assoc('start', R.clone(start)),\n        enforceEndToMaxLength$(end),\n        R.assoc('length', null),\n        R.assoc('display', true)\n      ), ruler);\n    }\n    function gameRulerSetRemote(start, end, state, ruler) {\n      return R.thread(ruler)(\n        R.over(R.lensProp('local'), R.assoc('display', false)),\n        R.over(R.lensProp('remote'), R.pipe(\n          R.assoc('origin', null),\n          R.assoc('target', null),\n          R.assoc('start', R.clone(start)),\n          R.assoc('end', R.clone(end)),\n          R.assoc('display', true)\n        )),\n        setupRemoteRuler$(state)\n      );\n    }\n    function gameRulerTargetAoEPosition(models, ruler) {\n      const dir = pointModel.directionTo(ruler.remote.end, ruler.remote.start);\n      const max = ruler.remote.length / 2;\n      const end = ruler.remote.end;\n      const target = gameRulerModel.target(ruler);\n      return R.thread(end)(\n        (end) => {\n          if( R.exists(target) &&\n              gameRulerModel.targetReached(ruler) ) {\n            return R.thread(models)(\n              gameModelsModel.findStamp$(target),\n              R.ifElse(\n                R.isNil,\n                R.defaultTo(end),\n                R.prop('state')\n              )\n            );\n          }\n          return end;\n        },\n        R.pick(['x', 'y']),\n        R.assoc('r', dir),\n        R.assoc('m', max)\n      );\n    }\n    function enforceEndToMaxLength(end, ruler) {\n      let length = pointModel.distanceTo(end, ruler.start);\n      const dir = pointModel.directionTo(end, ruler.start);\n      const max = 10 * R.defaultTo(length/10, ruler.max);\n      length = Math.min(length, max);\n      end = pointModel.translateInDirection(length, dir, ruler.start);\n      return R.assoc('end', end, ruler);\n    }\n    function setOriginTarget(update, state, ruler) {\n      const {\n        origin = gameRulerModel.origin(ruler),\n        target = gameRulerModel.target(ruler),\n        max_length = R.path(['remote', 'max'], ruler)\n      } = update;\n      const display = R.exists(origin) && R.exists(target);\n      return R.thread(ruler)(\n        R.over(R.lensProp('remote'), R.pipe(\n          R.assoc('origin', origin),\n          R.assoc('target', target),\n          R.assoc('display', display),\n          R.assoc('max', max_length)\n        )),\n        setupRemoteRuler$(state)\n      );\n    }\n    function setupRemoteRuler(state, ruler) {\n      return R.threadP(ruler)(\n        getOriginModelP,\n        (origin_model) => R.threadP(ruler)(\n          getTargetModelP,\n          (target_model) => getStartEnd(origin_model, target_model)\n        ),\n        ({ start, end }) => {\n          const models_dist = pointModel.distanceTo(end, start);\n          return R.over(R.lensProp('remote'), R.pipe(\n            R.assoc('start', start),\n            enforceEndToMaxLength$(end),\n            (remote) => {\n              const ruler_length = pointModel.distanceTo(remote.end, remote.start);\n              return R.thread(remote)(\n                R.assoc('reached', ruler_length >= models_dist - 0.1),\n                R.assoc('length', Math.round(ruler_length * 10) / 100)\n              );\n            }\n          ), ruler);\n        }\n      );\n\n      function getOriginModelP(ruler) {\n        const origin = R.path(['remote','origin'], ruler);\n        if(R.exists(origin)) {\n          return gameModelsModel\n            .findStamp(origin, state.game.models);\n        }\n        return null;\n      }\n      function getTargetModelP(ruler) {\n        const target = R.path(['remote','target'], ruler);\n        if(R.exists(target)) {\n          return gameModelsModel\n            .findStamp(target, state.game.models);\n        }\n        return null;\n      }\n      function getStartEnd(origin_model, target_model) {\n        if(R.exists(origin_model) &&\n           R.exists(target_model)) {\n          return modelModel\n            .shortestLineTo(state.factions,\n                            target_model,\n                            origin_model);\n        }\n        if(R.exists(origin_model)) {\n          return {\n            start: R.pick(['x','y'], origin_model.state),\n            end: R.pick(['x','y'], origin_model.state)\n          };\n        }\n        if(R.exists(target_model)) {\n          return {\n            start: R.pick(['x','y'], target_model.state),\n            end: R.pick(['x','y'], target_model.state)\n          };\n        }\n        return R.pick(['start', 'end'], R.prop('remote', ruler));\n      }\n    }\n  }\n})();\n"]}