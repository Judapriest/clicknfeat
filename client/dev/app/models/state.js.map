{"version":3,"sources":["state.es6"],"names":[],"mappings":"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","file":"state.js","sourcesContent":["(function() {\n  angular.module('clickApp.services')\n    .factory('state', stateModelFactory);\n\n  stateModelFactory.$inject = [\n    'pubSub',\n    'fileImport',\n    'stateExports',\n    'stateData',\n    'stateUser',\n    'stateGame',\n    'stateGames',\n    'stateModes',\n  ];\n  function stateModelFactory(pubSubService,\n                             fileImportService,\n                             stateExportsService,\n                             stateDataModel,\n                             stateUserModel,\n                             stateGameModel,\n                             stateGamesModel,\n                             stateModesModel) {\n    const stateModel = {\n      create: stateCreate,\n      queueEventP: stateQueueEventP,\n      queueChangeEventP: stateQueueChangeEventP,\n      onChangeEvent: stateOnChangeEvent,\n      onLoadDumpFile: stateOnLoadDumpFile\n    };\n    const exportCurrentDumpFile = stateExportsService\n            .exportP$('dump', buildDumpData);\n    R.curryService(stateModel);\n    return stateModel;\n\n    function stateCreate() {\n      let state = pubSubService.init({\n        event_queue: [],\n        onEvent: onEvent,\n        change: pubSubService.init({}, 'State.Change'),\n        change_event_queue: [],\n        onChangeEvent: onChangeEvent,\n        eventP: eventP,\n        queueEventP: queueEventP,\n        changeEventP: changeEventP,\n        queueChangeEventP: queueChangeEventP\n      }, 'State');\n      state = R.thread(state)(\n        // starting here State is mutable\n        stateDataModel.create,\n        stateUserModel.create,\n        stateGameModel.create,\n        stateGamesModel.create,\n        stateModesModel.create\n      );\n      state.onEvent('State.loadDumpFile',\n                    stateModel.onLoadDumpFile$(state));\n      return state;\n\n      function onEvent(...args) {\n        return pubSubService.subscribe\n          .apply(null, [...args, state]);\n      }\n      function onChangeEvent(...args) {\n        return pubSubService.subscribe\n          .apply(null, [...args, state.change]);\n      }\n      function queueEventP(...args) {\n        return stateQueueEventP(args, state);\n      }\n      function queueChangeEventP(...args) {\n        return stateQueueChangeEventP(args, state);\n      }\n      function eventP(...args) {\n        return stateEventP(args, state);\n      }\n      function changeEventP(...args) {\n        return stateChangeEventP(args, state);\n      }\n    }\n    function stateQueueEventP(args, state) {\n      return new self.Promise((resolve) => {\n        console.info('State ---> Event', args[0], R.tail(args));\n        console.trace();\n        state.event_queue = R.append([\n          resolve, args\n        ], state.event_queue);\n        startEventQueueProcessing(state);\n      });\n    }\n    function startEventQueueProcessing(state) {\n      if(state.processing_event_queue) return;\n      state.processing_event_queue = true;\n      self.Promise.resolve(processNextEventP(state))\n        .then(() => { state.processing_event_queue = false; });\n    }\n    function processNextEventP(state) {\n      if(R.isEmpty(state.event_queue)) {\n        return self.Promise.resolve();\n      }\n\n      const [ resolve, args ] = R.head(state.event_queue);\n      return R.threadP(stateEventP(args, state))(\n        () => { return stateDataModel.save(state); },\n        () => { return stateUserModel.save(state); },\n        () => { return stateGameModel.save(state); },\n        () => { return stateGamesModel.save(state); },\n        () => { return stateModesModel.save(state); },\n        () => { return exportCurrentDumpFile(state); },\n        () => { return processNextChangeEventP(state); }\n      ).catch(R.spyAndDiscardError('processNextEvent'))\n        .then(() => {\n          state.event_queue = R.tail(state.event_queue);\n          resolve();\n          return processNextEventP(state);\n        });\n    }\n    function stateQueueChangeEventP(args, state) {\n      return new self.Promise((resolve) => {\n        console.info('StateChange <---', args[0], R.tail(args));\n        console.trace();\n        state.change_event_queue = R.append([\n          resolve, args\n        ], state.change_event_queue);\n      });\n    }\n    function processNextChangeEventP(state) {\n      if(R.isEmpty(state.change_event_queue)) {\n        return self.Promise.resolve();\n      }\n\n      state.change_event_queue = R.uniqBy(R.compose(R.head, R.nth(1)),\n                                          state.change_event_queue);\n      const [ resolve, args ] = R.head(state.change_event_queue);\n      return R.threadP(stateChangeEventP(args, state))(\n        () => {\n          state.change_event_queue = R.tail(state.change_event_queue);\n          resolve();\n          return processNextChangeEventP(state);\n        }\n      );\n    }\n    function stateEventP(args, state) {\n      console.info('State ===> Event', args[0], R.tail(args));\n      return pubSubService.publishP\n        .apply(null, [...args, state]);\n    }\n    function stateChangeEventP(args, state) {\n      console.info('StateChange <===', R.head(args), R.tail(args));\n      return pubSubService.publishP\n        .apply(null, [...args, state.change]);\n    }\n    function stateOnChangeEvent(event, listener, state) {\n      return pubSubService\n        .subscribe(event, listener, state.change);\n    }\n    function stateOnLoadDumpFile(state, event, file) {\n      return R.threadP(file)(\n        fileImportService.readP$('json'),\n        dispatchData,\n        () => {\n          state.queueChangeEventP('State.loadDumpFile', 'File loaded');\n        }\n      ).catch((error) => {\n        state.queueChangeEventP('State.loadDumpFile', error);\n      });\n\n      function dispatchData(data) {\n        return R.threadP()(\n          () => {\n            return stateDataModel\n              .onSettingsReset(state, event, data.settings);\n          },\n          () => {\n            return stateGamesModel\n              .loadNewLocalGame(state, data.game);\n          }\n        );\n      }\n    }\n    function buildDumpData(state) {\n      return {\n        settings: R.pathOr({}, ['settings','current'], state),\n        game: R.propOr({}, 'game', state)\n      };\n    }\n  }\n})();\n"]}