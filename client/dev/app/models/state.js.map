{"version":3,"sources":["state.es6"],"names":[],"mappings":"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","file":"state.js","sourcesContent":["(function() {\n  angular.module('clickApp.services')\n    .factory('state', stateServiceFactory);\n\n  stateServiceFactory.$inject = [\n    'pubSub',\n    // 'fileImport',\n    // 'stateExports',\n    // 'stateData',\n    'stateUser',\n    // 'stateGame',\n    // 'stateGames',\n    // 'stateModes',\n  ];\n  function stateServiceFactory(pubSubService,\n                               // fileImportService,\n                               // stateExportsService,\n                               // stateDataService,\n                               stateUserService) {\n    // stateGameService,\n    // stateGamesService,\n    // stateModesService\n    // ) {\n    const stateService = {\n      create: stateCreate,\n      queueEventP: stateQueueEventP,\n      onChangeEvent: stateOnChangeEvent,\n      // onLoadDumpFile: stateOnLoadDumpFile\n    };\n    R.curryService(stateService);\n    return stateService;\n\n    function stateCreate() {\n      let state = pubSubService.init({\n        event_queue: [],\n        onEvent: onEvent,\n        change: pubSubService.init({}, 'State.Change'),\n        change_event_queue: [],\n        queueChangeEventP: queueChangeEventP\n      }, 'State');\n\n      state = R.thread(state)(\n        // starting here State is mutable\n        // stateDataService.create,\n        stateUserService.create\n        // stateGameService.create,\n        // stateGamesService.create,\n        // stateModesService.create,\n      );\n\n      // exportCurrentDumpFile(state);\n      return state;\n\n      function onEvent(...args) {\n        return pubSubService.subscribe\n          .apply(null, [...args, state]);\n      }\n      function queueChangeEventP(...args) {\n        return new self.Promise((resolve) => {\n          console.info('StateChange <---', args[0], R.tail(args));\n          state.change_event_queue = R.append([\n            resolve, args\n          ], state.change_event_queue);\n        });\n      }\n      // state.event = (...args) => {\n      //   return stateService.event\n      //     .apply(null, [...args, state]);\n      // };\n      // state.changeEventUnbuffered = (...args) => {\n      //   console.info('State <---[U] ChangeEvent', args[0], R.tail(args));\n      //   return pubSubService.publish\n      //     .apply(null, [...args, state.change]);\n      // };\n    }\n    function stateQueueEventP(args, state) {\n      return new self.Promise((resolve) => {\n        console.info('State ---> Event', args[0], R.tail(args));\n        state.event_queue = R.append([\n          resolve, args\n        ], state.event_queue);\n        startEventQueueProcessing(state);\n      });\n    }\n    function startEventQueueProcessing(state) {\n      if(state.processing_event_queue) return;\n      state.processing_event_queue = true;\n      self.Promise.resolve(processNextEventP(state))\n        .then(() => { state.processing_event_queue = false; });\n    }\n    function processNextEventP(state) {\n      if(R.isEmpty(state.event_queue)) {\n        return self.Promise.resolve();\n      }\n\n      const [ resolve, args ] = R.head(state.event_queue);\n      console.info('State ===> Event', args[0], R.tail(args));\n      return R.threadP(stateEventP(args, state))(\n        // () => { return stateDataService.save(state); },\n        () => { return stateUserService.save(state); },\n        // () => { return stateGameService.save(state); },\n        // () => { return stateGamesService.save(state); },\n        // () => { return stateModesService.save(state); },\n        // () => { return exportCurrentDumpFile(state); },\n        () => { return processNextChangeEventP(state); }\n      ).catch(R.spyAndDiscardError('processNextEvent'))\n        .then(() => {\n          state.event_queue = R.tail(state.event_queue);\n          resolve();\n          return processNextEventP(state);\n        });\n    }\n    function processNextChangeEventP(state) {\n      if(R.isEmpty(state.change_event_queue)) {\n        return self.Promise.resolve();\n      }\n\n      state.change_event_queue = R.uniqBy(R.compose(R.head, R.nth(1)),\n                                          state.change_event_queue);\n      let [ resolve, args ] = R.head(state.change_event_queue);\n      console.log('StateChange <===', R.head(args), R.tail(args));\n      return R.threadP(stateChangeEventP(args, state))(\n        () => {\n          state.change_event_queue = R.tail(state.change_event_queue);\n          resolve();\n          return processNextChangeEventP(state);\n        }\n      );\n    }\n    function stateEventP(args, state) {\n      return pubSubService.publishP\n        .apply(null, [...args, state]);\n    }\n    function stateChangeEventP(args, state) {\n      return pubSubService.publishP\n        .apply(null, [...args, state.change]);\n    }\n    function stateOnChangeEvent(event, listener, state) {\n      return pubSubService\n        .subscribe(event, listener, state.change);\n    }\n    function stateOnLoadDumpFile(state, event, file) {\n        // return R.pipeP(\n        //   fileImportService.read$('json'),\n        //   (data) => {\n        //     return R.pipeP(\n        //       () => {\n        //         return stateDataService\n        //           .onSettingsReset(state, event, data.settings);\n        //       },\n        //       () => {\n        //         return stateGamesService\n        //           .loadNewLocalGame(state, data.game);\n        //       },\n        //       () => {\n        //         state.changeEvent('State.loadDumpFile', 'File loaded');\n        //       }\n        //     )();\n        //   }\n        // )(file).catch((error) => {\n        //   state.changeEvent('State.loadDumpFile', error);\n        // });\n    }\n    // const exportCurrentDumpFile = stateExportsService\n    //         .export$('dump', (state) => {\n    //           return { settings: R.pathOr({}, ['settings','current'], state),\n    //                    game: R.propOr({}, 'game', state)\n    //                  };\n    //         });\n  }\n})();\n"]}