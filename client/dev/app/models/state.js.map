{"version":3,"sources":["state.es6"],"names":[],"mappings":"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","file":"state.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('state', [\n    'pubSub',\n    'fileImport',\n    'stateExports',\n    'stateData',\n    'stateUser',\n    'stateGame',\n    'stateGames',\n    'stateModes',\n    function stateServiceFactory(pubSubService,\n                                 fileImportService,\n                                 stateExportsService,\n                                 stateDataService,\n                                 stateUserService,\n                                 stateGameService,\n                                 stateGamesService,\n                                 stateModesService) {\n      var stateService = {\n        init: function stateInit() {\n          let state = pubSubService.init({}, 'State');\n          state.processing = false;\n          state.change_queue = [];\n\n          state.event = (...args) => {\n            return stateService.event\n              .apply(null, [...args, state]);\n          };\n          state.onEvent = (...args) => {\n            return pubSubService.subscribe\n              .apply(null, [...args, state]);\n          };\n\n          state.change = pubSubService.init({}, 'State.Change');\n          state.changeEvent = (...args) => {\n            if(state.processing) {\n              console.info('State <--- ChangeEvent', args[0], R.tail(args));\n              state.change_queue = R.append(args, state.change_queue);\n              return self.Promise.resolve();\n            }\n            console.info('State <=== ChangeEvent', args[0], R.tail(args));\n            return pubSubService.publish\n              .apply(null, [...args, state.change]);\n          };\n          state.changeEventUnbuffered = (...args) => {\n            console.info('State <---[U] ChangeEvent', args[0], R.tail(args));\n            return pubSubService.publish\n              .apply(null, [...args, state.change]);\n          };\n\n          state = stateDataService.init(state);\n          state = stateUserService.init(state);\n          state = stateGameService.init(state);\n          state = stateGamesService.init(state);\n          state = stateModesService.init(state);\n\n          exportCurrentDumpFile(state);\n          return state;\n        },\n        event: function stateEvent(...args) {\n          let state = R.last(args);\n          let processing = state.processing;\n          state.processing = true;\n          console.info('State ---> Event', args[0], R.init(R.tail(args)));\n          // console.trace();\n          return R.pipeP(\n            () => {\n              return pubSubService.publish\n                .apply(null, args);\n            },\n            () => {\n              if(processing) return self.Promise.reject();\n              else return null;\n            },\n            () => { return stateDataService.save(state); },\n            () => { return stateUserService.save(state); },\n            () => { return stateGameService.save(state); },\n            () => { return stateGamesService.save(state); },\n            () => { return stateModesService.save(state); },\n            () => { return exportCurrentDumpFile(state); },\n            () => { state.processing = processing; },\n            () => {\n              // console.log(state.change_queue);\n              state.change_queue = R.uniq(state.change_queue);\n              return (function dispatchChange(queue) {\n                if(R.isEmpty(queue)) return null;\n                let args = R.head(queue);\n                console.log('State: change queue <===', R.head(args));\n                return pubSubService.publish\n                  .apply(null, [...args, state.change])\n                  .then(() => {\n                    return dispatchChange(R.tail(queue));\n                  });\n              })(state.change_queue);\n            },\n            () => { state.change_queue = []; }\n          )().catch(R.always(null))\n            .then(() => { state.processing = processing; });\n        },\n        onChangeEvent: function stateOnChangeEvent(event, listener, state) {\n          return pubSubService.subscribe(event, listener, state.change);\n        },\n        onLoadDumpFile: function stateOnLoadDumpFile(state, event, file) {\n          return R.pipeP(\n            fileImportService.read$('json'),\n            (data) => {\n              return R.pipeP(\n                () => {\n                  return stateDataService\n                    .onSettingsReset(state, event, data.settings);\n                },\n                () => {\n                  return stateGamesService\n                    .loadNewLocalGame(state, data.game);\n                },\n                () => {\n                  state.changeEvent('State.loadDumpFile', 'File loaded');\n                }\n              )();\n            }\n          )(file).catch((error) => {\n            state.changeEvent('State.loadDumpFile', error);\n          });\n        }\n      };\n      var exportCurrentDumpFile = stateExportsService\n            .export$('dump', (state) => {\n              return { settings: R.pathOr({}, ['settings','current'], state),\n                       game: R.propOr({}, 'game', state)\n                     };\n            });\n      R.curryService(stateService);\n      return stateService;\n    }\n  ]);\n"]}