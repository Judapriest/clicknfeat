{"version":3,"sources":["ruler.es6"],"names":[],"mappings":"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","file":"ruler.js","sourcesContent":["(function() {\n  angular.module('clickApp.services')\n    .factory('rulerMode', rulerModeModelFactory);\n\n  rulerModeModelFactory.$inject = [\n    'appState',\n    'segmentMode',\n    'gameRuler',\n    'prompt',\n  ];\n  function rulerModeModelFactory(appStateService,\n                                 segmentModeModel,\n                                 gameRulerModel,\n                                 promptModel) {\n    const ruler_default_bindings = {\n      exitRulerMode: 'ctrl+r',\n      setMaxLength: 'shift+r',\n      setOriginModel: 'ctrl+clickModel',\n      setTargetModel: 'shift+clickModel',\n      createAoEOnTarget: 'ctrl+a'\n    };\n\n    const ruler_mode =\n            segmentModeModel('ruler', gameRulerModel, ruler_default_bindings);\n    ruler_mode.actions.setOriginModel = rulerSetOriginModel;\n    ruler_mode.actions.setTargetModel = rulerSetTargetModel;\n    ruler_mode.actions.setMaxLength = rulerSetMaxLength;\n    ruler_mode.actions.createAoEOnTarget = rulerCreateAoEOnTarget;\n\n    ruler_mode.buttons = R.concat(ruler_mode.buttons, [\n      [ 'Set Max Len.', 'setMaxLength' ],\n      [ 'AoE on Target', 'createAoEOnTarget' ],\n    ]);\n    const baseOnEnter = ruler_mode.onEnter;\n    ruler_mode.onEnter = rulerOnEnter;\n\n    return ruler_mode;\n\n    function rulerSetOriginModel(state, event) {\n      appStateService\n        .chainReduce('Game.command.execute',\n                     'setRuler', [\n                       'setOrigin',\n                       [event['click#'].target, state]\n                     ]);\n    }\n    function rulerSetTargetModel(state, event) {\n      appStateService\n        .chainReduce('Game.command.execute',\n                     'setRuler', [\n                       'setTarget',\n                       [event['click#'].target, state]\n                     ]);\n    }\n    function rulerSetMaxLength(state) {\n      return R.threadP()(\n        () => promptModel\n          .promptP('prompt', 'Set ruler max length :',\n                   gameRulerModel.maxLength(state.game.ruler))\n          .catch(R.always(null)),\n        (value) => (value === 0) ? null : value,\n        (value) => R.threadP()(\n          () => {\n            appStateService\n              .chainReduce('Game.command.execute',\n                           'setRuler', [\n                             'setMaxLength', [value, state]\n                           ]);\n          },\n          () => {\n            const origin = gameRulerModel.origin(state.game.ruler);\n            if(R.isNil(origin)) return;\n\n            appStateService\n              .chainReduce('Game.command.execute',\n                           'onModels', [\n                             'setRulerMaxLength',\n                             [value],\n                             [origin]\n                           ]);\n          }\n        )\n      );\n    }\n    function rulerCreateAoEOnTarget(state) {\n      R.thread(state.game.ruler)(\n        gameRulerModel.targetAoEPosition$(state.game.models),\n        (position) => ({\n          base: { x: 0, y: 0, r: 0 },\n          templates: [ R.assoc('type', 'aoe', position) ]\n        }),\n        (create) => {\n          appStateService\n            .chainReduce('Game.command.execute',\n                         'createTemplate', [\n                           create, false\n                         ]);\n        }\n      );\n    }\n    function rulerOnEnter() {\n      const state = appStateService.current();\n      return R.threadP()(\n        () => baseOnEnter(state),\n        () => updateMaxLengthButton(state)\n      );\n    }\n    function updateMaxLengthButton(state) {\n      const max = gameRulerModel.maxLength(state.game.ruler);\n      ruler_mode.buttons[0][0] = `Set Max Len. (${max})`;\n      appStateService.emit('Modes.buttons.update');\n    }\n  }\n})();\n"]}