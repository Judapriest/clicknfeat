{"version":3,"sources":["element.es6"],"names":[],"mappings":"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","file":"element.js","sourcesContent":["(function() {\n  angular.module('clickApp.services')\n    .factory('elementMode', elementModeModelFactory);\n\n  elementModeModelFactory.$inject = [\n    'appState',\n    'defaultMode',\n  ];\n  function elementModeModelFactory(appStateService,\n                                   defaultModeModel) {\n    return function buildElementModeModel(type,\n                                          elementModel,\n                                          gameElementsModel,\n                                          gameElementSelectionModel) {\n      const ELEMENTS_LENS = R.lensPath(['game',`${type}s`]);\n      const SELECTION_LENS = R.lensPath(['game',`${type}_selection`]);\n\n      const element_actions = Object.create(defaultModeModel.actions);\n      element_actions.modeBackToDefault = clearElementSelection;\n      element_actions.clickMap = clearElementSelection;\n      element_actions.rightClickMap = clearElementSelection;\n      element_actions.copySelection = copySelection;\n      element_actions.delete = doDelete;\n      element_actions.toggleLock = toggleLock;\n\n      const moves = [\n        ['moveFront', 'up'],\n        ['moveBack', 'down'],\n        ['rotateLeft', 'left'],\n        ['rotateRight', 'right'],\n      ];\n      R.forEach(buildMove, moves);\n      const shifts = [\n        ['shiftUp', 'ctrl+up', 'shiftDown'],\n        ['shiftDown', 'ctrl+down', 'shiftUp'],\n        ['shiftLeft', 'ctrl+left', 'shiftRight'],\n        ['shiftRight', 'ctrl+right', 'shiftLeft'],\n      ];\n      R.forEach(buildShift, shifts);\n      buildDrag();\n\n      const element_default_bindings = {\n        'clickMap': 'clickMap',\n        'rightClickMap': 'rightClickMap',\n        'copySelection': 'ctrl+c',\n        'delete': 'del',\n        'toggleLock': 'l'\n      };\n      R.forEach(buildMoveBindings, moves);\n      R.forEach(buildShiftBindings, shifts);\n      const element_bindings = R.extend(Object.create(defaultModeModel.bindings),\n                                        element_default_bindings);\n      const element_buttons = [\n        [ 'Delete', 'delete' ],\n        [ 'Lock/Unlock', 'toggleLock' ],\n      ];\n      const element_mode = {\n        onEnter: () => { },\n        onLeave: () => { },\n        name: s.capitalize(type),\n        actions: element_actions,\n        buttons: element_buttons,\n        bindings: element_bindings\n      };\n\n      return element_mode;\n\n      function clearElementSelection(state) {\n        // appStateService.emit('Game.selectionDetail.close');\n        // appStateService.emit('Game.editDamage.close');\n        // appStateService.emit('Game.editLabel.close');\n        return R.over(\n          SELECTION_LENS,\n          gameElementSelectionModel.clear$('local'),\n          state\n        );\n      }\n      function copySelection(state) {\n        const stamps = R.thread(state)(\n          R.view(SELECTION_LENS),\n          gameElementSelectionModel.get$('local')\n        );\n        return R.thread(state)(\n          R.view(ELEMENTS_LENS),\n          gameElementsModel.copyStamps$(stamps),\n          R.assoc('create', R.__, state),\n          R.tap(() => {\n            appStateService\n              .chainReduce('Modes.switchTo', `Create${s.capitalize(type)}`);\n          })\n        );\n      }\n      function doDelete(state) {\n        const stamps = R.thread(state)(\n          R.view(SELECTION_LENS),\n          gameElementSelectionModel.get$('local')\n        );\n        appStateService.chainReduce('Game.command.execute',\n                                    `delete${s.capitalize(type)}`,\n                                    [stamps]);\n      }\n      function toggleLock(state) {\n        const stamps = R.thread(state)(\n          R.view(SELECTION_LENS),\n          gameElementSelectionModel.get$('local')\n        );\n        return R.thread(state)(\n          R.view(ELEMENTS_LENS),\n          gameElementsModel.findStamp$(stamps[0]),\n          R.when(\n            R.exists,\n            (element) => {\n              const is_locked = elementModel.isLocked(element);\n              appStateService.chainReduce('Game.command.execute',\n                                          `lock${s.capitalize(type)}s`,\n                                          [!is_locked, stamps]);\n            }\n          )\n        );\n      }\n      function buildMove([move]) {\n        element_actions[move] = (state) => {\n          const stamps = R.thread(state)(\n            R.view(SELECTION_LENS),\n            gameElementSelectionModel.get$('local')\n          );\n          appStateService.chainReduce('Game.command.execute',\n                                      `on${s.capitalize(type)}s`,\n                                      [ `${move}P`, [false], stamps ]);\n        };\n        element_actions[move+'Small'] = (state) => {\n          const stamps = R.thread(state)(\n            R.view(SELECTION_LENS),\n            gameElementSelectionModel.get$('local')\n          );\n          appStateService.chainReduce('Game.command.execute',\n                                      `on${s.capitalize(type)}s`,\n                                      [ `${move}P`, [true], stamps ]);\n        };\n      }\n      function buildShift([shift, _key_, flip_shift]) {\n        element_actions[shift] = (state) => {\n          const stamps = R.thread(state)(\n            R.view(SELECTION_LENS),\n            gameElementSelectionModel.get$('local')\n          );\n          const element_shift = ( R.path(['ui_state', 'flip_map'], state)\n                                  ? flip_shift\n                                  : shift\n                                );\n          appStateService.chainReduce('Game.command.execute',\n                                      `on${s.capitalize(type)}s`,\n                                      [ `${element_shift}P`, [false], stamps ]);\n        };\n        element_actions[shift+'Small'] = (state) => {\n          const stamps = R.thread(state)(\n            R.view(SELECTION_LENS),\n            gameElementSelectionModel.get$('local')\n          );\n          const element_shift = ( R.path(['ui_state', 'flip_map'], state)\n                                  ? flip_shift\n                                  : shift\n                                );\n          appStateService.chainReduce('Game.command.execute',\n                                      `on${s.capitalize(type)}s`,\n                                      [ `${element_shift}P`, [true], stamps ]);\n        };\n      }\n\n      function buildDrag() {\n        element_actions[`dragStart${s.capitalize(type)}`] = dragStartElement;\n        defaultModeModel\n          .actions[`dragStart${s.capitalize(type)}`] = dragStartElement;\n        element_actions[`drag${s.capitalize(type)}`] = dragElement;\n        element_actions[`dragEnd${s.capitalize(type)}`] = dragEndElement;\n\n        let drag_element_start_state;\n        function dragStartElement(state, event) {\n          const element = event.target;\n          if(elementModel.isLocked(element)) {\n            return R.rejectP(`${s.capitalize(type)} is locked`);\n          }\n          drag_element_start_state = R.clone(event.target.state);\n          updateStateWithDelta(event, event.target.state);\n          return R.over(\n            SELECTION_LENS,\n            gameElementSelectionModel\n              .set$('local', [event.target.state.stamp]),\n            state\n          );\n        }\n        function dragElement(_state_, event) {\n          return R.threadP(event.target)(\n            R.rejectIfP(elementModel.isLocked, `${s.capitalize(type)} is locked`),\n            () => {\n              updateStateWithDelta(event, event.target.state);\n              appStateService.emit(`Game.${type}.change.${event.target.state.stamp}`);\n            }\n          );\n        }\n        function dragEndElement(_state_, event) {\n          return R.threadP(event.target)(\n            R.rejectIfP(elementModel.isLocked, `${s.capitalize(type)} is locked`),\n            () => {\n              event.target.state = R.clone(drag_element_start_state);\n              const end_state = R.clone(drag_element_start_state);\n              updateStateWithDelta(event, end_state);\n              appStateService.chainReduce('Game.command.execute',\n                                          `on${s.capitalize(type)}s`,\n                                          [ 'setPositionP',\n                                            [end_state],\n                                            [event.target.state.stamp]\n                                          ]);\n            }\n          );\n        }\n        function updateStateWithDelta(event, state) {\n          const dx = event.now.x - event.start.x;\n          const dy = event.now.y - event.start.y;\n          state.x = drag_element_start_state.x + dx;\n          state.y = drag_element_start_state.y + dy;\n        }\n      }\n\n      function buildMoveBindings([move, keys]) {\n        element_default_bindings[move] = keys;\n        element_default_bindings[move+'Small'] = 'shift+'+keys;\n      }\n      function buildShiftBindings([shift, keys]) {\n        element_default_bindings[shift] = keys;\n        element_default_bindings[shift+'Small'] = 'shift+'+keys;\n      }\n    };\n  }\n})();\n"]}