{"version":3,"sources":["template.es6"],"names":[],"mappings":"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","file":"template.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('templateMode', [\n    'modes',\n    'settings',\n    'defaultMode',\n    'template',\n    'game',\n    'gameTemplates',\n    'gameTemplateSelection',\n    function templateModeServiceFactory(modesService,\n                                        settingsService,\n                                        defaultModeService,\n                                        templateService,\n                                        gameService,\n                                        gameTemplatesService,\n                                        gameTemplateSelectionService) {\n      let template_actions = Object.create(defaultModeService.actions);\n      function clearTemplateSelection(state) {\n        return state.event('Game.update', R.lensProp('template_selection'),\n                           gameTemplateSelectionService.clear$('local', state));\n      }\n      template_actions.modeBackToDefault = clearTemplateSelection;\n      template_actions.clickMap = clearTemplateSelection;\n      template_actions.rightClickMap = clearTemplateSelection;\n      template_actions.delete = (state) => {\n        let stamps = gameTemplateSelectionService\n              .get('local', state.game.template_selection);\n        return state.event('Game.command.execute',\n                           'deleteTemplates', [stamps]);\n      };\n      template_actions.toggleLock = (state) => {\n        let stamps = gameTemplateSelectionService\n              .get('local', state.game.template_selection);\n        return R.pipeP(\n          () => {\n            return gameTemplatesService\n              .findStamp(stamps[0], state.game.templates);\n          },\n          (template) => {\n            let is_locked = templateService.isLocked(template);\n        \n            return state.event('Game.command.execute',\n                               'lockTemplates', [!is_locked, stamps]);\n          }\n        )();\n      };\n      let moves = [\n        ['moveFront', 'up'],\n        ['moveBack', 'down'],\n        ['rotateLeft', 'left'],\n        ['rotateRight', 'right'],\n      ];\n      R.forEach(([move]) => {\n        template_actions[move] = (state) => {\n          let stamps = gameTemplateSelectionService\n                .get('local', state.game.template_selection);\n          return state.event('Game.command.execute',\n                             'onTemplates', [ move, [false], stamps ]);\n        };\n        template_actions[move+'Small'] = (state) => {\n          let stamps = gameTemplateSelectionService\n                .get('local', state.game.template_selection);\n          return state.event('Game.command.execute',\n                             'onTemplates', [ move, [true], stamps ]);\n        };\n      }, moves);\n      let shifts = [\n        ['shiftUp', 'ctrl+up', 'shiftDown'],\n        ['shiftDown', 'ctrl+down', 'shiftUp'],\n        ['shiftLeft', 'ctrl+left', 'shiftRight'],\n        ['shiftRight', 'ctrl+right', 'shiftLeft'],\n      ];\n      R.forEach(([shift, key, flip_shift]) => {\n        key = key;\n        template_actions[shift] = (state) => {\n          let stamps = gameTemplateSelectionService\n                .get('local', state.game.template_selection);\n          let template_shift = ( R.path(['ui_state', 'flip_map'], state) ?\n                                 flip_shift :\n                                 shift\n                               );\n          return state.event('Game.command.execute',\n                             'onTemplates', [ template_shift, [false], stamps ]);\n        };\n        template_actions[shift+'Small'] = (state) => {\n          let stamps = gameTemplateSelectionService\n                .get('local', state.game.template_selection);\n          let template_shift = ( R.path(['ui_state', 'flip_map'], state) ?\n                                 flip_shift :\n                                 shift\n                               );\n          return state.event('Game.command.execute',\n                             'onTemplates', [ template_shift, [true], stamps ]);\n        };\n      }, shifts);\n\n      (() => {\n        let drag_template_start_state;\n        function updateStateWithDelta(event, state) {\n          let dx = event.now.x - event.start.x;\n          let dy = event.now.y - event.start.y;\n          state.x = drag_template_start_state.x + dx;\n          state.y = drag_template_start_state.y + dy;\n        }\n        template_actions.dragStartTemplate = (state, event) => {\n          if(templateService.isLocked(event.target)) {\n            return self.Promise.reject('Template is locked');\n          }\n          \n          drag_template_start_state = R.clone(event.target.state);\n          template_actions.dragTemplate(state, event);\n          return state\n            .event('Game.update', R.lensProp('template_selection'),\n                   gameTemplateSelectionService.set$('local', [event.target.state.stamp], state));\n        };\n        defaultModeService.actions.dragStartTemplate = template_actions.dragStartTemplate;\n        template_actions.dragTemplate = (state, event) => {\n          if(templateService.isLocked(event.target)) {\n            return self.Promise.reject('Template is locked');\n          }\n          \n          updateStateWithDelta(event, event.target.state);\n          state.changeEvent(`Game.template.change.${event.target.state.stamp}`);\n          return null;\n        };\n        template_actions.dragEndTemplate = (state, event) => {\n          if(templateService.isLocked(event.target)) {\n            return self.Promise.reject('Template is locked');\n          }\n\n          event.target.state.x = drag_template_start_state.x;\n          event.target.state.y = drag_template_start_state.y;\n\n          let end_state = R.clone(drag_template_start_state);\n          updateStateWithDelta(event, end_state);\n\n          return state.event('Game.command.execute',\n                             'onTemplates', [ 'setPosition',\n                                              [end_state],\n                                              [event.target.state.stamp]\n                                            ]);\n        };\n      })();\n\n      let template_default_bindings = {\n        'clickMap': 'clickMap',\n        'rightClickMap': 'rightClickMap',\n        'delete': 'del',\n        'toggleLock': 'l'\n      };\n      R.forEach(([move, key]) => {\n        template_default_bindings[move] = key;\n        template_default_bindings[move+'Small'] = 'shift+'+key;\n      }, moves);\n      R.forEach(([shift, key]) => {\n        template_default_bindings[shift] = key;\n        template_default_bindings[shift+'Small'] = 'shift+'+key;\n      }, shifts);\n      let template_bindings = R.extend(Object.create(defaultModeService.bindings),\n                                       template_default_bindings);\n      let template_buttons = [\n        [ 'Delete', 'delete' ],\n        [ 'Lock/Unlock', 'toggleLock' ],\n      ];\n      let template_mode = {\n        onEnter: () => { },\n        onLeave: () => { },\n        name: 'Template',\n        actions: template_actions,\n        buttons: template_buttons,\n        bindings: template_bindings\n      };\n      // modesService.registerMode(template_mode);\n      settingsService.register('Bindings',\n                               template_mode.name,\n                               template_default_bindings,\n                               (bs) => {\n                                 R.extend(template_mode.bindings, bs);\n                               });\n      return template_mode;\n    }\n  ]);\n"]}