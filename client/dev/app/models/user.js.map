{"version":3,"sources":["user.es6"],"names":[],"mappings":"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","file":"user.js","sourcesContent":["(function() {\n  angular.module('clickApp.models')\n    .factory('user', userModelFactory);\n\n  userModelFactory.$inject = [\n    'http',\n    'localStorage',\n    'userConnection',\n  ];\n  function userModelFactory(httpService,\n                            localStorageService,\n                            userConnectionModel) {\n    const STORAGE_KEY = 'clickApp.user';\n    const userModel = {\n      isValid: userIsValid,\n      save: userSave,\n      loadP: userLoadP,\n      initP: userInitP,\n      description: userDescription,\n      stateDescription: userStateDescription,\n      online: userOnline,\n      toggleOnlineP: userToggleOnlineP,\n      checkOnlineP: userCheckOnlineP\n    };\n\n    R.curryService(userModel);\n    return userModel;\n\n    function userIsValid(user) {\n      return ( R.propEq('init', false, user) || R.thread(user)(\n        R.pathOr('', ['state','name']),\n        s.trim,\n        R.length,\n        R.lt(0)\n      ) );\n    }\n    function userSave(user) {\n      return R.thread(user)(\n        R.prop('state'),\n        R.spyWarn('User save'),\n        localStorageService.save$(STORAGE_KEY),\n        R.always(user)\n      );\n    }\n    function userLoadP() {\n      return R.threadP(STORAGE_KEY)(\n        localStorageService.loadP,\n        R.defaultTo({}),\n        R.spyWarn('User load'),\n        (state) => ({ state: state }),\n        userConnectionModel.init\n      );\n    }\n    function userInitP() {\n      return R.threadP()(\n        userLoadP,\n        userModel.checkOnlineP\n      );\n    }\n    function userDescription(user) {\n      return R.thread(user)(\n        R.prop('state'),\n        R.ifElse(\n          R.compose(R.equals('Object'), R.type),\n          userModel.stateDescription,\n          R.always('')\n        )\n      );\n    }\n    function userStateDescription({ name,\n                                    language,\n                                    chat,\n                                    faction,\n                                    game_size,\n                                    ck_position\n                                  } = {}) {\n      let ret = '';\n      if(R.exists(name)) {\n        ret += s(name).trim().capitalize().value();\n      }\n      const lang_chat = [];\n      if(R.exists(language)) {\n        lang_chat.push(s(language).trim().value());\n      }\n      if(R.exists(chat)) {\n        lang_chat.push(s(chat).trim().value());\n      }\n      if(!R.isEmpty(lang_chat)) {\n        ret += ' ['+lang_chat.join(' ')+']';\n      }\n      if(R.exists(faction) &&\n         !R.isEmpty(faction)) {\n        ret += ' - '+R.map(s.capitalize, faction).join(',');\n      }\n      if(R.exists(game_size)) {\n        ret += '['+s.trim(game_size)+'pts]';\n      }\n      if(R.exists(ck_position) &&\n         !R.isEmpty(ck_position)) {\n        ret += ' - likes '+ck_position.join(',');\n      }\n      return ret;\n    }\n    function userOnline(user) {\n      return R.path(['state','online'], user);\n    }\n    function userToggleOnlineP(user) {\n      return ( userModel.online(user)\n               ? userGoOffline(user)\n               : userGoOnlineP(user)\n             );\n    }\n    function userCheckOnlineP(user) {\n      return R.threadP(user)(\n        R.rejectIfP(R.complement(userModel.online),\n                   'No online flag'),\n        (user) => userUpdateOnlineP(user)\n          .catch(() => userCreateOnlineP(user)),\n        userOnlineStartP\n      ).catch((reason) => {\n        console.error('User: checkOnline error', reason);\n        return userOnlineStop(user);\n      });\n    }\n    function userGoOnlineP(user) {\n      return R.threadP(user)(\n        R.assocPath(['state','online'], true),\n        userModel.checkOnlineP\n      );\n    }\n    function userGoOffline(user) {\n      return userOnlineStop(user);\n    }\n    function userCreateOnlineP(user) {\n      return R.threadP(user)(\n        R.prop('state'),\n        httpService.postP$('/api/users'),\n        (state) => R.assoc('state', state, user)\n      );\n    }\n    function userUpdateOnlineP(user) {\n      return R.threadP(user)(\n        R.rejectIfP(R.compose(R.isNil, R.path(['state','stamp'])),\n                   'No valid stamp'),\n        R.prop('state'),\n        httpService.putP$('/api/users/'+user.state.stamp),\n        (state) => R.assoc('state', state, user)\n      );\n    }\n    function userOnlineStartP(user) {\n      return R.threadP(user)(\n        userConnectionModel.openP,\n        R.assocPath(['state','online'], true)\n      );\n    }\n    function userOnlineStop(user) {\n      return R.thread(user)(\n        R.assocPath(['state','online'], false),\n        userConnectionModel.close\n      );\n    }\n  }\n})();\n"]}