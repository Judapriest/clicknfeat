{"version":3,"sources":["user.es6"],"names":[],"mappings":"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","file":"user.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('user', [\n    'http',\n    'localStorage',\n    'userConnection',\n    function userServiceFactory(httpService,\n                                localStorageService,\n                                userConnectionService) {\n      var STORAGE_KEY = 'clickApp.user';\n      var userService = {\n        isValid: function(user) {\n          return R.pipe(\n            R.pathOr('', ['state','name']),\n            s.trim,\n            R.length,\n            R.lt(0)\n          )(user);\n        },\n        save: function userSave(user) {\n          return R.pipePromise(\n            R.prop('state'),\n            R.spyWarn('User save'),\n            localStorageService.save$(STORAGE_KEY),\n            R.always(user)\n          )(user);\n        },\n        load: function userLoad() {\n          return R.pipeP(\n            () => {\n              return localStorageService\n                .load(STORAGE_KEY);\n            },\n            R.spyWarn('User load'),\n            (state) => {\n              return { state: state };\n            },\n            userConnectionService.init\n          )();\n        },\n        init: function userInit(state) {\n          return R.pipeP(\n            userService.load,\n            userService.checkOnline$(state)\n          )();\n        },\n        description: function userDescription(user) {\n          if(R.type(R.prop('state', user)) !== 'Object') return '';\n\n          return userService.stateDescription(user.state);\n        },\n        stateDescription: function userStateDescription({ name,\n                                                          language,\n                                                          chat,\n                                                          faction,\n                                                          game_size,\n                                                          ck_position\n                                                        } = {}) {\n          var ret = '';\n          if(R.exists(name)) {\n            ret += s(name).trim().capitalize().value();\n          }\n          var lang_chat = [];\n          if(R.exists(language)) {\n            lang_chat.push(s(language).trim().value());\n          }\n          if(R.exists(chat)) {\n            lang_chat.push(s(chat).trim().value());\n          }\n          if(!R.isEmpty(lang_chat)) {\n            ret += '['+lang_chat.join(' ')+']';\n          }\n          if(R.exists(faction) &&\n             !R.isEmpty(faction)) {\n            ret += ' - '+R.map(s.capitalize, faction).join(',');\n          }\n          if(R.exists(game_size)) {\n            ret += '['+s.trim(game_size)+'pts]';\n          }\n          if(R.exists(ck_position) &&\n             !R.isEmpty(ck_position)) {\n            ret += ' - likes '+ck_position.join(',');\n          }\n          return ret;\n        },\n        online: function userOnline(user) {\n          return R.path(['state','online'], user);\n        },\n        toggleOnline: function userToggleOnline(state, user) {\n          return ( userService.online(user) ?\n                   userGoOffline(user) :\n                   userGoOnline(state, user)\n                 );\n        },\n        checkOnline: function userCheckOnline(state, user) {\n          return R.pipePromise(\n            (user) => {\n              if(!userService.online(user)) {\n                return self.Promise.reject('No online flag');\n              }\n              return user;\n            },\n            (user) => {\n              return userUpdateOnline(user)\n                .catch(() => {\n                  return userCreateOnline(user);\n                });\n            },\n            userOnlineStart$(state)\n          )(user)\n            .catch((reason) => {\n              console.error('User: checkOnline error', reason);\n              return userOnlineStop(user);\n            });\n        }\n      };\n      function userGoOnline(state, user) {\n        return R.pipePromise(\n          R.assocPath(['state','online'], true),\n          userService.checkOnline$(state)\n        )(user);\n      }\n      function userGoOffline(user) {\n        return userOnlineStop(user);\n      }\n      function userCreateOnline(user) {\n        return R.pipePromise(\n          R.prop('state'),\n          httpService.post$('/api/users'),\n          (state) => {\n            return R.assoc('state', state, user);\n          }\n        )(user);\n      }\n      function userUpdateOnline(user) {\n        if(R.isNil(user.state.stamp)) {\n          return self.Promise.reject('No valid stamp');\n        }\n\n        return R.pipePromise(\n          R.prop('state'),\n          httpService.put$('/api/users/'+user.state.stamp),\n          (state) => {\n            return R.assoc('state', state, user);\n          }\n        )(user);\n      }\n      var userOnlineStart$ = R.curry((state, user) => {\n        return R.pipePromise(\n          userConnectionService.open$(state),\n          R.assocPath(['state','online'], true)\n        )(user);\n      });\n      function userOnlineStop(user) {\n        return R.pipePromise(\n          R.assocPath(['state','online'], false),\n          R.assocPath(['state','stamp'], null),\n          userConnectionService.close\n        )(user);\n      }\n      R.curryService(userService);\n      return userService;\n    }\n  ]);\n"]}