{"version":3,"sources":["connection.es6"],"names":[],"mappings":";;AAAA,QAAQ,MAAR,CAAe,mBAAf,EACG,OADH,CACW,gBADX,EAC6B,CACzB,MADyB,EAEzB,QAFyB,EAGzB,WAHyB,EAIzB,SAAS,4BAAT,CAAsC,WAAtC,EACsC,aADtC,EAEsC,gBAFtC,EAEwD;AACtD,MAAI,wBAAwB;AAC1B,UAAM,SAAS,kBAAT,CAA4B,IAA5B,EAAkC;AACtC,UAAI,aAAa;AACf,eAAO,EAAE,QAAQ,IAAR,EAAT;OADE,CADkC;AAItC,aAAO,EAAE,KAAF,CAAQ,YAAR,EAAsB,UAAtB,EAAkC,IAAlC,CAAP,CAJsC;KAAlC;AAMN,UAAM,SAAS,kBAAT,CAA4B,KAA5B,EAAmC,IAAnC,EAAyC;AAC7C,UAAG,EAAE,MAAF,CAAS,KAAK,UAAL,CAAgB,KAAhB,CAAsB,MAAtB,CAAZ,EAA2C;AACzC,eAAO,KAAK,OAAL,CAAa,OAAb,CAAqB,IAArB,CAAP,CADyC;OAA3C;;AAIA,UAAI,WAAW;AACb,eAAO,cAAc,KAAd,CAAP;AACA,eAAO,qBAAqB,KAArB,CAAP;AACA,eAAO,qBAAqB,KAArB,CAAP;AACA,cAAM,oBAAoB,KAApB,CAAN;OAJE,CALyC;;AAY7C,aAAO,EAAE,SAAF,CAAY,CAAC,YAAD,EAAc,OAAd,EAAsB,QAAtB,CAAZ,EAA6C,IAA7C,EAAmD,IAAnD,CAAP,CAZ6C;AAa7C,aAAO,EAAE,KAAF,CACL,YAAM;AACJ,eAAO,iBACJ,MADI,CACG,gBAAc,KAAK,KAAL,CAAW,KAAX,EAAkB,MADnC,EAC2C,QAD3C,CAAP,CADI;OAAN,EAIA,UAAC,MAAD,EAAY;AACV,eAAO,EAAE,SAAF,CAAY,CAAC,YAAD,EAAc,OAAd,EAAsB,QAAtB,CAAZ,EAA6C,MAA7C,EAAqD,IAArD,CAAP,CADU;OAAZ,CALK,EAAP,CAb6C;KAAzC;AAuBN,WAAO,SAAS,mBAAT,CAA6B,IAA7B,EAAmC;AACxC,aAAO,EAAE,KAAF,CACL,YAAM;AACJ,YAAG,EAAE,KAAF,CAAQ,KAAK,UAAL,CAAgB,KAAhB,CAAsB,MAAtB,CAAX,EAA0C;AACxC,iBAAO,KAAK,OAAL,CAAa,OAAb,EAAP,CADwC;SAA1C;AAGA,eAAO,iBACJ,KADI,CACE,KAAK,UAAL,CAAgB,KAAhB,CAAsB,MAAtB,CADT,CAJI;OAAN,EAOA,YAAM;AACJ,eAAO,EAAE,KAAF,CAAQ,YAAR,EAAsB,kBAAkB,KAAK,UAAL,CAAxC,EAA0D,IAA1D,CAAP,CADI;OAAN,CARK,EAAP,CADwC;KAAnC;AAcP,YAAQ,SAAS,oBAAT,CAA8B,IAA9B,EAAoC;AAC1C,aAAO,EAAE,IAAF,CACL,EAAE,IAAF,CAAO,CAAC,YAAD,EAAc,OAAd,EAAsB,QAAtB,CAAP,CADK,EAEL,EAAE,MAAF,CAFK,CAGL,IAHK,CAAP,CAD0C;KAApC;AAMR,cAAU,SAAS,sBAAT,CAAgC,IAAhC,EAAsC,IAAtC,EAA4C;AACpD,UAAG,CAAC,sBAAsB,MAAtB,CAA6B,IAA7B,CAAD,EAAqC;AACtC,eAAO,KAAK,OAAL,CAAa,MAAb,CAAoB,YAApB,CAAP,CADsC;OAAxC;;AAIA,aAAO,EAAE,IAAF,CACL,EAAE,KAAF,CAAQ,MAAR,EAAgB,MAAhB,CADK,EAEL,EAAE,KAAF,CAAQ,MAAR,EAAgB,KAAK,KAAL,CAAW,KAAX,CAFX,EAGL,IAHK,CAAP,CALoD;AASpD,aAAO,iBACJ,IADI,CACC,IADD,EACO,KAAK,UAAL,CAAgB,KAAhB,CAAsB,MAAtB,CADd,CAToD;KAA5C;AAYV,sBAAkB,SAAS,gBAAT,CAA0B,KAA1B,EAAiC,IAAjC,EAAuC;AACvD,aAAO,EAAE,IAAF,CACL,cAAc,KAAd,CADK,EAEL,EAAE,SAAF,CAAY,EAAE,MAAM,SAAN,EAAd,CAFK,EAGL,EAAE,IAAF,CAAO,MAAP,CAHK,EAIL,UAAC,CAAD,EAAO;AACL,eAAO,EAAE,CAAF,EAAK,IAAL,GAAY,UAAZ,GAAyB,KAAzB,EAAP,CADK;OAAP,CAJK,CAOL,KAAK,UAAL,CAPF,CADuD;KAAvC;AAUlB,yBAAqB,SAAS,mBAAT,CAA6B,MAA7B,EAAqC,IAArC,EAA2C;AAC9D,aAAO,EAAE,IAAF,CACL,EAAE,SAAF,CAAY,EAAZ,CADK,EAEL,EAAE,MAAF,CAAS,EAAT,EAAa,YAAb,CAFK,EAGL,gBAAgB,EAAE,SAAF,CAAY,EAAZ,EAAgB,MAAhB,CAAhB,CAHK,EAIL,EAAE,KAAF,CAAQ,MAAR,CAJK,EAKL,UAAC,KAAD,EAAW;AACT,eAAS,EAAE,OAAF,CAAU,KAAV,IACA,CAAE,SAAF,CADA,GAEA,KAFA,CADA;OAAX,EAMA,EAAE,GAAF,CAAM,UAAC,CAAD,EAAO;AACX,eAAO,EAAE,CAAF,EAAK,IAAL,GAAY,UAAZ,GAAyB,KAAzB,EAAP,CADW;OAAP,CAXD,EAcL,IAdK,CAAP,CAD8D;KAA3C;GAxEnB,CADkD;AA2FtD,WAAS,iBAAT,CAA2B,UAA3B,EAAuC;AACrC,WAAO,EAAE,IAAF,CACL,EAAE,SAAF,CAAY,CAAC,OAAD,EAAS,QAAT,CAAZ,EAAgC,IAAhC,CADK,EAEL,EAAE,KAAF,CAAQ,OAAR,EAAiB,EAAjB,CAFK,EAGL,UAHK,CAAP,CADqC;GAAvC;AAMA,WAAS,aAAT,CAAuB,KAAvB,EAA8B;AAC5B,WAAO,YAAM;AACX,cAAQ,KAAR,CAAc,wBAAd,EADW;AAEX,YAAM,KAAN,CAAY,uBAAZ,EAFW;KAAN,CADqB;GAA9B;AAMA,MAAI,uBAAuB,EAAE,KAAF,CAAQ,SAAS,mBAAT,CAA6B,KAA7B,EAAoC,GAApC,EAAyC;AAC1E,YAAQ,GAAR,CAAY,6BAAZ,EAA2C,GAA3C,EAD0E;AAE1E,UAAM,KAAN,CAAY,qBAAZ,EAAmC,EAAE,IAAF,CACjC,EAAE,MAAF,CAAS,EAAT,EAAa,OAAb,CADiC,EAEjC,EAAE,MAAF,CAAS,EAAE,OAAF,CAAU,EAAE,OAAF,EAAW,EAAE,IAAF,CAAO,MAAP,CAArB,CAAT,CAFiC,EAGjC,GAHiC,CAAnC,EAF0E;GAAzC,CAA/B,CAvGkD;AA8GtD,MAAI,uBAAuB,EAAE,KAAF,CAAQ,SAAS,mBAAT,CAA6B,KAA7B,EAAoC,GAApC,EAAyC;AAC1E,YAAQ,GAAR,CAAY,6BAAZ,EAA2C,GAA3C,EAD0E;AAE1E,UAAM,KAAN,CAAY,qBAAZ,EAAmC,EAAE,IAAF,CACjC,EAAE,MAAF,CAAS,EAAT,EAAa,OAAb,CADiC,EAEjC,GAFiC,CAAnC,EAF0E;GAAzC,CAA/B,CA9GkD;AAoHtD,MAAI,sBAAsB,EAAE,KAAF,CAAQ,SAAS,kBAAT,CAA4B,KAA5B,EAAmC,GAAnC,EAAwC;AACxE,YAAQ,GAAR,CAAY,2BAAZ,EAAyC,GAAzC,EADwE;AAExE,UAAM,KAAN,CAAY,iBAAZ,EAA+B,GAA/B,EAFwE;GAAxC,CAA9B,CApHkD;AAwHtD,MAAI,gBAAgB,EAAE,KAAF,CAAQ,SAAS,YAAT,CAAsB,KAAtB,EAA6B,UAA7B,EAAyC;AACnE,WAAO,EAAE,IAAF,CACL,EAAE,IAAF,CAAO,OAAP,CADK,EAEL,EAAE,IAAF,CAAO,EAAE,MAAF,CAAS,OAAT,EAAkB,KAAlB,CAAP,CAFK,EAGL,UAHK,CAAP,CADmE;GAAzC,CAAxB,CAxHkD;AA8HtD,MAAI,kBAAkB,EAAE,KAAF,CAAQ,SAAS,cAAT,CAAwB,MAAxB,EAAgC,UAAhC,EAA4C;AACxE,WAAO,EAAE,IAAF,CACL,EAAE,GAAF,CAAM,EAAE,IAAF,CAAO,aAAP,EAAsB,UAAtB,CAAN,CADK,EAEL,EAAE,MAAF,CAAS,EAAE,KAAF,CAFJ,EAGL,MAHK,CAAP,CADwE;GAA5C,CAA1B,CA9HkD;AAoItD,IAAE,YAAF,CAAe,qBAAf,EApIsD;AAqItD,SAAO,qBAAP,CArIsD;CAFxD,CALJ","file":"connection.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('userConnection', [\n    'http',\n    'pubSub',\n    'websocket',\n    function userConnectionServiceFactory(httpService,\n                                          pubSubService,\n                                          websocketService) {\n      var userConnectionService = {\n        init: function userConnectionInit(user) {\n          let connection = {\n            state: { socket: null }\n          };\n          return R.assoc('connection', connection, user);\n        },\n        open: function userConnectionOpen(state, user) {\n          if(R.exists(user.connection.state.socket)) {\n            return self.Promise.resolve(user);\n          }\n\n          var handlers = {\n            close: closeHandler$(state),\n            users: usersMessageHandler$(state),\n            games: gamesMessageHandler$(state),\n            chat: chatMessageHandler$(state)\n          };\n\n          user = R.assocPath(['connection','state','socket'], null, user);\n          return R.pipeP(\n            () => {\n              return websocketService\n                .create('/api/users/'+user.state.stamp, 'user', handlers);\n            },\n            (socket) => {\n              return R.assocPath(['connection','state','socket'], socket, user);\n            }\n          )();\n        },\n        close: function userConnectionClose(user) {\n          return R.pipeP(\n            () => {\n              if(R.isNil(user.connection.state.socket)) {\n                return self.Promise.resolve();\n              }\n              return websocketService\n                .close(user.connection.state.socket);\n            },\n            () => {\n              return R.assoc('connection', cleanupConnection(user.connection), user);\n            }\n          )();\n        },\n        active: function userConnectionActive(user) {\n          return R.pipe(\n            R.path(['connection','state','socket']),\n            R.exists\n          )(user);\n        },\n        sendChat: function userConnectionSendChat(chat, user) {\n          if(!userConnectionService.active(user)) {\n            return self.Promise.reject('Not active');\n          }\n\n          chat = R.pipe(\n            R.assoc('type', 'chat'),\n            R.assoc('from', user.state.stamp)\n          )(chat);\n          return websocketService\n            .send(chat, user.connection.state.socket);\n        },\n        userNameForStamp: function userNameForStamp(stamp, user) {\n          return R.pipe(\n            userForStamp$(stamp),\n            R.defaultTo({ name: 'Unknown' }),\n            R.prop('name'),\n            (n) => {\n              return s(n).trim().capitalize().value();\n            }\n          )(user.connection);\n        },\n        usersNamesForStamps: function usersNamesForStamps(stamps, user) {\n          return R.pipe(\n            R.defaultTo({}),\n            R.propOr({}, 'connection'),\n            usersForStamps$(R.defaultTo([], stamps)),\n            R.pluck('name'),\n            (names) => {\n              return ( R.isEmpty(names) ?\n                       [ 'Unknown' ] :\n                       names\n                     );\n            },\n            R.map((n) => {\n              return s(n).trim().capitalize().value();\n            })\n          )(user);\n        }\n      };\n      function cleanupConnection(connection) {\n        return R.pipe(\n          R.assocPath(['state','socket'], null),\n          R.assoc('users', [])\n        )(connection);\n      }\n      function closeHandler$(state) {\n        return () => {\n          console.error('User connection: close');\n          state.event('User.connection.close');\n        };\n      }\n      var usersMessageHandler$ = R.curry(function usersMessageHandler(state, msg) {\n        console.log('User connection: users list', msg);\n        state.event('User.setOnlineUsers', R.pipe(\n          R.propOr([], 'users'),\n          R.sortBy(R.compose(R.toLower, R.prop('name')))\n        )(msg));\n      });\n      var gamesMessageHandler$ = R.curry(function gamesMessageHandler(state, msg) {\n        console.log('User connection: games list', msg);\n        state.event('User.setOnlineGames', R.pipe(\n          R.propOr([], 'games')\n        )(msg));\n      });\n      var chatMessageHandler$ = R.curry(function chatMessageHandler(state, msg) {\n        console.log('User connection: chat msg', msg);\n        state.event('User.newChatMsg', msg);\n      });\n      var userForStamp$ = R.curry(function userForStamp(stamp, connection) {\n        return R.pipe(\n          R.prop('users'),\n          R.find(R.propEq('stamp', stamp))\n        )(connection);\n      });\n      var usersForStamps$ = R.curry(function usersForStamps(stamps, connection) {\n        return R.pipe(\n          R.map(R.flip(userForStamp$)(connection)),\n          R.reject(R.isNil)\n        )(stamps);\n      });\n      R.curryService(userConnectionService);\n      return userConnectionService;\n    }\n  ]);\n"]}