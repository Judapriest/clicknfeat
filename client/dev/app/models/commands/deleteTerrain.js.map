{"version":3,"sources":["deleteTerrain.es6"],"names":[],"mappings":"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","file":"deleteTerrain.js","sourcesContent":["(function() {\n  angular.module('clickApp.models')\n    .factory('deleteTerrainCommand', deleteTerrainCommandModelFactory);\n\n  deleteTerrainCommandModelFactory.$inject = [\n    'commands',\n    'terrain',\n    'gameTerrains',\n    'gameTerrainSelection',\n  ];\n  function deleteTerrainCommandModelFactory(commandsModel,\n                                            terrainModel,\n                                            gameTerrainsModel,\n                                            gameTerrainSelectionModel) {\n    const deleteTerrainCommandModel = {\n      executeP: deleteTerrainExecuteP,\n      replayP: deleteTerrainReplayP,\n      undoP: deleteTerrainUndoP\n    };\n\n    const onDeletedStates$ = R.curry(onDeletedStates);\n    const emitCreateEvent$ = R.curry(emitCreateEvent);\n\n    commandsModel.registerCommand('deleteTerrain', deleteTerrainCommandModel);\n    return deleteTerrainCommandModel;\n\n    function deleteTerrainExecuteP(stamps, state, game) {\n      return R.threadP(game.terrains)(\n        gameTerrainsModel.findAnyStampsP$(stamps),\n        R.reject(R.isNil),\n        R.map(terrainModel.saveState),\n        onNewDeletedStates\n      );\n\n      function onNewDeletedStates(states) {\n        const ctxt = {\n          terrains: states,\n          desc: ''\n        };\n        return R.thread(states)(\n          onDeletedStates$(state, game),\n          (game) => {\n            return [ctxt, game];\n          }\n        );\n      }\n    }\n    function deleteTerrainReplayP(ctxt, state, game) {\n      return onDeletedStates(state, game, ctxt.terrains);\n    }\n    function deleteTerrainUndoP(ctxt, state, game) {\n      return R.threadP(ctxt.terrains)(\n        R.map(tryToCreateTerrain),\n        R.promiseAll,\n        R.reject(R.isNil),\n        R.rejectIf(R.isEmpty, 'No valid terrain definition'),\n        onNewCreatedTerrains\n      );\n\n      function tryToCreateTerrain(terrain) {\n        return self.Promise\n          .resolve(terrainModel.create(terrain))\n          .catch(R.always(null));\n      }\n      function onNewCreatedTerrains(terrains) {\n        const stamps = R.map(R.path(['state','stamp']), terrains);\n        return R.thread(game)(\n          addToGameTerrains,\n          addToGameTerrainSelection,\n          emitCreateEvent$(state)\n        );\n\n        function addToGameTerrains(game) {\n          return R.thread(game.terrains)(\n            gameTerrainsModel.add$(terrains),\n            (game_terrains) => {\n              return R.assoc('terrains', game_terrains, game);\n            }\n          );\n        }\n        function addToGameTerrainSelection(game) {\n          return R.thread(game.terrain_selection)(\n            gameTerrainSelectionModel.set$('remote', stamps, state),\n            (selection) => {\n              return R.assoc('terrain_selection', selection, game);\n            }\n          );\n        }\n      }\n    }\n    function onDeletedStates(state, game, states) {\n      const stamps = R.pluck('stamp', states);\n      return R.thread(game)(\n        removeFromGameTerrains,\n        removeFromGameTerrainSelection,\n        emitCreateEvent$(state)\n      );\n      function removeFromGameTerrains(game){\n        return R.thread(game.terrains)(\n          gameTerrainsModel.removeStamps$(stamps),\n          (game_terrains) => {\n            return R.assoc('terrains', game_terrains, game);\n          }\n        );\n      }\n      function removeFromGameTerrainSelection(game) {\n        return R.thread(game.terrain_selection)(\n          gameTerrainSelectionModel.removeFrom$('local', stamps, state),\n          gameTerrainSelectionModel.removeFrom$('remote', stamps, state),\n          (selection) => {\n            return R.assoc('terrain_selection', selection, game);\n          }\n        );\n      }\n    }\n    function emitCreateEvent(state, game) {\n      state.queueChangeEventP('Game.terrain.create');\n      return game;\n    }\n  }\n})();\n"]}