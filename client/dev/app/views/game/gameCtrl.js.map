{"version":3,"sources":["gameCtrl.es6"],"names":[],"mappings":"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","file":"gameCtrl.js","sourcesContent":["(function() {\n  angular.module('clickApp.controllers')\n    .controller('gameCtrl', gameCtrl);\n\n  gameCtrl.$inject = [\n    '$scope',\n    '$stateParams',\n    'modes',\n  ];\n  function gameCtrl($scope,\n                    $stateParams,\n                    modesModel) {\n    const vm = this;\n    console.log('init gameCtrl', $stateParams);\n\n    const is_online = R.propEq('online', 'online', $stateParams);\n    const is_private = R.propEq('private', 'private', $stateParams);\n    const id = R.prop('id', $stateParams);\n\n    vm.currentModeName = currentModeName;\n    vm.currentModeIs = currentModeIs;\n    vm.doModeAction = doModeAction;\n    vm.doActionButton = doActionButton;\n    vm.doInvitePlayer = doInvitePlayer;\n\n    activate();\n\n    function activate() {\n      vm.hints = {};\n      vm.show_action_group = null;\n      vm.invite_player = null;\n\n      $scope.stateEvent('Game.load', is_online, is_private, id);\n      $scope.digestOnStateChangeEvent('Game.load.success', $scope);\n      $scope.onStateChangeEvent('Game.load.error', onGameLoadError, $scope);\n\n      $scope.digestOnStateChangeEvent('Game.layers.change', $scope);\n      $scope.digestOnStateChangeEvent('Game.board.change', $scope);\n      $scope.digestOnStateChangeEvent('Game.scenario.change', $scope);\n      $scope.digestOnStateChangeEvent('Game.model.create.enable', $scope);\n      $scope.digestOnStateChangeEvent('Game.template.create.enable', $scope);\n      $scope.digestOnStateChangeEvent('Game.terrain.create.enable', $scope);\n      $scope.digestOnStateChangeEvent('Game.players.change', $scope);\n\n      $scope.onStateChangeEvent('Game.chat', hintOnGameChat, $scope);\n      $scope.onStateChangeEvent('User.chat', hintOnUserChat, $scope);\n\n      $scope.onStateChangeEvent('Modes.change',\n                                updateCurrentModeBindings,\n                                $scope);\n      $scope.onStateChangeEvent('Modes.buttons.update',\n                                updateCurrentModeBindings,\n                                $scope);\n      // $scope.onStateChangeEvent('Game.loaded', updateCurrentModeBindings, $scope);\n\n      $scope.$on('$destroy', () => {\n        $scope.stateEvent('Modes.exit');\n      });\n    }\n\n    function onGameLoadError() {\n      $scope.goToState('lounge');\n    }\n\n    function hintOnGameChat(_event_, msg) {\n      if(R.isNil(msg) || R.isNil(msg.from) ||\n         msg.from === $scope.state.user.state.name) return;\n\n      vm.hints.go_to_main = !$scope.app.stateIs('game.main');\n      $scope.$digest();\n    }\n    function hintOnUserChat(_event_, msg) {\n      if(msg.from === $scope.state.user.state.stamp) return;\n\n      vm.hints.go_to_online = !$scope.app.stateIs('game.online');\n      $scope.$digest();\n    }\n\n    function updateCurrentModeBindings() {\n      vm.action_bindings = R.thread($scope)(\n        R.path(['state','modes']),\n        modesModel.currentModeBindings,\n        R.clone\n      );\n      vm.action_buttons = R.thread($scope)(\n        R.path(['state','modes']),\n        modesModel.currentModeButtons,\n        R.clone\n      );\n      $scope.$digest();\n    }\n\n    function currentModeName() {\n      return R.thread($scope)(\n        R.pathOr({}, ['state', 'modes']),\n        modesModel.currentModeName\n      );\n    }\n    function currentModeIs(mode) {\n      return currentModeName() === mode;\n    }\n    function doModeAction(action, ...args) {\n      $scope.stateEvent('Modes.current.action',\n                        action, [...args, {}]);\n    }\n    function doActionButton([_label_, action, group]) {\n      if(action === 'toggle') {\n        vm.show_action_group = ( $scope.show_action_group === group\n                                 ? null\n                                 : group\n                               );\n        return;\n      }\n      $scope.stateEvent('Modes.current.action',\n                        action, [{}]);\n    }\n    function doInvitePlayer() {\n      if(R.isNil(vm.invite_player)) return;\n\n      $scope.stateEvent('Game.invitePlayer', vm.invite_player);\n    }\n    ////////////////////////////////////////////////////\n    // function updateGameLosOriginTarget(on) {\n    //   let game_los = {\n    //     stamp: null,\n    //     change: null,\n    //     delete: null\n    //   };\n    //   function cleanupLosListener(origin) {\n    //     if(game_los.stamp === origin) return;\n\n    //     console.log('unsubscribe Los listeners', on, game_los.stamp);\n    //     if(game_los.change) game_los.change();\n    //     game_los.change = null;\n    //     if(game_los.delete) game_los.delete();\n    //     game_los.delete = null;\n    //     game_los.stamp = null;\n    //   }\n    //   $scope.onGameEvent('changeRemoteLos', (event, los) => {\n    //     let stamp = gameLosService[on](los);\n    //     cleanupLosListener(stamp);\n\n    //     let display = gameLosService.isDisplayed(los);\n    //     if( !display ||\n    //         R.isNil(stamp) ||\n    //         game_los.stamp === stamp ) return;\n\n    //     let change_event = 'changeModel-'+stamp;\n    //     game_los.change = pubSubService.subscribe(change_event, () => {\n    //       console.log('update LoS change', on);\n    //       gameLosService.updateOriginTarget($scope, $scope.game, $scope.game.los);\n    //     }, game_event_channel);\n    //     let delete_event = 'deleteModel-'+stamp;\n    //     game_los.delete = pubSubService.subscribe(delete_event, () => {\n    //       console.log('update LoS delete', on);\n    //       let cmd = (on === 'origin' ? 'clearOrigin' : 'clearTarget');\n    //       gameLosService[cmd]($scope, $scope.game, $scope.game.los);\n    //     }, game_event_channel);\n    //     console.log('subscribe Los listener', on, change_event, delete_event);\n    //     game_los.stamp = stamp;\n    //   }, $scope);\n    //   $scope.$on('$destroy', () => {\n    //     cleanupLosListener();\n    //   });\n    // }\n    // updateGameLosOriginTarget('origin');\n    // updateGameLosOriginTarget('target');\n\n    // function updateGameRulerOriginTarget(on) {\n    //   let game_ruler = {\n    //     stamp: null,\n    //     change: null,\n    //     delete: null\n    //   };\n    //   function cleanupRulerListener(origin) {\n    //     if(game_ruler.stamp === origin) return;\n\n    //     console.log('unsubscribe Ruler listener', on, game_ruler.stamp);\n    //     if(game_ruler.change) game_ruler.change();\n    //     game_ruler.change = null;\n    //     if(game_ruler.delete) game_ruler.delete();\n    //     game_ruler.delete = null;\n    //     game_ruler.stamp = null;\n    //   }\n    //   $scope.onGameEvent('changeRemoteRuler', (event, ruler) => {\n    //     let stamp = gameRulerService[on](ruler);\n    //     cleanupRulerListener(stamp);\n\n    //     let display = gameRulerService.isDisplayed(ruler);\n    //     if( !display ||\n    //         R.isNil(stamp) ||\n    //         game_ruler.stamp === stamp ) return;\n\n    //     let change_event = 'changeModel-'+stamp;\n    //     game_ruler.change = pubSubService.subscribe(change_event, () => {\n    //       console.log('update Ruler change', on);\n    //       gameRulerService.updateOriginTarget($scope, $scope.game.ruler);\n    //     }, game_event_channel);\n    //     let delete_event = 'deleteModel-'+stamp;\n    //     game_ruler.delete = pubSubService.subscribe(delete_event, () => {\n    //       console.log('update Ruler delete', on);\n    //       let cmd = (on === 'origin' ? 'clearOrigin' : 'clearTarget');\n    //       gameRulerService[cmd]($scope, $scope.game.ruler)\n    //         .then((ruler) => {\n    //           $scope.game.ruler = ruler;\n    //         });\n    //     }, game_event_channel);\n    //     console.log('subscribe Ruler listener', on, change_event, delete_event);\n    //     game_ruler.stamp = stamp;\n    //   }, $scope);\n    //   $scope.$on('$destroy', () => {\n    //     cleanupRulerListener();\n    //   });\n    // }\n    // updateGameRulerOriginTarget('origin');\n    // updateGameRulerOriginTarget('target');\n\n    // function updateGameModelSelection() {\n    //   let game_model = {\n    //     stamp: null,\n    //     unsubscribe: null\n    //   };\n    //   function cleanupModelListener(stamp) {\n    //     if(game_model.stamp === stamp ||\n    //        R.isNil(game_model.unsubscribe)) return;\n\n    //     console.info('unsubscribe Game Model listener', game_model.stamp);\n    //     game_model.unsubscribe();\n    //     game_model.unsubscribe = null;\n    //     game_model.stamp = null;\n    //   }\n    //   function updateSingleModelSelection(stamp) {\n    //     R.pipePromise(\n    //       (stamp) => {\n    //         if(R.isNil(stamp)) return null;\n\n    //         return gameModelsService\n    //           .findStamp(stamp, $scope.game.models);\n    //       },\n    //       (model) => {\n    //         $scope.gameEvent('updateSingleModelSelection', stamp, model);\n    //       }\n    //     )(stamp);\n    //   }\n    //   $scope.onGameEvent('changeLocalModelSelection', (event, selection) => {\n    //     let stamps = gameModelSelectionService.get('local', selection);\n    //     let stamp = R.length(stamps) === 1 ? R.head(stamps) : null;\n    //     cleanupModelListener(stamp);\n\n    //     if( R.isNil(stamp) ||\n    //         game_model.stamp === stamp ) return;\n\n    //     let event_name = 'changeModel-'+stamp;\n    //     console.info('subscribe Game Model listener', event_name);\n    //     game_model.unsubscribe = pubSubService.subscribe(event_name, () => {\n    //       let stamps = gameModelSelectionService.get('local', $scope.game.model_selection);\n    //       let stamp = R.length(stamps) === 1 ? R.head(stamps) : null;\n    //       updateSingleModelSelection(stamp);\n    //     }, game_event_channel);\n    //     game_model.stamp = stamp;\n    //     updateSingleModelSelection(stamp);\n    //   }, $scope);\n    //   $scope.$on('$destroy', () => {\n    //     cleanupModelListener();\n    //   });\n    // }\n    // updateGameModelSelection();\n\n    // function updateGameTemplateSelection() {\n    //   let game_template = {\n    //     stamp: null,\n    //     unsubscribe: null\n    //   };\n    //   function cleanupTemplateListener(stamp) {\n    //     if(game_template.stamp === stamp ||\n    //        R.isNil(game_template.unsubscribe)) return;\n\n    //     console.info('unsubscribe Game Template listener', game_template.stamp);\n    //     game_template.unsubscribe();\n    //     game_template.unsubscribe = null;\n    //     game_template.stamp = null;\n    //   }\n    //   function updateSingleTemplateSelection(stamp) {\n    //     R.pipePromise(\n    //       (stamp) => {\n    //         if(R.isNil(stamp)) return null;\n\n    //         return gameTemplatesService\n    //           .findStamp(stamp, $scope.game.templates);\n    //       },\n    //       (template) => {\n    //         if(R.exists(template) &&\n    //            'aoe' !== template.state.type) {\n    //           stamp = null;\n    //           template = null;\n    //         }\n\n    //         $scope.gameEvent('updateSingleTemplateSelection', stamp, template);\n    //       }\n    //     )(stamp);\n    //   }\n    //   $scope.onGameEvent('changeLocalTemplateSelection', (event, selection) => {\n    //     let stamps = gameTemplateSelectionService.get('local', selection);\n    //     let stamp = R.length(stamps) === 1 ? R.head(stamps) : null;\n    //     cleanupTemplateListener(stamp);\n\n    //     if( R.isNil(stamp) ||\n    //         game_template.stamp === stamp ) return;\n\n    //     let event_name = 'changeTemplate-'+stamp;\n    //     console.info('subscribe Game Template listener', event_name);\n    //     game_template.unsubscribe = pubSubService.subscribe(event_name, () => {\n    //       let stamps = gameTemplateSelectionService.get('local', $scope.game.template_selection);\n    //       let stamp = R.length(stamps) === 1 ? R.head(stamps) : null;\n    //       updateSingleTemplateSelection(stamp);\n    //     }, game_event_channel);\n    //     game_template.stamp = stamp;\n    //     updateSingleTemplateSelection(stamp);\n    //   }, $scope);\n    //   $scope.$on('$destroy', () => {\n    //     cleanupTemplateListener();\n    //   });\n    // }\n    // updateGameTemplateSelection();\n  }\n})();\n"]}