{"version":3,"sources":["../../es6/controllers/gameCtrl.js"],"names":[],"mappings":"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","file":"gameCtrl.js","sourcesContent":["angular.module('clickApp.controllers')\n  .controller('gameCtrl', [\n    '$scope',\n    '$state',\n    '$stateParams',\n    '$window',\n    'userConnection',\n    'game',\n    'gameConnection',\n    'gameLos',\n    'games',\n    'modes',\n    'pubSub',\n    'allModes',\n    'allCommands',\n    'allTemplates',\n    function($scope,\n             $state,\n             $stateParams,\n             $window,\n             userConnectionService,\n             gameService,\n             gameConnectionService,\n             gameLosService,\n             gamesService,\n             modesService,\n             pubSubService) {\n      console.log('init gameCtrl', $stateParams, $state.current.name);\n      var is_online = ($stateParams.online === 'online');\n      $scope.is_private = ($stateParams['private'] === 'private');\n      $scope.ui_state = {};\n\n      $scope.hints = {};\n      \n      $scope.invite = { player: null };\n      $scope.doInvitePlayer = () => {\n        var to = [$scope.invite.player];\n        var msg = [\n          s.capitalize(R.pathOr('Unknown', ['user','state','name'], $scope)),\n          'has invited you to join a game'\n        ].join(' ');\n        var link = $window.location.hash;\n        console.log(to, msg, link);\n        \n        return userConnectionService\n          .sendChat(to, msg, link, $scope.user)\n          .then(() => {\n            $scope.$digest();\n          });\n      };\n      \n      var game_event_channel = pubSubService.init();\n      pubSubService.subscribe('#watch#', R.spy('gameEvent'),\n                              game_event_channel);\n      var game_is_loading = false;\n      var event_loading_queue = [];\n      $scope.gameEvent = function gameEvent(...args) {\n        var [event] = args;\n        if(event === 'gameLoading') game_is_loading = true;\n\n        if(event === 'gameLoaded') {\n          R.pipe(\n            R.reverse,\n            R.uniqBy(R.head),\n            R.reverse,\n            R.forEach((args) => {\n              pubSubService.publish.apply(null, R.append(game_event_channel, args));\n            })\n          )(event_loading_queue);\n          event_loading_queue = [];\n          game_is_loading = false;\n        }\n        if(game_is_loading) {\n          event_loading_queue = R.append(args, event_loading_queue);\n          return;\n        }\n        pubSubService.publish.apply(null, R.append(game_event_channel, args));\n      };\n      $scope.onGameEvent = function onGameEvent(event, listener, scope) {\n        // console.log('subscribe onGameEvent', arguments);\n        var unsubscribe = pubSubService.subscribe(event, listener, game_event_channel);\n        scope.$on('$destroy', () => {\n          // console.log('unsubscribe onGameEvent', event, game_event_channel);\n          unsubscribe();\n        });\n      };\n      $scope.digestOnGameEvent = function digestOnGameEvent(event, scope) {\n        // console.log('subscribe digestOnGameEvent', arguments);\n        var unsubscribe = pubSubService.subscribe(event, () => {\n          console.log('digestOnGameEvent', event);\n          $scope.$digest(scope);\n        }, game_event_channel);\n        scope.$on('$destroy', () => {\n          // console.log('unsubscribe digestOnGameEvent', event, game_event_channel);\n          unsubscribe();\n        });\n      };\n      $scope.onGameEvent('chat', () => {\n        let msg = R.last($scope.game.chat);\n        if(msg.from === $scope.user.state.name) return;\n              \n        $scope.hints.go_to_main = !$scope.stateIs('game.main');\n        $scope.$digest();\n      }, $scope);\n      function updateGameLosOriginTarget(on) {\n        let game_los = {\n          stamp: null,\n          unsubscribe: null\n        };\n        function cleanupLosListener(origin) {\n          if(game_los.stamp === origin ||\n             R.isNil(game_los.unsubscribe)) return;\n          \n          console.info('unsubscribe Los listener', on);\n          game_los.unsubscribe();\n          game_los.unsubscribe = null;\n          game_los.stamp = null;\n        }\n        $scope.onGameEvent('changeRemoteLos', (event, los) => {\n          let stamp = gameLosService[on](los);\n          cleanupLosListener(stamp);\n          \n          let display = gameLosService.isDisplayed(los);\n          if( !display ||\n              R.isNil(stamp) ||\n              game_los.stamp === stamp ) return;\n          \n          let event_name = 'changeModel-'+stamp;\n          console.info('subscribe Los listener', on, event_name);\n          game_los.unsubscribe = pubSubService.subscribe(event_name, () => {\n            console.info('update LoS', on);\n            gameLosService.updateOriginTarget($scope, $scope.game, los);\n          }, game_event_channel);\n        }, $scope);\n        $scope.$on('$destroy', () => {\n          cleanupLosListener();\n        });\n      }\n      updateGameLosOriginTarget('origin');\n      updateGameLosOriginTarget('target');\n      \n      $scope.digestOnGameEvent('diceRoll', $scope);\n      $scope.digestOnGameEvent('changeBoard', $scope);\n      $scope.digestOnGameEvent('changeLayers', $scope);\n      $scope.digestOnGameEvent('changeScenario', $scope);\n      $scope.digestOnGameEvent('createModel', $scope);\n      $scope.digestOnGameEvent('createTemplate', $scope);\n      $scope.digestOnGameEvent('switchMode', $scope);\n      $scope.digestOnGameEvent('gameLoaded', $scope);\n      \n      $scope.saveGame = (game) => {\n        return R.pipeP(\n          (game) => {\n            if(is_online) return self.Promise.resolve(game);\n            \n            return R.pipeP(\n              gamesService.updateLocalGame$($scope.game_index, game),\n              (games) => {\n                $scope.local_games = games;\n                return game;\n              }\n            )($scope.local_games);\n          },\n          (game) => {\n            if(R.isNil(game)) return game;\n\n            $scope.game = game;\n            $scope.gameEvent('saveGame', game);\n\n            return game;\n          }\n        )(game);\n      };\n\n      $scope.currentModeName = () => {\n        if(!R.exists($scope.modes)) return '';\n        return modesService.currentModeName($scope.modes);\n      };\n      $scope.currentModeIs = (mode) => {\n        if(!R.exists($scope.modes)) return false;\n        return modesService.currentModeName($scope.modes) === mode;\n      };\n      $scope.doSwitchToMode = (mode) => {\n        return modesService.switchToMode(mode, $scope, $scope.modes)\n          .catch((reason) => {\n            $scope.gameEvent('modeActionError', reason);\n            return self.Promise.reject(reason);\n          });\n      };\n      $scope.doModeAction = (action) => {\n        return modesService.currentModeAction(action, $scope, $scope.modes)\n          .catch((reason) => {\n            $scope.gameEvent('modeActionError', reason);\n            return self.Promise.reject(reason);\n          });\n      };\n      $scope.doExecuteCommand = function doExecuteCommand(...args) {\n        args = R.concat(args, [$scope, $scope.game]);\n        return gameService.executeCommand.apply(gameService, args)\n          .catch((reason) => {\n            $scope.gameEvent('modeActionError', reason);\n            return self.Promise.reject(reason);\n          });\n      };\n      $scope.show_action_group = null;\n      $scope.doActionButton = function doActionButton([label, action, group]) {\n        label = label;\n        if(action === 'toggle') {\n          $scope.show_action_group = ( ($scope.show_action_group === group) ?\n                                       null :\n                                       group\n                                     );\n          return;\n        }\n        $scope.doModeAction(action);\n      };\n\n      var forward_events = [\n        // 'clickModel',\n        // 'rightClickModel',\n        'dragStartModel',\n        'dragModel',\n        'dragEndModel',\n        // 'clickTemplate',\n        // 'rightClickTemplate',\n        'dragStartTemplate',\n        'dragTemplate',\n        'dragEndTemplate',\n        // 'clickMap',\n        // 'rightClickMap',\n        'moveMap',\n        'dragStartMap',\n        'dragMap',\n        'dragEndMap',\n      ];\n      R.forEach((fwd) => {\n        $scope.$on(fwd, (e, target, event) => {\n          console.log('$on '+fwd, arguments);\n          $scope.gameEvent('closeSelectionDetail');\n          modesService.currentModeAction(fwd, $scope, target, event, $scope.modes)\n            .catch((reason) => {\n              $scope.gameEvent('modeActionError', reason);\n            });\n        });\n      }, forward_events);\n      $scope.$on('$destroy', () => {\n        console.log('on gameCtrl $destroy');\n        Mousetrap.reset();\n      });\n\n      $scope.onGameLoad = R.pipeP(\n        R.always($scope.user_ready),\n        // function() {\n        //   return new self.Promise(function(resolve, reject) {\n        //     self.setTimeout(resolve, 1000);\n        //   });\n        // },\n        () => {\n          let unsub = pubSubService.subscribe('chat', (event, chats) => {\n            let msg = R.last(chats);\n            console.log('gameCtrl: userMailHint', event, chats, msg);\n            if(msg.from === $scope.user.state.stamp) return;\n\n            $scope.hints.go_to_online = !$scope.stateIs('game.online');\n            $scope.$digest();\n          }, $scope.user.connection.channel);\n          $scope.$on('$destroy', () => { unsub(); });\n        },\n        () => {\n          if(is_online) {\n            return gamesService\n              .loadOnlineGame$($scope.is_private, $stateParams.id)\n              .catch(R.pipe(\n                R.spyError('Load online game: error'),\n                R.always(null)\n              ));\n          }\n          else {\n            return R.pipeP(\n              gamesService.loadLocalGames,\n              (local_games) => {\n                $scope.local_games = local_games;\n                $scope.game_index = $stateParams.id >> 0;\n                var game = R.nth($scope.game_index,\n                                 $scope.local_games);\n                console.log('load local game', game);\n                return game;\n              }\n            )();\n          }\n        },\n        (game) => {\n          if(R.isNil(game)) {\n            $scope.goToState('lounge');\n            return self.Promise.reject('load game: unknown');\n          }\n          \n          $scope.game = game;\n          return modesService.init($scope);\n        },\n        (modes) => {\n          $scope.modes = modes;\n          \n          if($state.current.name === 'game') {\n            $scope.goToState('.main');\n          }\n          $scope.create = {};\n          \n          return $scope.data_ready;\n        },\n        () => {\n          return gameService.load($scope, $scope.game);\n        },\n        (game) => {\n          if(!is_online) return game;\n\n          return gameConnectionService\n            .open$(R.pathOr('', ['user','state','name'], $scope),\n                   $scope, game);\n        },\n        (game) => {\n          $scope.$on('$destroy', function gameCtrlOnDestroy() {\n            gameConnectionService.close(game);\n          });\n          console.error('#### Game Loaded', $scope.game);\n          $scope.$digest();\n        }\n      )();\n    }\n  ]);\n"]}