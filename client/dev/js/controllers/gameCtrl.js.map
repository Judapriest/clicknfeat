{"version":3,"sources":["../../es6/controllers/gameCtrl.js"],"names":[],"mappings":"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","file":"gameCtrl.js","sourcesContent":["'use strict';\n\nangular.module('clickApp.controllers')\n  .controller('gameCtrl', [\n    '$scope',\n    '$state',\n    '$stateParams',\n    '$window',\n    'userConnection',\n    'game',\n    'gameConnection',\n    'games',\n    'modes',\n    'pubSub',\n    'allModes',\n    'allCommands',\n    'allTemplates',\n    function($scope,\n             $state,\n             $stateParams,\n             $window,\n             userConnectionService,\n             gameService,\n             gameConnectionService,\n             gamesService,\n             modesService,\n             pubSubService) {\n      console.log('init gameCtrl', $stateParams, $state.current.name);\n      var is_online = ($stateParams.online === 'online');\n      $scope.is_private = ($stateParams['private'] === 'private');\n      $scope.ui_state = {};\n\n      $scope.invite = { player: null };\n      $scope.doInvitePlayer = function() {\n        var to = [$scope.invite.player];\n        var msg = [\n          s.capitalize(R.pathOr('Unknown', ['user','state','name'], $scope)),\n          'has invited you to join a game'\n        ].join(' ');\n        var link = $window.location.hash;\n        console.log(to, msg, link);\n        \n        return userConnectionService\n          .sendChat(to, msg, link, $scope.user)\n          .then(function() {\n            $scope.$digest();\n          });\n      };\n      \n      var game_event_channel = pubSubService.init();\n      pubSubService.subscribe('#watch#', function() {\n        console.log('gameEvent', arguments);\n      }, game_event_channel);\n      var game_is_loading = false;\n      var event_loading_queue = [];\n      $scope.gameEvent = function gameEvent(event) {\n        if(event === 'gameLoading') game_is_loading = true;\n\n        var args = Array.prototype.slice.apply(arguments);\n        if(event === 'gameLoaded') {\n          R.pipe(\n            R.reverse,\n            R.uniqBy(R.head),\n            R.reverse,\n            R.forEach(function(args) {\n              pubSubService.publish.apply(null, R.append(game_event_channel, args));\n            })\n          )(event_loading_queue);\n          event_loading_queue = [];\n          game_is_loading = false;\n        }\n        if(game_is_loading) {\n          event_loading_queue = R.append(args, event_loading_queue);\n          return;\n        }\n        pubSubService.publish.apply(null, R.append(game_event_channel, args));\n      };\n      $scope.onGameEvent = function onGameEvent(event, listener, scope) {\n        // console.log('subscribe onGameEvent', arguments);\n        var unsubscribe = pubSubService.subscribe(event, listener, game_event_channel);\n        scope.$on('$destroy', function unsubscribeOnGameEvent() {\n          // console.log('unsubscribe onGameEvent', event, game_event_channel);\n          unsubscribe();\n        });\n      };\n      $scope.digestOnGameEvent = function digestOnGameEvent(event, scope) {\n        // console.log('subscribe digestOnGameEvent', arguments);\n        var unsubscribe = pubSubService.subscribe(event, function _digestOnGameEvent() {\n          console.log('digestOnGameEvent', event);\n          $scope.$digest(scope);\n        }, game_event_channel);\n        scope.$on('$destroy', function unsubscribeDigestOnGameEvent() {\n          // console.log('unsubscribe digestOnGameEvent', event, game_event_channel);\n          unsubscribe();\n        });\n      };\n      $scope.digestOnGameEvent('diceRoll', $scope);\n      $scope.digestOnGameEvent('changeBoard', $scope);\n      $scope.digestOnGameEvent('changeLayers', $scope);\n      $scope.digestOnGameEvent('changeScenario', $scope);\n      $scope.digestOnGameEvent('createModel', $scope);\n      $scope.digestOnGameEvent('createTemplate', $scope);\n      $scope.digestOnGameEvent('switchMode', $scope);\n      $scope.digestOnGameEvent('gameLoaded', $scope);\n      \n      $scope.saveGame = function saveGame(game) {\n        return R.pipeP(\n          function(game) {\n            if(is_online) return self.Promise.resolve(game);\n            \n            return R.pipeP(\n              gamesService.updateLocalGame$($scope.game_index, game),\n              function(games) {\n                $scope.local_games = games;\n                return game;\n              }\n            )($scope.local_games);\n          },\n          function(game) {\n            if(R.isNil(game)) return;\n\n            $scope.game = game;\n            $scope.gameEvent('saveGame', game);\n\n            return game;\n          }\n        )(game);\n      };\n\n      $scope.currentModeName = function currentModeName() {\n        if(!R.exists($scope.modes)) return '';\n        return modesService.currentModeName($scope.modes);\n      };\n      $scope.currentModeIs = function currentModeIs(mode) {\n        if(!R.exists($scope.modes)) return false;\n        return modesService.currentModeName($scope.modes) === mode;\n      };\n      $scope.doSwitchToMode = function doSwitchToMode(mode) {\n        return modesService.switchToMode(mode, $scope, $scope.modes)\n          .catch(function(reason) {\n            $scope.gameEvent('modeActionError', reason);\n            return self.Promise.reject(reason);\n          });\n      };\n      $scope.doModeAction = function doModeAction(action) {\n        return modesService.currentModeAction(action, $scope, $scope.modes)\n          .catch(function(reason) {\n            $scope.gameEvent('modeActionError', reason);\n            return self.Promise.reject(reason);\n          });\n      };\n      $scope.doExecuteCommand = function doExecuteCommand() {\n        var args = Array.prototype.slice.apply(arguments);\n        args = R.concat(args, [$scope, $scope.game]);\n        return gameService.executeCommand.apply(gameService, args)\n          .catch(function(reason) {\n            $scope.gameEvent('modeActionError', reason);\n            return self.Promise.reject(reason);\n          });\n      };\n      $scope.show_action_group = null;\n      $scope.doActionButton = function doActionButton(action) {\n        if(action[1] === 'toggle') {\n          $scope.show_action_group = ($scope.show_action_group === action[2]) ? null : action[2];\n          return;\n        }\n        $scope.doModeAction(action[1]);\n      };\n\n      var forward_events = [\n        // 'clickModel',\n        // 'rightClickModel',\n        'dragStartModel',\n        'dragModel',\n        'dragEndModel',\n        // 'clickTemplate',\n        // 'rightClickTemplate',\n        'dragStartTemplate',\n        'dragTemplate',\n        'dragEndTemplate',\n        // 'clickMap',\n        // 'rightClickMap',\n        'moveMap',\n        'dragStartMap',\n        'dragMap',\n        'dragEndMap',\n      ];\n      R.forEach(function(fwd) {\n        $scope.$on(fwd, function onForwardEvent(e, target, event) {\n          console.log('$on '+fwd, arguments);\n          $scope.gameEvent('closeSelectionDetail');\n          modesService.currentModeAction(fwd, $scope, target, event, $scope.modes)\n            .catch(function(reason) {\n              $scope.gameEvent('modeActionError', reason);\n            });\n        });\n      }, forward_events);\n      $scope.$on('$destroy', function onGameCtrlDestroy() {\n        console.log('on gameCtrl $destroy');\n        Mousetrap.reset();\n      });\n\n      $scope.onGameLoad = R.pipeP(\n        R.always($scope.user_ready),\n        // function() {\n        //   return new self.Promise(function(resolve, reject) {\n        //     self.setTimeout(resolve, 1000);\n        //   });\n        // },\n        function() {\n          if(is_online) {\n            return gamesService\n              .loadOnlineGame$($scope.is_private, $stateParams.id)\n              .catch(R.pipe(\n                R.spyError('Load online game: error'),\n                R.always(null)\n              ));\n          }\n          else {\n            return R.pipeP(\n              gamesService.loadLocalGames,\n              function(local_games) {\n                $scope.local_games = local_games;\n                $scope.game_index = $stateParams.id >> 0;\n                var game = R.nth($scope.game_index,\n                                 $scope.local_games);\n                console.log('load local game', game);\n                return game;\n              }\n            )();\n          }\n        },\n        function(game) {\n          if(R.isNil(game)) {\n            $scope.goToState('lounge');\n            return self.Promise.reject('load game: unknown');\n          }\n          \n          $scope.game = game;\n          return modesService.init($scope);\n        },\n        function(modes) {\n          $scope.modes = modes;\n          \n          if($state.current.name === 'game') {\n            $scope.goToState('.main');\n          }\n          $scope.create = {};\n          \n          return $scope.data_ready;\n        },\n        function() {\n          return gameService.load($scope, $scope.game);\n        },\n        function(game) {\n          if(!is_online) return game;\n\n          return gameConnectionService\n            .open$(R.pathOr('', ['user','state','name'], $scope),\n                   $scope, game);\n        },\n        function(game) {\n          $scope.$on('$destroy', function gameCtrlOnDestroy() {\n            gameConnectionService.close(game);\n          });\n          console.error('#### Game Loaded', $scope.game);\n          $scope.$digest();\n        }\n      )();\n    }\n  ]);\n"]}