{"version":3,"sources":["../../es6/directives/gameSelectionDetail.js"],"names":[],"mappings":"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","file":"gameSelectionDetail.js","sourcesContent":["'use strict';\n\nangular.module('clickApp.controllers')\n  .controller('clickGameSelectionDetailCtrl', [\n    '$scope',\n    'game',\n    'gameFactions',\n    function($scope,\n             gameService,\n             gameFactionsService) {\n      console.log('init clickGameSelectionDetailCtrl');\n      $scope.edit = { label: '',\n                      max_deviation: 0\n                    };\n      var updateOnOpenType = {\n        template: function updateOnOpenTemplate() {\n          $scope.edit.max_deviation = R.defaultTo(0, R.path(['state','m'], $scope.selection));\n        },\n        model: function updateOnOpenModel() {\n          gameFactionsService.getModelInfo($scope.selection.state.info, $scope.factions)\n            .then(function(info) {\n              $scope.info = info;\n            });\n        },\n      };\n      $scope.show = { info: false };\n      $scope.updateOnOpen = function updateOnOpen() {\n        $scope.show.info = false;\n        updateOnOpenType[$scope.type]();\n      };\n      $scope.labelDisplay = function labelDisplay(l) {\n        return s.truncate(l, 12);\n      };\n\n      $scope.doSetMaxDeviation = function doSetMaxDeviation() {\n        var max = ($scope.edit.max_deviation > 0) ? $scope.edit.max_deviation : null;\n        $scope.doExecuteCommand('onTemplates', 'setMaxDeviation', max,\n                                [$scope.selection.state.stamp]);\n      };\n      $scope.doAddLabel = function doAddLabel() {\n        var cmd = ($scope.type === 'template') ? 'onTemplates' : 'onModels';\n        var new_label = s.trim($scope.edit.label);\n        if(R.length(new_label) === 0) return;\n        \n        $scope.doExecuteCommand(cmd, 'addLabel', new_label,\n                                [$scope.selection.state.stamp])\n          .then(function() { $scope.$digest(); });\n        $scope.edit.label = '';\n      };\n      $scope.doRemoveLabel = function doRemoveLabel(label) {\n        var cmd = ($scope.type === 'template') ? 'onTemplates' : 'onModels';\n        $scope.doExecuteCommand(cmd, 'removeLabel', label,\n                                [$scope.selection.state.stamp])\n          .then(function() { $scope.$digest(); });\n      };\n    }\n  ]);\n\nangular.module('clickApp.directives')\n  .directive('clickGameSelectionDetail', [\n    '$window',\n    'game',\n    'gameMap',\n    function($window,\n             gameService,\n             gameMapService) {\n      return {\n        restrict: 'A',\n        scope: true,\n        controller: 'clickGameSelectionDetailCtrl',\n        link: function(scope, element/*, attrs*/) {\n          console.log('gameSelectionDetail');\n          var viewport = document.getElementById('viewport');\n          var map = document.getElementById('map');\n\n          scope.type = 'model';\n          closeSelectionDetail();\n\n          // $window.requestAnimationFrame(function _digest() {\n          //   scope.$digest();\n          // });\n          \n          function openSelectionDetail($event, type, selection) {\n            // console.log('openSelectionDetail');\n            scope.type = type;\n            scope.selection = selection;\n            scope.edit = { label: '',\n                           max_deviation: 0\n                         };\n            scope.updateOnOpen();\n            $window.requestAnimationFrame(displaySelectionDetail);\n          }\n          function closeSelectionDetail() {\n            // console.log('closeSelectionDetail');\n            scope.selection = {};\n            $window.requestAnimationFrame(function _closeSelectionDetail() {\n              scope.$digest();\n              element[0].style.display = 'none';\n              element[0].style.visibility = 'hidden';\n              element[0].style.left = 0+'px';\n              element[0].style.top = 0+'px';\n            });\n          }\n          function displaySelectionDetail() {\n            scope.$digest();\n            element[0].style.display = 'initial';\n            element[0].style.visibility = 'hidden';\n            $window.requestAnimationFrame(showSelectionDetail);\n          }\n          function showSelectionDetail() {\n            placeSelectionDetail();\n            element[0].style.visibility = 'visible';\n          }\n          function placeSelectionDetail() {\n            var detail_rect = element[0].getBoundingClientRect();\n            var screen_pos = gameMapService.mapToScreenCoordinates(map, scope.selection.state);\n            var viewport_rect = viewport.getBoundingClientRect();\n            if(detailCanFitRight(viewport_rect, detail_rect, screen_pos)) {\n              element[0].style.left = alignRight(detail_rect, screen_pos);\n            }\n            else {\n              element[0].style.left = alignLeft(detail_rect, screen_pos);\n            }\n            if(detailCanFitBottom(viewport_rect, detail_rect, screen_pos)) {\n              element[0].style.top = alignBottom(detail_rect, screen_pos);\n            }\n            else {\n              element[0].style.top = alignTop(detail_rect, screen_pos);\n            }\n          }\n          function detailCanFitRight(viewport_rect, detail_rect, screen_pos) {\n            return screen_pos.x + detail_rect.width <= viewport_rect.right;\n          }\n          function alignRight(detail_rect, screen_pos) {\n            return screen_pos.x+'px';\n          }\n          function alignLeft(detail_rect, screen_pos) {\n            return Math.max(0, screen_pos.x-detail_rect.width)+'px';\n          }\n          function detailCanFitBottom(viewport_rect, detail_rect, screen_pos) {\n            return screen_pos.y + detail_rect.height <= viewport_rect.bottom;\n          }\n          function alignBottom(detail_rect, screen_pos) {\n            return screen_pos.y+'px';\n          }\n          function alignTop(detail_rect, screen_pos) {\n            return Math.max(0, screen_pos.y-detail_rect.height)+'px';\n          }\n\n          scope.onGameEvent('openSelectionDetail', openSelectionDetail, scope);\n          scope.onGameEvent('closeSelectionDetail', closeSelectionDetail, scope);\n          scope.doClose = closeSelectionDetail;\n        }\n      };\n    }\n  ]);\n"]}