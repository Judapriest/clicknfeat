{"version":3,"sources":["../../es6/directives/gameSelectionDetail.js"],"names":[],"mappings":"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","file":"gameSelectionDetail.js","sourcesContent":["angular.module('clickApp.directives')\n  .controller('clickGameSelectionDetailCtrl', [\n    '$scope',\n    'game',\n    'gameFactions',\n    function($scope,\n             gameService,\n             gameFactionsService) {\n      console.log('init clickGameSelectionDetailCtrl');\n      let state = $scope.state;\n\n      $scope.edit = { label: '',\n                      max_deviation: 0\n                    };\n      var updateOnOpenType = {\n        template: () => {\n          $scope.edit.max_deviation = R.pathOr(0, ['state','m'], $scope.selection);\n        },\n        model: () => {\n          gameFactionsService\n            .getModelInfo($scope.selection.state.info, state.factions)\n            .then((info) => {\n              $scope.info = info;\n              $scope.$digest();\n            });\n        }\n      };\n      $scope.show = { info: false };\n      $scope.updateOnOpen = () => {\n        $scope.show.info = false;\n        updateOnOpenType[$scope.type]();\n      };\n      $scope.labelDisplay = (l) => {\n        return s.truncate(l, 12);\n      };\n\n      $scope.doSetMaxDeviation = () => {\n        var max = ($scope.edit.max_deviation > 0) ? $scope.edit.max_deviation : null;\n        $scope.stateEvent('Game.command.execute',\n                          'onTemplates', [ 'setMaxDeviation', [max],\n                                           [$scope.selection.state.stamp]\n                                         ]);\n      };\n      $scope.doAddLabel = () => {\n        var cmd = ($scope.type === 'template') ? 'onTemplates' : 'onModels';\n        var new_label = s.trim($scope.edit.label);\n        if(R.length(new_label) === 0) return;\n\n        $scope.stateEvent('Game.command.execute',\n                          cmd, [ 'addLabel', [new_label],\n                                 [$scope.selection.state.stamp]\n                               ])\n          .then(() => { $scope.$digest(); });\n        $scope.edit.label = '';\n      };\n      $scope.doRemoveLabel = (label) => {\n        var cmd = ($scope.type === 'template') ? 'onTemplates' : 'onModels';\n        $scope.stateEvent('Game.command.execute',\n                          cmd, [ 'removeLabel', [label],\n                                 [$scope.selection.state.stamp]\n                               ])\n          .then(() => { $scope.$digest(); });\n      };\n    }\n  ])\n  .directive('clickGameSelectionDetail', [\n    '$window',\n    'game',\n    'gameMap',\n    function($window,\n             gameService,\n             gameMapService) {\n      return {\n        restrict: 'A',\n        scope: true,\n        controller: 'clickGameSelectionDetailCtrl',\n        link: function(scope, element) {\n          console.log('gameSelectionDetail');\n          var viewport = document.getElementById('viewport');\n          var map = document.getElementById('map');\n\n          scope.type = 'model';\n          closeSelectionDetail();\n\n          function openSelectionDetail($event, type, selection) {\n            // console.log('openSelectionDetail');\n            scope.type = type;\n            scope.selection = selection;\n            scope.edit = { label: '',\n                           max_deviation: 0\n                         };\n            scope.updateOnOpen();\n            $window.requestAnimationFrame(displaySelectionDetail);\n          }\n          function closeSelectionDetail() {\n            // console.log('closeSelectionDetail');\n            scope.selection = {};\n            element[0].style.display = 'none';\n            element[0].style.visibility = 'hidden';\n            element[0].style.left = 0+'px';\n            element[0].style.top = 0+'px';\n          }\n          function displaySelectionDetail() {\n            scope.$digest();\n            element[0].style.display = 'initial';\n            element[0].style.visibility = 'hidden';\n            $window.requestAnimationFrame(showSelectionDetail);\n          }\n          function showSelectionDetail() {\n            placeSelectionDetail();\n            element[0].style.visibility = 'visible';\n          }\n          function placeSelectionDetail() {\n            var detail_rect = element[0].getBoundingClientRect();\n            var screen_pos = gameMapService.mapToScreenCoordinates(map, scope.selection.state);\n            var viewport_rect = viewport.getBoundingClientRect();\n            if(detailCanFitRight(viewport_rect, detail_rect, screen_pos)) {\n              element[0].style.left = alignRight(detail_rect, screen_pos);\n            }\n            else {\n              element[0].style.left = alignLeft(detail_rect, screen_pos);\n            }\n            if(detailCanFitBottom(viewport_rect, detail_rect, screen_pos)) {\n              element[0].style.top = alignBottom(detail_rect, screen_pos);\n            }\n            else {\n              element[0].style.top = alignTop(detail_rect, screen_pos);\n            }\n          }\n          function detailCanFitRight(viewport_rect, detail_rect, screen_pos) {\n            return screen_pos.x + detail_rect.width <= viewport_rect.right;\n          }\n          function alignRight(detail_rect, screen_pos) {\n            return screen_pos.x+'px';\n          }\n          function alignLeft(detail_rect, screen_pos) {\n            return Math.max(0, screen_pos.x-detail_rect.width)+'px';\n          }\n          function detailCanFitBottom(viewport_rect, detail_rect, screen_pos) {\n            return screen_pos.y + detail_rect.height <= viewport_rect.bottom;\n          }\n          function alignBottom(detail_rect, screen_pos) {\n            return screen_pos.y+'px';\n          }\n          function alignTop(detail_rect, screen_pos) {\n            return Math.max(0, screen_pos.y-detail_rect.height)+'px';\n          }\n\n          scope.onStateChangeEvent('Game.selectionDetail.open', openSelectionDetail, scope);\n          scope.onStateChangeEvent('Game.selectionDetail.close', closeSelectionDetail, scope);\n          scope.doClose = closeSelectionDetail;\n        }\n      };\n    }\n  ]);\n"]}