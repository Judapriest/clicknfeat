{"version":3,"sources":["../../es6/directives/gameLos.js"],"names":[],"mappings":"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","file":"gameLos.js","sourcesContent":["angular.module('clickApp.directives')\n  .directive('clickGameLos', [\n    'modes',\n    'gameLos',\n    'gameModels',\n    'gameFactions',\n    function(modesService,\n             gameLosService,\n             gameModelsService,\n             gameFactionsService) {\n      return {\n        restrict: 'A',\n        link: (scope, parent) => {\n          let map = document.getElementById('map');\n          let under_models_container = document.getElementById('game-under-models');\n          let svgNS = map.namespaceURI;\n\n          let state = scope.state;\n          let local_element = createLosElement(svgNS, under_models_container, parent[0]);\n          let remote_element = createLosElement(svgNS, under_models_container, parent[0]);\n\n          scope.onStateChangeEvent('Game.los.local.change', () => {\n            updateLine(state.game.los.local, local_element.line);\n          }, scope);\n          scope.onStateChangeEvent('Game.los.remote.change', () => {\n            updateLine(state.game.los.remote, remote_element.line);\n\n            let display = ( gameLosService.isDisplayed(state.game.los) ||\n                            'LoS' === modesService.currentModeName(state.modes)\n                          );\n            updateEnvelope(state.game.los, display, remote_element.envelope);\n            updateOriginTarget(state.factions, state.game.models,\n                               gameLosService.origin(state.game.los), display,\n                               remote_element.origin);\n            updateOriginTarget(state.factions, state.game.models,\n                               gameLosService.target(state.game.los), display,\n                               remote_element.target);\n          }, scope);\n        }\n      };\n      function createLosElement(svgNS, under_models_container, parent) {\n        let group = document.createElementNS(svgNS, 'g');\n        parent.appendChild(group);\n\n        let line = document.createElementNS(svgNS, 'line');\n        line.style['marker-start'] = 'url(#los-start)';\n        line.style['marker-end'] = 'url(#los-end)';\n        group.appendChild(line);\n\n        let origin = document.createElementNS(svgNS, 'circle');\n        origin.classList.add('los-origin');\n        origin.setAttribute('cx', '0');\n        origin.setAttribute('cy', '0');\n        origin.setAttribute('r', '0');\n        origin.style.visibility = 'hidden';\n        parent.appendChild(origin);\n\n        let target = document.createElementNS(svgNS, 'circle');\n        target.classList.add('los-target');\n        target.setAttribute('cx', '0');\n        target.setAttribute('cy', '0');\n        target.setAttribute('r', '0');\n        target.style.visibility = 'hidden';\n        parent.appendChild(target);\n\n        let envelope = document.createElementNS(svgNS, 'polygon');\n        envelope.classList.add('los-envelope');\n        envelope.setAttribute('points', '0,0 0,0 0,0');\n        envelope.style.visibility = 'hidden';\n        under_models_container.insertBefore(envelope, under_models_container.firstChild);\n\n        return { container: group,\n                 line: line,\n                 origin: origin,\n                 target: target,\n                 envelope: envelope\n               };\n      }\n      function updateLine(los, line) {\n        line.style['visibility'] = los.display ? 'visible' : 'hidden';\n        line.setAttribute('x1', los.start.x+'');\n        line.setAttribute('y1', los.start.y+'');\n        line.setAttribute('x2', los.end.x+'');\n        line.setAttribute('y2', los.end.y+'');\n      }\n      function updateEnvelope(los, display, envelope) {\n        let {\n          left:  { start: { x: x1 = 0, y: y1 = 0 } = {},\n                   end:   { x: x2 = 0, y: y2 = 0 } = {}\n                 } = {},\n          right: { start: { x: x4 = 0, y: y4 = 0 } = {},\n                   end:   { x: x3 = 0, y: y3 = 0 } = {}\n                 } = {}\n        } = R.pathOr({}, ['computed', 'envelope'], los);\n        let points = [\n          [ x1, y1 ].join(','),\n          [ x2, y2 ].join(','),\n          [ x3, y3 ].join(','),\n          [ x4, y4 ].join(','),\n        ].join(' ');\n        // console.log('gameLos envelope points', points);\n        envelope.setAttribute('points', points);\n        envelope.style['visibility'] = display ? 'visible' : 'hidden';\n      }\n      function updateOriginTarget(factions, models, stamp, display, element) {\n        R.pipeP(\n          (stamp) => {\n            if(R.exists(stamp)) {\n              return gameModelsService.findStamp(stamp, models);\n            }\n            return self.Promise.reject();\n          },\n          (model) => {\n            if( !display ||\n                R.isNil(model) ) {\n              element.style.visibility = 'hidden';\n              return self.Promise.reject();\n            }\n            return R.pipeP(\n              gameFactionsService.getModelInfo$(model.state.info),\n              (info) => {\n                element.setAttribute('cx', model.state.x+'');\n                element.setAttribute('cy', model.state.y+'');\n                element.setAttribute('r', info.base_radius+'');\n                element.style.visibility = 'visible';\n              }\n            )(factions);\n          }\n        )(stamp).catch(R.always(null));\n      }\n    }\n  ])\n  .directive('clickGameLosClip', [\n    function() {\n      return {\n        restrict: 'A',\n        link: (scope, element) => {\n          let state = scope.state;\n\n          scope.onStateChangeEvent('Game.loaded', () => {\n            updateEnvelope(state.game.los, element[0]);\n          }, scope);\n\n          scope.onStateChangeEvent('Game.los.remote.change', () => {\n            updateEnvelope(state.game.los, element[0]);\n          }, scope);\n        }\n      };\n      function updateEnvelope(los, envelope) {\n        let {\n          left:  { start: { x: x1 = 0, y: y1 = 0 } = {},\n                   end:   { x: x2 = 0, y: y2 = 0 } = {}\n                 } = {},\n          right: { start: { x: x4 = 0, y: y4 = 0 } = {},\n                   end:   { x: x3 = 0, y: y3 = 0 } = {}\n                 } = {}\n        } = R.pathOr({}, ['computed', 'envelope'], los);\n        let points = [\n          [ x1, y1 ].join(','),\n          [ x2, y2 ].join(','),\n          [ x3, y3 ].join(','),\n          [ x4, y4 ].join(','),\n        ].join(' ');\n        // console.log('gameLos clip points', points, los);\n        envelope.setAttribute('points', points);\n      }\n    }\n  ])\n  .directive('clickGameLosDarkness', [\n    'gameLos',\n    'modes',\n    function(gameLosService,\n             modesService) {\n      return {\n        restrict: 'A',\n        link: (scope, element) => {\n          let state = scope.state;\n          updatePolygon(scope, state, element[0]);\n\n          scope.onStateChangeEvent('Game.remote.los.change', () => {\n            updatePolygon(scope, state, state.game.los, element[0]);\n          }, scope);\n        }\n      };\n      function updatePolygon(scope, state, polygon) {\n        let {\n          left:  { start: { x: x1 = 0, y: y1 = 0 } = {},\n                   end:   { x: x2 = 0, y: y2 = 0 } = {}\n                 } = {},\n          right: { start: { x: x4 = 0, y: y4 = 0 } = {},\n                   end:   { x: x3 = 0, y: y3 = 0 } = {}\n                 } = {}\n        } = R.propOr({}, 'envelope', scope);\n        let points = [\n          [ x1, y1 ].join(','),\n          [ x2, y2 ].join(','),\n          [ x3, y3 ].join(','),\n          [ x4, y4 ].join(','),\n        ].join(' ');\n        // console.log('gameLosDarkness envelope points', points);\n        polygon.setAttribute('points', points);\n\n        let display = ( gameLosService.isDisplayed(state.game.los) ||\n                        'LoS' === modesService.currentModeName(state.modes)\n                      );\n        polygon.style['visibility'] = display ? 'visible' : 'hidden';\n      }\n    }\n  ])\n  .directive('clickGameLosRefresh', [\n    function() {\n      return {\n        restrict: 'A',\n        scope: true,\n        link: (scope) => {\n          // console.log('gameLosRefresh', scope);\n\n          scope.digestOnStateChangeEvent('Game.los.remote.change', scope);\n        }\n      };\n    }\n  ]);\n"]}