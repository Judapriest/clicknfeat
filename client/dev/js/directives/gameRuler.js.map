{"version":3,"sources":["../../es6/directives/gameRuler.js"],"names":[],"mappings":"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","file":"gameRuler.js","sourcesContent":["angular.module('clickApp.directives')\n  .directive('clickGameRuler', [\n    'gameMap',\n    'labelElement',\n    'gameRuler',\n    'gameModels',\n    'gameFactions',\n    'modes',\n    function(gameMapService,\n             labelElementService,\n             gameRulerService,\n             gameModelsService,\n             gameFactionsService,\n             modesService) {\n      return {\n        restrict: 'A',\n        link: function(scope, parent) {\n          let map = document.getElementById('map');\n          let svgNS = map.namespaceURI;\n\n          let state = scope.state;\n          let local_element = createRulerElement(svgNS, parent[0]);\n          let remote_element = createRulerElement(svgNS, parent[0]);\n\n          scope.onStateChangeEvent('Game.ruler.local.change', () => {\n            updateRuler(map, state.game.ruler.local, local_element);\n          }, scope);\n          scope.onStateChangeEvent('Game.ruler.remote.change', () => {\n            updateRuler(map, state.game.ruler.remote, remote_element);\n\n            let display = ( gameRulerService.isDisplayed(state.game.ruler) ||\n                            'Ruler' === modesService.currentModeName(state.modes)\n                          );\n            updateOrigin(state.factions, state.game.models,\n                         state.game.ruler, display,\n                         remote_element.origin);\n            updateTarget(state.factions, state.game.models,\n                         state.game.ruler, display,\n                         remote_element.target);\n          }, scope);\n          scope.onStateChangeEvent('Game.map.flipped', () => {\n            updateRulerOnMapFlipped(map, state.game.ruler.local, local_element);\n            updateRulerOnMapFlipped(map, state.game.ruler.remote, remote_element);\n          }, scope);\n        }\n      };\n      function createRulerElement(svgNS, parent) {\n        let group = document.createElementNS(svgNS, 'g');\n        parent.appendChild(group);\n\n        let line = document.createElementNS(svgNS, 'line');\n        line.style['marker-start'] = 'url(#ruler-start)';\n        line.style['marker-end'] = 'url(#ruler-end)';\n        group.appendChild(line);\n\n        let label = labelElementService.create(svgNS, group);\n\n        let origin = document.createElementNS(svgNS, 'circle');\n        origin.classList.add('ruler-origin');\n        origin.setAttribute('cx', '0');\n        origin.setAttribute('cy', '0');\n        origin.setAttribute('r', '0');\n        origin.style.visibility = 'hidden';\n        parent.appendChild(origin);\n\n        let target = document.createElementNS(svgNS, 'circle');\n        target.classList.add('ruler-target');\n        target.setAttribute('cx', '0');\n        target.setAttribute('cy', '0');\n        target.setAttribute('r', '0');\n        target.style.visibility = 'hidden';\n        parent.appendChild(target);\n\n        return { container: group,\n                 line: line,\n                 label: label,\n                 origin: origin,\n                 target: target\n               };\n      }\n      function updateRuler(map, ruler, element) {\n        let map_flipped = gameMapService.isFlipped(map);\n        let zoom_factor = gameMapService.zoomFactor(map);\n        let label_flip_center = {\n          x: (ruler.end.x - ruler.start.x) / 2 + ruler.start.x,\n          y: (ruler.end.y - ruler.start.y) / 2 + ruler.start.y\n        };\n        let label_text = ruler.display ? ruler.length : '';\n        updateLine(ruler.display, ruler, element.line);\n        labelElementService.update(map_flipped,\n                                   zoom_factor,\n                                   label_flip_center,\n                                   label_flip_center,\n                                   label_text,\n                                   element.label);\n      }\n      function updateRulerOnMapFlipped(map, ruler, element) {\n        let label_flip_center = {\n          x: (ruler.end.x - ruler.start.x) / 2 + ruler.start.x,\n          y: (ruler.end.y - ruler.start.y) / 2 + ruler.start.y\n        };\n        labelElementService.updateOnFlipMap(map, label_flip_center, element.label);\n      }\n      function updateLine(visible, ruler, line) {\n        line.style['visibility'] = visible ? 'visible' : 'hidden';\n        line.setAttribute('x1', ruler.start.x+'');\n        line.setAttribute('y1', ruler.start.y+'');\n        line.setAttribute('x2', ruler.end.x+'');\n        line.setAttribute('y2', ruler.end.y+'');\n      }\n      function updateOrigin(factions, models, ruler, display, element) {\n        let origin = gameRulerService.origin(ruler);\n        R.pipeP(\n          function(origin) {\n            if(R.isNil(origin)) {\n              return self.Promise.reject();\n            }\n            return gameModelsService.findStamp(origin, models);\n          },\n          function(origin_model) {\n            if(!display ||\n               R.isNil(origin_model)) {\n              element.style.visibility = 'hidden';\n              return self.Promise.reject();\n            }\n            return R.pipeP(\n              gameFactionsService.getModelInfo$(origin_model.state.info),\n              (info) => {\n                element.setAttribute('cx', origin_model.state.x+'');\n                element.setAttribute('cy', origin_model.state.y+'');\n                element.setAttribute('r', info.base_radius+'');\n                element.style.visibility = 'visible';\n              }\n            )(factions);\n          }\n        )(origin).catch(R.always(null));\n      }\n      function updateTarget(factions, models, ruler, display, element) {\n        let target = gameRulerService.target(ruler);\n        R.pipeP(\n          function(target) {\n            if(R.isNil(target)) {\n              return self.Promise.reject();\n            }\n            return gameModelsService.findStamp(target, models);\n          },\n          function(target_model) {\n            if(!display ||\n               R.isNil(target_model)) {\n              element.style.visibility = 'hidden';\n              return self.Promise.reject();\n            }\n\n            if(gameRulerService.targetReached(ruler)) {\n              element.classList.add('reached');\n            }\n            else {\n              element.classList.remove('reached');\n            }\n\n            return R.pipeP(\n              gameFactionsService.getModelInfo$(target_model.state.info),\n              (info) => {\n                element.setAttribute('cx', target_model.state.x+'');\n                element.setAttribute('cy', target_model.state.y+'');\n                element.setAttribute('r', info.base_radius+'');\n                element.style.visibility = 'visible';\n              }\n            )(factions);\n          }\n        )(target).catch(R.always(null));\n      }\n    }\n  ]);\n"]}