{"version":3,"sources":["../../../es6/services/user/connection.js"],"names":[],"mappings":"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","file":"connection.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('userConnection', [\n    'http',\n    'pubSub',\n    'websocket',\n    function userConnectionServiceFactory(httpService,\n                                          pubSubService,\n                                          websocketService) {\n      var userConnectionService = {\n        init: function userConnectionInit(user) {\n          let connection = {\n            state: { socket: null }\n          };\n          return R.assoc('connection', connection, user);\n        },\n        open: function userConnectionOpen(state, user) {\n          if(R.exists(user.connection.state.socket)) {\n            return self.Promise.resolve(user);\n          }\n\n          var handlers = {\n            close: closeHandler$(state),\n            users: usersMessageHandler$(state),\n            games: gamesMessageHandler$(state),\n            chat: chatMessageHandler$(state)\n          };\n\n          user = R.assocPath(['connection','state','socket'], null, user);\n          return R.pipeP(\n            () => {\n              return websocketService\n                .create('/api/users/'+user.state.stamp, 'user', handlers);\n            },\n            (socket) => {\n              return R.assocPath(['connection','state','socket'], socket, user);\n            }\n          )();\n        },\n        close: function userConnectionClose(user) {\n          return R.pipeP(\n            () => {\n              if(R.isNil(user.connection.state.socket)) {\n                return self.Promise.resolve();\n              }\n              return websocketService\n                .close(user.connection.state.socket);\n            },\n            () => {\n              return R.assoc('connection', cleanupConnection(user.connection), user);\n            }\n          )();\n        },\n        active: function userConnectionActive(user) {\n          return R.pipe(\n            R.path(['connection','state','socket']),\n            R.exists\n          )(user);\n        },\n        sendChat: function userConnectionSendChat(chat, user) {\n          if(!userConnectionService.active(user)) {\n            return self.Promise.reject('Not active');\n          }\n\n          chat = R.pipe(\n            R.assoc('type', 'chat'),\n            R.assoc('from', user.state.stamp)\n          )(chat);\n          return websocketService\n            .send(chat, user.connection.state.socket);\n        },\n        userNameForStamp: function userNameForStamp(stamp, user) {\n          return R.pipe(\n            userForStamp$(stamp),\n            R.defaultTo({ name: 'Unknown' }),\n            R.prop('name'),\n            (n) => {\n              return s(n).trim().capitalize().value();\n            }\n          )(user.connection);\n        },\n        usersNamesForStamps: function usersNamesForStamps(stamps, user) {\n          return R.pipe(\n            R.defaultTo({}),\n            R.propOr({}, 'connection'),\n            usersForStamps$(R.defaultTo([], stamps)),\n            R.pluck('name'),\n            (names) => {\n              return ( R.isEmpty(names) ?\n                       [ 'Unknown' ] :\n                       names\n                     );\n            },\n            R.map((n) => {\n              return s(n).trim().capitalize().value();\n            })\n          )(user);\n        }\n      };\n      function cleanupConnection(connection) {\n        return R.pipe(\n          R.assocPath(['state','socket'], null),\n          R.assoc('users', [])\n        )(connection);\n      }\n      function closeHandler$(state) {\n        return () => {\n          console.error('User connection: close');\n          state.event('User.connection.close');\n        };\n      }\n      var usersMessageHandler$ = R.curry(function usersMessageHandler(state, msg) {\n        console.log('User connection: users list', msg);\n        state.event('User.setOnlineUsers', R.pipe(\n          R.propOr([], 'users'),\n          R.sortBy(R.compose(R.toLower, R.prop('name')))\n        )(msg));\n      });\n      var gamesMessageHandler$ = R.curry(function gamesMessageHandler(state, msg) {\n        console.log('User connection: games list', msg);\n        state.event('User.setOnlineGames', R.pipe(\n          R.propOr([], 'games')\n        )(msg));\n      });\n      var chatMessageHandler$ = R.curry(function chatMessageHandler(state, msg) {\n        console.log('User connection: chat msg', msg);\n        state.event('User.newChatMsg', msg);\n      });\n      var userForStamp$ = R.curry(function userForStamp(stamp, connection) {\n        return R.pipe(\n          R.prop('users'),\n          R.find(R.propEq('stamp', stamp))\n        )(connection);\n      });\n      var usersForStamps$ = R.curry(function usersForStamps(stamps, connection) {\n        return R.pipe(\n          R.map(R.flip(userForStamp$)(connection)),\n          R.reject(R.isNil)\n        )(stamps);\n      });\n      R.curryService(userConnectionService);\n      return userConnectionService;\n    }\n  ]);\n"]}