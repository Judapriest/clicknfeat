{"version":3,"sources":["../../../es6/services/modes/terrain.js"],"names":[],"mappings":"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","file":"terrain.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('terrainMode', [\n    'modes',\n    'settings',\n    'defaultMode',\n    'terrain',\n    'game',\n    'gameTerrains',\n    'gameTerrainSelection',\n    function terrainModeServiceFactory(modesService,\n                                       settingsService,\n                                       defaultModeService,\n                                       terrainService,\n                                       gameService,\n                                       gameTerrainsService,\n                                       gameTerrainSelectionService) {\n      var terrain_actions = Object.create(defaultModeService.actions);\n      function clearTerrainSelection(scope/*, event*/) {\n        scope.game.terrain_selection = gameTerrainSelectionService\n          .clear('local', scope, scope.game.terrain_selection);\n      }\n      terrain_actions.modeBackToDefault = clearTerrainSelection;\n      terrain_actions.clickMap = clearTerrainSelection;\n      terrain_actions.rightClickMap = clearTerrainSelection;\n      terrain_actions.copySelection = function terrainsCopySelection(scope) {\n        var stamps = gameTerrainSelectionService.get('local', scope.game.terrain_selection);\n        return R.pipeP(\n          gameTerrainsService.copyStamps$(stamps),\n          (copy) => {\n            scope.create.terrain = copy;\n            return scope.doSwitchToMode('CreateTerrain');\n          }\n        )(scope.game.terrains);\n      };\n      terrain_actions.delete = function terrainDelete(scope) {\n        var stamps = gameTerrainSelectionService\n              .get('local', scope.game.terrain_selection);\n        return gameService.executeCommand('deleteTerrain', stamps,\n                                          scope, scope.game);\n      };\n      terrain_actions.toggleLock = function terrainLock(scope) {\n        var stamps = gameTerrainSelectionService.get('local', scope.game.terrain_selection);\n        return R.pipeP(\n          () => {\n            return gameTerrainsService\n              .findStamp(stamps[0], scope.game.terrains);\n          },\n          (terrain) => {\n            var is_locked = terrainService.isLocked(terrain);\n        \n            return gameService\n              .executeCommand('lockTerrains', !is_locked, stamps,\n                              scope, scope.game);\n          }\n        )();\n      };\n      var moves = [\n        ['moveFront', 'up'],\n        ['moveBack', 'down'],\n        ['rotateLeft', 'left'],\n        ['rotateRight', 'right'],\n      ];\n      R.forEach(function(move) {\n        terrain_actions[move[0]] = function terrainMove(scope) {\n          var stamps = gameTerrainSelectionService.get('local', scope.game.terrain_selection);\n          return gameService.executeCommand('onTerrains', move[0], false,\n                                            stamps, scope, scope.game);\n        };\n        terrain_actions[move[0]+'Small'] = function terrainMove(scope) {\n          var stamps = gameTerrainSelectionService.get('local', scope.game.terrain_selection);\n          return gameService.executeCommand('onTerrains', move[0], true,\n                                            stamps, scope, scope.game);\n        };\n      }, moves);\n      var shifts = [\n        ['shiftUp', 'ctrl+up', 'shiftDown'],\n        ['shiftDown', 'ctrl+down', 'shiftUp'],\n        ['shiftLeft', 'ctrl+left', 'shiftRight'],\n        ['shiftRight', 'ctrl+right', 'shiftLeft'],\n      ];\n      R.forEach(function(shift) {\n        terrain_actions[shift[0]] = function modelsShift(scope) {\n          var stamps = gameTerrainSelectionService.get('local', scope.game.terrain_selection);\n          var terrain_shift = R.path(['ui_state', 'flip_map'], scope) ? shift[2] : shift[0];\n          return gameService.executeCommand('onTerrains', terrain_shift, false,\n                                            stamps, scope, scope.game);\n        };\n        terrain_actions[shift[0]+'Small'] = function terrainsShiftSmall(scope) {\n          var stamps = gameTerrainSelectionService.get('local', scope.game.terrain_selection);\n          var terrain_shift = R.path(['ui_state', 'flip_map'], scope) ? shift[2] : shift[0];\n          return gameService.executeCommand('onTerrains', terrain_shift, true,\n                                            stamps, scope, scope.game);\n        };\n      }, shifts);\n\n      (function() {\n        var drag_terrain_start_state;\n        function updateStateWithDelta(event, state) {\n          var dx = event.now.x - event.start.x;\n          var dy = event.now.y - event.start.y;\n          state.x = drag_terrain_start_state.x + dx;\n          state.y = drag_terrain_start_state.y + dy;\n        }\n        terrain_actions.dragStartTerrain = function terrainDragStartTerrain(scope, event) {\n          if(terrainService.isLocked(event.target)) {\n            return self.Promise.reject('Terrain is locked');\n          }\n\n          drag_terrain_start_state = R.clone(event.target.state);\n          terrain_actions.dragTerrain(scope, event);\n          scope.game.terrain_selection = gameTerrainSelectionService\n            .set('local', [event.target.state.stamp],\n                 scope, scope.game.terrain_selection);\n        };\n        defaultModeService.actions.dragStartTerrain = terrain_actions.dragStartTerrain;\n        terrain_actions.dragTerrain = function terrainDragTerrain(scope, event) {\n          if(terrainService.isLocked(event.target)) {\n            return self.Promise.reject('Terrain is locked');\n          }\n\n          updateStateWithDelta(event, event.target.state);\n          scope.gameEvent('changeTerrain-'+event.target.state.stamp);\n        };\n        terrain_actions.dragEndTerrain = function terrainDragEndTerrain(scope, event) {\n          if(terrainService.isLocked(event.target)) {\n            return self.Promise.reject('Terrain is locked');\n          }\n\n          terrainService.setPosition(drag_terrain_start_state, event.target);\n          var end_state = R.clone(drag_terrain_start_state);\n          updateStateWithDelta(event, end_state);\n          return gameService.executeCommand('onTerrains', 'setPosition', end_state,\n                                            [event.target.state.stamp],\n                                            scope, scope.game);\n        };\n      })();\n\n      var terrain_default_bindings = {\n        'clickMap': 'clickMap',\n        'rightClickMap': 'rightClickMap',\n        'copySelection': 'ctrl+c',\n        'delete': 'del',\n        'toggleLock': 'l'\n      };\n      R.forEach(function(move) {\n        terrain_default_bindings[move[0]] = move[1];\n        terrain_default_bindings[move[0]+'Small'] = 'shift+'+move[1];\n      }, moves);\n      R.forEach(function(shift) {\n        terrain_default_bindings[shift[0]] = shift[1];\n        terrain_default_bindings[shift[0]+'Small'] = 'shift+'+shift[1];\n      }, shifts);\n      var terrain_bindings = R.extend(Object.create(defaultModeService.bindings),\n                                       terrain_default_bindings);\n      var terrain_buttons = [\n        [ 'Delete', 'delete' ],\n        [ 'Lock/Unlock', 'toggleLock' ],\n      ];\n      var terrain_mode = {\n        onEnter: function terrainOnEnter(/*scope*/) {\n        },\n        onLeave: function terrainOnLeave(/*scope*/) {\n        },\n        name: 'Terrain',\n        actions: terrain_actions,\n        buttons: terrain_buttons,\n        bindings: terrain_bindings\n      };\n      modesService.registerMode(terrain_mode);\n      settingsService.register('Bindings',\n                               terrain_mode.name,\n                               terrain_default_bindings,\n                               function(bs) {\n                                 R.extend(terrain_mode.bindings, bs);\n                               });\n      return terrain_mode;\n    }\n  ]);\n"]}