{"version":3,"sources":["../../../es6/services/modes/template.js"],"names":[],"mappings":"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","file":"template.js","sourcesContent":["'use strict';\n\nangular.module('clickApp.services')\n  .factory('templateMode', [\n    'modes',\n    'settings',\n    'defaultMode',\n    'template',\n    'game',\n    'gameTemplates',\n    'gameTemplateSelection',\n    function templateModeServiceFactory(modesService,\n                                        settingsService,\n                                        defaultModeService,\n                                        templateService,\n                                        gameService,\n                                        gameTemplatesService,\n                                        gameTemplateSelectionService) {\n      var template_actions = Object.create(defaultModeService.actions);\n      function clearTemplateSelection(scope/*, event*/) {\n        scope.game.template_selection =\n          gameTemplateSelectionService.clear('local', scope, scope.game.template_selection);\n      }\n      template_actions.modeBackToDefault = clearTemplateSelection;\n      template_actions.clickMap = clearTemplateSelection;\n      template_actions.rightClickMap = clearTemplateSelection;\n      template_actions.delete = function templateDelete(scope) {\n        var stamps = gameTemplateSelectionService.get('local', scope.game.template_selection);\n        return gameService.executeCommand('deleteTemplates', stamps,\n                                          scope, scope.game);\n      };\n      template_actions.toggleLock = function templateLock(scope) {\n        var stamps = gameTemplateSelectionService.get('local', scope.game.template_selection);\n        return gameTemplatesService.findStamp(stamps[0], scope.game.templates)\n          .then(function(template) {\n            var is_locked = templateService.isLocked(template);\n        \n            return gameService\n              .executeCommand('lockTemplates', !is_locked, stamps,\n                              scope, scope.game);\n          });\n      };\n      var moves = [\n        ['moveFront', 'up'],\n        ['moveBack', 'down'],\n        ['rotateLeft', 'left'],\n        ['rotateRight', 'right'],\n      ];\n      R.forEach(function(move) {\n        template_actions[move[0]] = function templateMove(scope) {\n          var stamps = gameTemplateSelectionService.get('local', scope.game.template_selection);\n          return gameService.executeCommand('onTemplates', move[0], false,\n                                            stamps, scope, scope.game);\n        };\n        template_actions[move[0]+'Small'] = function templateMove(scope) {\n          var stamps = gameTemplateSelectionService.get('local', scope.game.template_selection);\n          return gameService.executeCommand('onTemplates', move[0], true,\n                                            stamps, scope, scope.game);\n        };\n      }, moves);\n      var shifts = [\n        ['shiftUp', 'ctrl+up', 'shiftDown'],\n        ['shiftDown', 'ctrl+down', 'shiftUp'],\n        ['shiftLeft', 'ctrl+left', 'shiftRight'],\n        ['shiftRight', 'ctrl+right', 'shiftLeft'],\n      ];\n      R.forEach(function(shift) {\n        template_actions[shift[0]] = function modelsShift(scope) {\n          var stamps = gameTemplateSelectionService.get('local', scope.game.template_selection);\n          var template_shift = R.path(['ui_state', 'flip_map'], scope) ? shift[2] : shift[0];\n          return gameService.executeCommand('onTemplates', template_shift, false,\n                                            stamps, scope, scope.game);\n        };\n        template_actions[shift[0]+'Small'] = function templatesShiftSmall(scope) {\n          var stamps = gameTemplateSelectionService.get('local', scope.game.template_selection);\n          var template_shift = R.path(['ui_state', 'flip_map'], scope) ? shift[2] : shift[0];\n          return gameService.executeCommand('onTemplates', template_shift, true,\n                                            stamps, scope, scope.game);\n        };\n      }, shifts);\n\n      (function() {\n        var drag_template_start_state;\n        function updateStateWithDelta(event, state) {\n          var dx = event.now.x - event.start.x;\n          var dy = event.now.y - event.start.y;\n          state.x = drag_template_start_state.x + dx;\n          state.y = drag_template_start_state.y + dy;\n        }\n        template_actions.dragStartTemplate = function templateDragStartTemplate(scope, event) {\n          if(templateService.isLocked(event.target)) {\n            return self.Promise.reject('Template is locked');\n          }\n          drag_template_start_state = R.clone(event.target.state);\n          template_actions.dragTemplate(scope, event);\n          scope.game.template_selection =\n            gameTemplateSelectionService.set('local', [event.target.state.stamp],\n                                             scope, scope.game.template_selection);\n        };\n        defaultModeService.actions.dragStartTemplate = template_actions.dragStartTemplate;\n        template_actions.dragTemplate = function templateDragTemplate(scope, event) {\n          if(templateService.isLocked(event.target)) {\n            return self.Promise.reject('Template is locked');\n          }\n          updateStateWithDelta(event, event.target.state);\n          scope.gameEvent('changeTemplate-'+event.target.state.stamp);\n        };\n        template_actions.dragEndTemplate = function templateDragEndTemplate(scope, event) {\n          if(templateService.isLocked(event.target)) {\n            return self.Promise.reject('Template is locked');\n          }\n          templateService.setPosition(drag_template_start_state, event.target);\n          var end_state = R.clone(drag_template_start_state);\n          updateStateWithDelta(event, end_state);\n          return gameService.executeCommand('onTemplates', 'setPosition', end_state,\n                                            [event.target.state.stamp],\n                                            scope, scope.game);\n        };\n      })();\n\n      var template_default_bindings = {\n        'clickMap': 'clickMap',\n        'rightClickMap': 'rightClickMap',\n        'delete': 'del',\n        'toggleLock': 'l',\n      };\n      R.forEach(function(move) {\n        template_default_bindings[move[0]] = move[1];\n        template_default_bindings[move[0]+'Small'] = 'shift+'+move[1];\n      }, moves);\n      R.forEach(function(shift) {\n        template_default_bindings[shift[0]] = shift[1];\n        template_default_bindings[shift[0]+'Small'] = 'shift+'+shift[1];\n      }, shifts);\n      var template_bindings = R.extend(Object.create(defaultModeService.bindings),\n                                       template_default_bindings);\n      var template_buttons = [\n        [ 'Delete', 'delete' ],\n        [ 'Lock/Unlock', 'toggleLock' ],\n      ];\n      var template_mode = {\n        onEnter: function templateOnEnter(/*scope*/) {\n        },\n        onLeave: function templateOnLeave(/*scope*/) {\n        },\n        name: 'Template',\n        actions: template_actions,\n        buttons: template_buttons,\n        bindings: template_bindings,\n      };\n      // modesService.registerMode(template_mode);\n      settingsService.register('Bindings',\n                               template_mode.name,\n                               template_default_bindings,\n                               function(bs) {\n                                 R.extend(template_mode.bindings, bs);\n                               });\n      return template_mode;\n    }\n  ]);\n"]}