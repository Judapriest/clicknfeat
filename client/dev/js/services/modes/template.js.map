{"version":3,"sources":["../../../es6/services/modes/template.js"],"names":[],"mappings":"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","file":"template.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('templateMode', [\n    'modes',\n    'settings',\n    'defaultMode',\n    'template',\n    'game',\n    'gameTemplates',\n    'gameTemplateSelection',\n    function templateModeServiceFactory(modesService,\n                                        settingsService,\n                                        defaultModeService,\n                                        templateService,\n                                        gameService,\n                                        gameTemplatesService,\n                                        gameTemplateSelectionService) {\n      let template_actions = Object.create(defaultModeService.actions);\n      function clearTemplateSelection(state) {\n        return state.event('Game.update', R.lensProp('template_selection'),\n                           gameTemplateSelectionService.clear$('local', state));\n      }\n      template_actions.modeBackToDefault = clearTemplateSelection;\n      template_actions.clickMap = clearTemplateSelection;\n      template_actions.rightClickMap = clearTemplateSelection;\n      template_actions.delete = (state) => {\n        let stamps = gameTemplateSelectionService\n              .get('local', state.game.template_selection);\n        return state.event('Game.command.execute',\n                           'deleteTemplates', [stamps]);\n      };\n      template_actions.toggleLock = (state) => {\n        let stamps = gameTemplateSelectionService\n              .get('local', state.game.template_selection);\n        return R.pipeP(\n          () => {\n            return gameTemplatesService\n              .findStamp(stamps[0], state.game.templates);\n          },\n          (template) => {\n            let is_locked = templateService.isLocked(template);\n        \n            return state.event('Game.command.execute',\n                               'lockTemplates', [!is_locked, stamps]);\n          }\n        )();\n      };\n      let moves = [\n        ['moveFront', 'up'],\n        ['moveBack', 'down'],\n        ['rotateLeft', 'left'],\n        ['rotateRight', 'right'],\n      ];\n      R.forEach(([move]) => {\n        template_actions[move] = (state) => {\n          let stamps = gameTemplateSelectionService\n                .get('local', state.game.template_selection);\n          return state.event('Game.command.execute',\n                             'onTemplates', [ move, [false], stamps ]);\n        };\n        template_actions[move+'Small'] = (state) => {\n          let stamps = gameTemplateSelectionService\n                .get('local', state.game.template_selection);\n          return state.event('Game.command.execute',\n                             'onTemplates', [ move, [true], stamps ]);\n        };\n      }, moves);\n      let shifts = [\n        ['shiftUp', 'ctrl+up', 'shiftDown'],\n        ['shiftDown', 'ctrl+down', 'shiftUp'],\n        ['shiftLeft', 'ctrl+left', 'shiftRight'],\n        ['shiftRight', 'ctrl+right', 'shiftLeft'],\n      ];\n      R.forEach(([shift, key, flip_shift]) => {\n        key = key;\n        template_actions[shift] = (state) => {\n          let stamps = gameTemplateSelectionService\n                .get('local', state.game.template_selection);\n          let template_shift = ( R.path(['ui_state', 'flip_map'], state) ?\n                                 flip_shift :\n                                 shift\n                               );\n          return state.event('Game.command.execute',\n                             'onTemplates', [ template_shift, [false], stamps ]);\n        };\n        template_actions[shift+'Small'] = (state) => {\n          let stamps = gameTemplateSelectionService\n                .get('local', state.game.template_selection);\n          let template_shift = ( R.path(['ui_state', 'flip_map'], state) ?\n                                 flip_shift :\n                                 shift\n                               );\n          return state.event('Game.command.execute',\n                             'onTemplates', [ template_shift, [true], stamps ]);\n        };\n      }, shifts);\n\n      (() => {\n        let drag_template_start_state;\n        function updateStateWithDelta(event, state) {\n          let dx = event.now.x - event.start.x;\n          let dy = event.now.y - event.start.y;\n          state.x = drag_template_start_state.x + dx;\n          state.y = drag_template_start_state.y + dy;\n        }\n        template_actions.dragStartTemplate = (state, event) => {\n          if(templateService.isLocked(event.target)) {\n            return self.Promise.reject('Template is locked');\n          }\n          \n          drag_template_start_state = R.clone(event.target.state);\n          template_actions.dragTemplate(state, event);\n          return state\n            .event('Game.update', R.lensProp('template_selection'),\n                   gameTemplateSelectionService.set$('local', [event.target.state.stamp], state));\n        };\n        defaultModeService.actions.dragStartTemplate = template_actions.dragStartTemplate;\n        template_actions.dragTemplate = (state, event) => {\n          if(templateService.isLocked(event.target)) {\n            return self.Promise.reject('Template is locked');\n          }\n          \n          updateStateWithDelta(event, event.target.state);\n          state.changeEvent(`Game.template.change.${event.target.state.stamp}`);\n          return null;\n        };\n        template_actions.dragEndTemplate = (state, event) => {\n          if(templateService.isLocked(event.target)) {\n            return self.Promise.reject('Template is locked');\n          }\n\n          event.target.state.x = drag_template_start_state.x;\n          event.target.state.y = drag_template_start_state.y;\n\n          let end_state = R.clone(drag_template_start_state);\n          updateStateWithDelta(event, end_state);\n\n          return state.event('Game.command.execute',\n                             'onTemplates', [ 'setPosition',\n                                              [end_state],\n                                              [event.target.state.stamp]\n                                            ]);\n        };\n      })();\n\n      let template_default_bindings = {\n        'clickMap': 'clickMap',\n        'rightClickMap': 'rightClickMap',\n        'delete': 'del',\n        'toggleLock': 'l'\n      };\n      R.forEach(([move, key]) => {\n        template_default_bindings[move] = key;\n        template_default_bindings[move+'Small'] = 'shift+'+key;\n      }, moves);\n      R.forEach(([shift, key]) => {\n        template_default_bindings[shift] = key;\n        template_default_bindings[shift+'Small'] = 'shift+'+key;\n      }, shifts);\n      let template_bindings = R.extend(Object.create(defaultModeService.bindings),\n                                       template_default_bindings);\n      let template_buttons = [\n        [ 'Delete', 'delete' ],\n        [ 'Lock/Unlock', 'toggleLock' ],\n      ];\n      let template_mode = {\n        onEnter: () => { },\n        onLeave: () => { },\n        name: 'Template',\n        actions: template_actions,\n        buttons: template_buttons,\n        bindings: template_bindings\n      };\n      // modesService.registerMode(template_mode);\n      settingsService.register('Bindings',\n                               template_mode.name,\n                               template_default_bindings,\n                               (bs) => {\n                                 R.extend(template_mode.bindings, bs);\n                               });\n      return template_mode;\n    }\n  ]);\n"]}