{"version":3,"sources":["../../../es6/services/modes/ruler.js"],"names":[],"mappings":"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","file":"ruler.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('rulerMode', [\n    'modes',\n    'settings',\n    'commonMode',\n    'game',\n    'gameRuler',\n    'model',\n    'gameModels',\n    'gameModelSelection',\n    'prompt',\n    function rulerModeServiceFactory(modesService,\n                                     settingsService,\n                                     commonModeService,\n                                     gameService,\n                                     gameRulerService,\n                                     modelService,\n                                     gameModelsService,\n                                     gameModelSelectionService,\n                                     promptService) {\n      var ruler_actions = Object.create(commonModeService.actions);\n      ruler_actions.exitRulerMode = commonModeService.actions.modeBackToDefault;\n      ruler_actions.dragStartMap = function rulerDragStartMap(scope, drag) {\n        scope.game.ruler = gameRulerService.setLocal(drag.start, drag.now,\n                                                     scope, scope.game.ruler);\n      };\n      ruler_actions.dragMap = function rulerDragMap(scope, drag) {\n        scope.game.ruler = gameRulerService.setLocal(drag.start, drag.now,\n                                                     scope, scope.game.ruler);\n      };\n      ruler_actions.dragEndMap = function rulerDragEndMap(scope, drag) {\n        return gameService\n          .executeCommand('setRuler',\n                          'setRemote', drag.start, drag.now,\n                          scope,  scope.game);\n      };\n      ruler_actions.dragStartTemplate = ruler_actions.dragStartMap;\n      ruler_actions.dragTemplate = ruler_actions.dragMap;\n      ruler_actions.dragEndTemplate = ruler_actions.dragEndMap;\n      ruler_actions.dragStartModel = ruler_actions.dragStartMap;\n      ruler_actions.dragModel = ruler_actions.dragMap;\n      ruler_actions.dragEndModel = ruler_actions.dragEndMap;\n      ruler_actions.setOriginModel = function rulerSetOriginModel(scope, event) {\n        return R.pipeP(\n          () => {\n            return gameService\n              .executeCommand('setRuler',\n                              'setOrigin', event['click#'].target,\n                              scope,  scope.game);\n          },\n          (result) => {\n            updateMaxLengthButton(scope);\n            return result;\n          }\n        )();\n      };\n      ruler_actions.setTargetModel = function rulerSetTargetModel(scope, event) {\n        return gameService\n          .executeCommand('setRuler',\n                          'setTarget', event['click#'].target,\n                          scope,  scope.game);\n      };\n      ruler_actions.setMaxLength = function rulerSetMaxLength(scope) {\n        return R.pipeP(\n          () => {\n            return promptService.prompt('prompt', 'Set ruler max length :',\n                                        gameRulerService.maxLength(scope.game.ruler))\n              .catch(R.always(null));\n          },\n          (value) => {\n            value = (value === 0) ? null : value;\n            return R.pipeP(\n              () => {\n                return gameService\n                  .executeCommand('setRuler',\n                                  'setMaxLength', value,\n                                  scope,  scope.game);\n              },\n              (result) => {\n                var origin = gameRulerService.origin(scope.game.ruler);\n                if(R.isNil(origin)) return result;\n\n                return gameService\n                  .executeCommand('onModels',\n                                  'setRulerMaxLength', value,\n                                  [origin], scope, scope.game);\n              }\n            )();\n          },\n          (result) => {\n            updateMaxLengthButton(scope);\n            return result;\n          }\n        )();\n      };\n      ruler_actions.createAoEOnTarget = function rulerCreateAoEOnTarget(scope) {\n        return R.pipeP(\n          () => {\n            return gameRulerService.targetAoEPosition(scope.game.models,\n                                                      scope.game.ruler);\n          },\n          (position) => {\n            position.type = 'aoe';\n            return gameService.executeCommand('createTemplate', [position],\n                                              scope, scope.game);\n          }\n        )();\n      };\n      var ruler_default_bindings = {\n        exitRulerMode: 'ctrl+r',\n        setMaxLength: 'shift+r',\n        setOriginModel: 'ctrl+clickModel',\n        setTargetModel: 'shift+clickModel',\n        createAoEOnTarget: 'ctrl+a',\n      };\n      var ruler_bindings = R.extend(Object.create(commonModeService.bindings),\n                                    ruler_default_bindings);\n      var ruler_buttons = [\n        [ 'Set Max Len.', 'setMaxLength' ],\n        [ 'AoE on Target', 'createAoEOnTarget' ],\n      ];\n      var ruler_mode = {\n        onEnter: function rulerOnEnter(scope) {\n          return R.pipePromise(\n            () => {\n              return gameModelSelectionService\n                .get('local', scope.game.model_selection);\n            },\n            (stamps) => {\n              if(R.length(stamps) !== 1) return null;\n\n              return gameModelsService\n                .findStamp(stamps[0], scope.game.models)\n                .catch(R.always(null));\n            },\n            (model) => {\n              if(R.isNil(model)) return null;\n              \n              return gameService\n                .executeCommand('setRuler',\n                                'setOriginResetTarget', model,\n                                scope, scope.game)\n                .catch(R.always(null));\n            },\n            () => {\n              updateMaxLengthButton(scope);\n            }\n          )();\n        },\n        onLeave: function rulerOnLeave(/*scope*/) {\n        },\n        name: 'Ruler',\n        actions: ruler_actions,\n        buttons: ruler_buttons,\n        bindings: ruler_bindings,\n      };\n      modesService.registerMode(ruler_mode);\n      settingsService.register('Bindings',\n                               ruler_mode.name,\n                               ruler_default_bindings,\n                               (bs) => {\n                                 R.extend(ruler_mode.bindings, bs);\n                               });\n\n      function updateMaxLengthButton(scope) {\n        var max = gameRulerService.maxLength(scope.game.ruler);\n        ruler_mode.buttons[0][0] = 'Set Max Len. ('+max+')';\n        scope.$digest();\n      }\n\n      return ruler_mode;\n    }\n  ]);\n"]}