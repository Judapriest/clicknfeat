{"version":3,"sources":["../../es6/services/game.js"],"names":[],"mappings":"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","file":"game.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('game', [\n    'jsonStringifier',\n    'commands',\n    'gameConnection',\n    'gameLayers',\n    'gameLos',\n    'gameModels',\n    'gameModelSelection',\n    'gameRuler',\n    'gameTemplates',\n    'gameTemplateSelection',\n    'gameTerrains',\n    'gameTerrainSelection',\n    function gameServiceFactory(jsonStringifierService,\n                                commandsService,\n                                gameConnectionService,\n                                gameLayersService,\n                                gameLosService,\n                                gameModelsService,\n                                gameModelSelectionService,\n                                gameRulerService,\n                                gameTemplatesService,\n                                gameTemplateSelectionService,\n                                gameTerrainsService,\n                                gameTerrainSelectionService) {\n      var gameService = {\n        create: function gameCreate(player1) {\n          var new_game = {\n            players: {\n              p1: { name: R.propOr('player1', 'name', player1) },\n              p2: { name: null }\n            }\n          };\n          return new_game;\n        },\n        load: function gameLoad(state, data) {\n          return R.pipe(\n            () => {\n              return Object.create({\n                toJSON: function() { return gameService.pickForJson(this); }\n              });\n            },\n            (game) => {\n              return R.deepExtend(game, {\n                players: {\n                  p1: { name: null },\n                  p2: { name: null }\n                },\n                board: {},\n                scenario: {},\n                chat: [],\n                commands: [],\n                commands_log: [],\n                undo: [],\n                undo_log: [],\n                dice: [],\n                ruler: gameRulerService.create(),\n                los: gameLosService.create(),\n                models: gameModelsService.create(),\n                model_selection: gameModelSelectionService.create(),\n                templates: gameTemplatesService.create(),\n                template_selection: gameTemplateSelectionService.create(),\n                terrains: gameTerrainsService.create(),\n                terrain_selection: gameTerrainSelectionService.create(),\n                layers: gameLayersService.create()\n              }, data);\n            },\n            gameConnectionService.create,\n            gameReplayAll$(state)\n          )();\n        },\n        pickForJson: function gamePickForJson(game) {\n          return R.pick([\n            'players', 'commands', 'undo', 'chat',\n            'local_stamp', 'private_stamp', 'public_stamp'\n          ], game);\n        },\n        toJson: function gameToJson(game) {\n          return R.pipePromise(\n            gameService.pickForJson,\n            jsonStringifierService.stringify\n          )(game);\n        },\n        playerName: function gamePlayerName(p, game) {\n          return R.pathOr('John Doe', ['players',p,'name'], game);\n        },\n        description: function gameDescription(game) {\n          return [ s.capitalize(gameService.playerName('p1', game)),\n                   'vs',\n                   s.capitalize(gameService.playerName('p2', game))\n                 ].join(' ');\n        },\n        executeCommand: function gameExecuteCommand(cmd, args, state, game) {\n          return R.pipeP(\n            () => {\n              return commandsService.execute\n                .apply(null, [cmd, args, state, game]);\n            },\n            ([command, game]) => {\n              return [ R.pipe(\n                R.assoc('user', R.pathOr('Unknown', ['user','state','name'], state)),\n                R.assoc('stamp', R.guid())\n              )(command),\n                       game\n                     ];\n            },\n            ([command, game]) => {\n              if(gameConnectionService.active(game)) {\n                return gameConnectionService\n                  .sendReplayCommand(command, game);\n              }\n              if(!command.do_not_log) {\n                game = R.over(R.lensProp('commands'),\n                              R.append(command),\n                              game);\n              }\n              if(command.type === 'rollDice' ||\n                 command.type === 'rollDeviation') {\n                game = R.over(R.lensProp('dice'),\n                              R.append(command),\n                              game);\n              }\n              return game;\n            },\n            (game) => {\n              state.changeEvent('Game.command.execute');\n              return game;\n            }\n          )();\n        },\n        undoCommand: function gameUndoCommand(command, state, game) {\n          return R.pipePromise(\n            R.propOr([], 'undo_log'),\n            R.find(R.propEq('stamp', command.stamp)),\n            (log) => {\n              if(R.exists(log)) {\n                console.log('Game : undoCmd log', command);\n                let log = R.propOr([], 'undo_log', game);\n                return R.assoc('undo_log',\n                               R.reject(R.propEq('stamp', command.stamp), log),\n                               game);\n              }\n              return commandsService\n                .undo(command, state, game);\n            },\n            (game) => {\n              let commands = R.propOr([], 'commands', game);\n              let undo = R.propOr([], 'undo', game);\n              return R.pipe(\n                R.assoc('commands', R.reject(R.propEq('stamp', command.stamp), commands)),\n                R.assoc('undo', R.append(command, undo))\n              )(game);\n            },\n            (game) => {\n              state.changeEvent('Game.command.undo');\n              return game;\n            }\n          )(game);\n        },\n        undoLastCommand: function gameUndoLastCommand(state, game) {\n          return R.pipePromise(\n            R.propOr([],'commands'),\n            R.last,\n            R.rejectIf(R.isNil, 'Command history empty'),\n            (command) => {\n              return R.pipeP(\n                commandsService.undo$(command, state),\n                (game) => { return [command, game]; }\n              )(game);\n            },\n            ([command, game]) => {\n              return R.pipePromise(\n                R.assoc('commands', R.init(game.commands)),\n                (game) => {\n                  if(gameConnectionService.active(game)) {\n                    return gameConnectionService\n                      .sendUndoCommand(command, game);\n                  }\n                  return R.over(R.lensProp('undo'),\n                                R.append(command),\n                                game);\n                }\n              )(game);\n            },\n            (game) => {\n              state.changeEvent('Game.command.undo');\n              return game;\n            }\n          )(game);\n        },\n        replayCommand: function gameReplayCommand(command, state, game) {\n          return R.pipePromise(\n            R.propOr([], 'commands_log'),\n            R.find(R.propEq('stamp', command.stamp)),\n            (log) => {\n              if(R.exists(log)) {\n                console.log('Game: replayCmd log', command);\n                return R.over(R.lensProp('commands_log'),\n                              R.reject(R.propEq('stamp', command.stamp)),\n                              game);\n              }\n              return commandsService\n                .replay(command, state, game);\n            },\n            (game) => {\n              return R.pipe(\n                R.over(R.lensProp('undo'),\n                       R.reject(R.propEq('stamp', command.stamp))),\n                (game) => {\n                  if(command.do_not_log) return game;\n\n                  return R.over(R.lensProp('commands'),\n                                R.append(command),\n                                game);\n                }\n              )(game);\n            },\n            (game) => {\n              state.changeEvent('Game.command.replay');\n              return game;\n            }\n          )(game);\n        },\n        replayCommandsBatch: function gameReplayCommandsBatch(cmds, state, game) {\n          return R.pipeP(\n            commandsService.replayBatch$(cmds, state),\n            R.over(R.lensProp('commands'),\n                   R.flip(R.concat)(cmds))\n          )(game);\n        },\n        replayNextCommand: function gameReplayNextCommand(state, game) {\n          return R.pipePromise(\n            R.propOr([], 'undo'),\n            R.last,\n            (command) => {\n              if(R.isNil(command)) {\n                return self.Promise\n                  .reject('Undo history empty');\n              }\n              return R.pipeP(\n                commandsService.replay$(command, state),\n                (game) => { return [command, game]; }\n              )(game);\n            },\n            ([command, game]) => {\n              return R.pipePromise(\n                R.assoc('undo', R.init(game.undo)),\n                (game) => {\n                  if(gameConnectionService.active(game)) {\n                    return gameConnectionService\n                      .sendReplayCommand(command, game);\n                  }\n                  let commands = R.propOr([], 'commands', game);\n                  return R.assoc('commands', R.append(command, commands), game);\n                }\n              )(game);\n            },\n            (game) => {\n              state.changeEvent('Game.command.replay');\n              return game;\n            }\n          )(game);\n        },\n        sendChat: function gameSendChat(from, msg, game) {\n          return gameConnectionService\n            .sendEvent({\n              type: 'chat',\n              chat: {\n                from: from,\n                msg: msg\n              }\n            }, game);\n        }\n      };\n      function gameReplayBatchs(batchs, state, game) {\n        if(R.isEmpty(batchs)) return game;\n\n        console.log('Game: ReplayBatchs:', batchs);\n        return R.pipeP(\n          commandsService.replayBatch$(batchs[0], state),\n          (game) => {\n            return new self.Promise((resolve) => {\n              self.requestAnimationFrame(() => {\n                resolve(gameReplayBatchs(R.tail(batchs), state, game));\n              });\n            });\n          }\n        )(game);\n      }\n      var gameReplayAll$ = R.curry((state, game) => {\n        return new self.Promise((resolve) => {\n          if(R.isEmpty(game.commands)) {\n            resolve(game);\n          }\n\n          var batchs = R.splitEvery(game.commands.length, game.commands);\n          self.requestAnimationFrame(() => {\n            resolve(gameReplayBatchs(batchs, state, game));\n          });\n        });\n      });\n      R.curryService(gameService);\n      return gameService;\n    }\n  ]);\n"]}