{"version":3,"sources":["../../es6/services/state.js"],"names":[],"mappings":";;;;AAAA,OAAO,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAChC,OAAO,CAAC,OAAO,EAAE,CAChB,QAAQ,EACR,YAAY,EACZ,cAAc,EACd,WAAW,EACX,WAAW,EACX,WAAW,EACX,YAAY,EACZ,YAAY,EACZ,SAAS,mBAAmB,CAAC,aAAa,EACb,iBAAiB,EACjB,mBAAmB,EACnB,gBAAgB,EAChB,gBAAgB,EAChB,gBAAgB,EAChB,iBAAiB,EACjB,iBAAiB,EAAE;AAC9C,MAAI,YAAY,GAAG;AACjB,QAAI,EAAE,SAAS,SAAS,GAAG;AACzB,UAAI,KAAK,GAAG,aAAa,CAAC,IAAI,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC;AAC5C,WAAK,CAAC,UAAU,GAAG,KAAK,CAAC;AACzB,WAAK,CAAC,YAAY,GAAG,EAAE,CAAC;;AAExB,WAAK,CAAC,KAAK,GAAG,YAAa;0CAAT,IAAI;AAAJ,cAAI;;;AACpB,eAAO,YAAY,CAAC,KAAK,CACtB,KAAK,CAAC,IAAI,YAAM,IAAI,GAAE,KAAK,GAAE,CAAC;OAClC,CAAC;AACF,WAAK,CAAC,OAAO,GAAG,YAAa;2CAAT,IAAI;AAAJ,cAAI;;;AACtB,eAAO,aAAa,CAAC,SAAS,CAC3B,KAAK,CAAC,IAAI,YAAM,IAAI,GAAE,KAAK,GAAE,CAAC;OAClC,CAAC;;AAEF,WAAK,CAAC,MAAM,GAAG,aAAa,CAAC,IAAI,CAAC,EAAE,EAAE,cAAc,CAAC,CAAC;AACtD,WAAK,CAAC,WAAW,GAAG,YAAa;2CAAT,IAAI;AAAJ,cAAI;;;AAC1B,YAAG,KAAK,CAAC,UAAU,EAAE;AACnB,iBAAO,CAAC,IAAI,CAAC,wBAAwB,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;AAC9D,eAAK,CAAC,YAAY,GAAG,CAAC,CAAC,MAAM,CAAC,IAAI,EAAE,KAAK,CAAC,YAAY,CAAC,CAAC;AACxD,iBAAO,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;SAC/B;AACD,eAAO,CAAC,IAAI,CAAC,wBAAwB,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;AAC9D,eAAO,aAAa,CAAC,OAAO,CACzB,KAAK,CAAC,IAAI,YAAM,IAAI,GAAE,KAAK,CAAC,MAAM,GAAE,CAAC;OACzC,CAAC;AACF,WAAK,CAAC,qBAAqB,GAAG,YAAa;2CAAT,IAAI;AAAJ,cAAI;;;AACpC,eAAO,CAAC,IAAI,CAAC,2BAA2B,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;AACjE,eAAO,aAAa,CAAC,OAAO,CACzB,KAAK,CAAC,IAAI,YAAM,IAAI,GAAE,KAAK,CAAC,MAAM,GAAE,CAAC;OACzC,CAAC;;AAEF,WAAK,GAAG,gBAAgB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;AACrC,WAAK,GAAG,gBAAgB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;AACrC,WAAK,GAAG,gBAAgB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;AACrC,WAAK,GAAG,iBAAiB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;AACtC,WAAK,GAAG,iBAAiB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;;AAEtC,2BAAqB,CAAC,KAAK,CAAC,CAAC;AAC7B,aAAO,KAAK,CAAC;KACd;AACD,SAAK,EAAE,SAAS,UAAU,GAAU;yCAAN,IAAI;AAAJ,YAAI;;;AAChC,UAAI,KAAK,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AACzB,UAAI,UAAU,GAAG,KAAK,CAAC,UAAU,CAAC;AAClC,WAAK,CAAC,UAAU,GAAG,IAAI,CAAC;AACxB,aAAO,CAAC,IAAI,CAAC,kBAAkB,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;;AAAC,AAEhE,aAAO,CAAC,CAAC,KAAK,CACZ,YAAM;AACJ,eAAO,aAAa,CAAC,OAAO,CACzB,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;OACtB,EACD,YAAM;AACJ,YAAG,UAAU,EAAE,OAAO,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,KACvC,OAAO,IAAI,CAAC;OAClB,EACD,YAAM;AAAE,eAAO,gBAAgB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;OAAE,EAC9C,YAAM;AAAE,eAAO,gBAAgB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;OAAE,EAC9C,YAAM;AAAE,eAAO,gBAAgB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;OAAE,EAC9C,YAAM;AAAE,eAAO,iBAAiB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;OAAE,EAC/C,YAAM;AAAE,eAAO,iBAAiB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;OAAE,EAC/C,YAAM;AAAE,eAAO,qBAAqB,CAAC,KAAK,CAAC,CAAC;OAAE,EAC9C,YAAM;AAAE,aAAK,CAAC,UAAU,GAAG,UAAU,CAAC;OAAE,EACxC,YAAM;AACJ,aAAK,CAAC,YAAY,GAAG,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC;AAChD,eAAO,CAAC,SAAS,cAAc,CAAC,KAAK,EAAE;AACrC,cAAG,CAAC,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,OAAO,IAAI,CAAC;AACjC,cAAI,IAAI,GAAG,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;AACzB,iBAAO,CAAC,GAAG,CAAC,0BAA0B,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;AACtD,iBAAO,aAAa,CAAC,OAAO,CACzB,KAAK,CAAC,IAAI,+BAAM,IAAI,IAAE,KAAK,CAAC,MAAM,GAAE,CACpC,IAAI,CAAC,YAAM;AACV,mBAAO,cAAc,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC;WACtC,CAAC,CAAC;SACN,CAAA,CAAE,KAAK,CAAC,YAAY,CAAC,CAAC;OACxB,EACD,YAAM;AAAE,aAAK,CAAC,YAAY,GAAG,EAAE,CAAC;OAAE,CACnC,EAAE,CAAC,KAAK,CAAC,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CACtB,IAAI,CAAC,YAAM;AAAE,aAAK,CAAC,UAAU,GAAG,UAAU,CAAC;OAAE,CAAC,CAAC;KACnD;AACD,iBAAa,EAAE,SAAS,kBAAkB,CAAC,KAAK,EAAE,QAAQ,EAAE,KAAK,EAAE;AACjE,aAAO,aAAa,CAAC,SAAS,CAAC,KAAK,EAAE,QAAQ,EAAE,KAAK,CAAC,MAAM,CAAC,CAAC;KAC/D;AACD,kBAAc,EAAE,SAAS,mBAAmB,CAAC,KAAK,EAAE,KAAK,EAAE,IAAI,EAAE;AAC/D,aAAO,CAAC,CAAC,KAAK,CACZ,iBAAiB,CAAC,KAAK,CAAC,MAAM,CAAC,EAC/B,UAAC,IAAI,EAAK;AACR,eAAO,CAAC,CAAC,KAAK,CACZ,YAAM;AACJ,iBAAO,gBAAgB,CACpB,eAAe,CAAC,KAAK,EAAE,KAAK,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;SACjD,EACD,YAAM;AACJ,iBAAO,iBAAiB,CACrB,gBAAgB,CAAC,KAAK,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;SACvC,EACD,YAAM;AACJ,eAAK,CAAC,WAAW,CAAC,oBAAoB,EAAE,aAAa,CAAC,CAAC;SACxD,CACF,EAAE,CAAC;OACL,CACF,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,UAAC,KAAK,EAAK;AACvB,aAAK,CAAC,WAAW,CAAC,oBAAoB,EAAE,KAAK,CAAC,CAAC;OAChD,CAAC,CAAC;KACJ;GACF,CAAC;AACF,MAAI,qBAAqB,GAAG,mBAAmB,CACxC,OAAO,CAAC,MAAM,EAAE,UAAC,KAAK,EAAK;AAC1B,WAAO,EAAE,QAAQ,EAAE,CAAC,CAAC,MAAM,CAAC,EAAE,EAAE,CAAC,UAAU,EAAC,SAAS,CAAC,EAAE,KAAK,CAAC;AACrD,UAAI,EAAE,CAAC,CAAC,MAAM,CAAC,EAAE,EAAE,MAAM,EAAE,KAAK,CAAC;KAClC,CAAC;GACV,CAAC,CAAC;AACT,GAAC,CAAC,YAAY,CAAC,YAAY,CAAC,CAAC;AAC7B,SAAO,YAAY,CAAC;CACrB,CACF,CAAC,CAAC","file":"state.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('state', [\n    'pubSub',\n    'fileImport',\n    'stateExports',\n    'stateData',\n    'stateUser',\n    'stateGame',\n    'stateGames',\n    'stateModes',\n    function stateServiceFactory(pubSubService,\n                                 fileImportService,\n                                 stateExportsService,\n                                 stateDataService,\n                                 stateUserService,\n                                 stateGameService,\n                                 stateGamesService,\n                                 stateModesService) {\n      var stateService = {\n        init: function stateInit() {\n          let state = pubSubService.init({}, 'State');\n          state.processing = false;\n          state.change_queue = [];\n\n          state.event = (...args) => {\n            return stateService.event\n              .apply(null, [...args, state]);\n          };\n          state.onEvent = (...args) => {\n            return pubSubService.subscribe\n              .apply(null, [...args, state]);\n          };\n\n          state.change = pubSubService.init({}, 'State.Change');\n          state.changeEvent = (...args) => {\n            if(state.processing) {\n              console.info('State <--- ChangeEvent', args[0], R.tail(args));\n              state.change_queue = R.append(args, state.change_queue);\n              return self.Promise.resolve();\n            }\n            console.info('State <=== ChangeEvent', args[0], R.tail(args));\n            return pubSubService.publish\n              .apply(null, [...args, state.change]);\n          };\n          state.changeEventUnbuffered = (...args) => {\n            console.info('State <---[U] ChangeEvent', args[0], R.tail(args));\n            return pubSubService.publish\n              .apply(null, [...args, state.change]);\n          };\n\n          state = stateDataService.init(state);\n          state = stateUserService.init(state);\n          state = stateGameService.init(state);\n          state = stateGamesService.init(state);\n          state = stateModesService.init(state);\n\n          exportCurrentDumpFile(state);\n          return state;\n        },\n        event: function stateEvent(...args) {\n          let state = R.last(args);\n          let processing = state.processing;\n          state.processing = true;\n          console.info('State ---> Event', args[0], R.init(R.tail(args)));\n          // console.trace();\n          return R.pipeP(\n            () => {\n              return pubSubService.publish\n                .apply(null, args);\n            },\n            () => {\n              if(processing) return self.Promise.reject();\n              else return null;\n            },\n            () => { return stateDataService.save(state); },\n            () => { return stateUserService.save(state); },\n            () => { return stateGameService.save(state); },\n            () => { return stateGamesService.save(state); },\n            () => { return stateModesService.save(state); },\n            () => { return exportCurrentDumpFile(state); },\n            () => { state.processing = processing; },\n            () => {\n              state.change_queue = R.uniq(state.change_queue);\n              return (function dispatchChange(queue) {\n                if(R.isEmpty(queue)) return null;\n                let args = R.head(queue);\n                console.log('State: change queue <===', R.head(args));\n                return pubSubService.publish\n                  .apply(null, [...args, state.change])\n                  .then(() => {\n                    return dispatchChange(R.tail(queue));\n                  });\n              })(state.change_queue);\n            },\n            () => { state.change_queue = []; }\n          )().catch(R.always(null))\n            .then(() => { state.processing = processing; });\n        },\n        onChangeEvent: function stateOnChangeEvent(event, listener, state) {\n          return pubSubService.subscribe(event, listener, state.change);\n        },\n        onLoadDumpFile: function stateOnLoadDumpFile(state, event, file) {\n          return R.pipeP(\n            fileImportService.read$('json'),\n            (data) => {\n              return R.pipeP(\n                () => {\n                  return stateDataService\n                    .onSettingsReset(state, event, data.settings);\n                },\n                () => {\n                  return stateGamesService\n                    .loadNewLocalGame(state, data.game);\n                },\n                () => {\n                  state.changeEvent('State.loadDumpFile', 'File loaded');\n                }\n              )();\n            }\n          )(file).catch((error) => {\n            state.changeEvent('State.loadDumpFile', error);\n          });\n        }\n      };\n      var exportCurrentDumpFile = stateExportsService\n            .export$('dump', (state) => {\n              return { settings: R.pathOr({}, ['settings','current'], state),\n                       game: R.propOr({}, 'game', state)\n                     };\n            });\n      R.curryService(stateService);\n      return stateService;\n    }\n  ]);\n"]}