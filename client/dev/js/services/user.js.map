{"version":3,"sources":["../../es6/services/user.js"],"names":[],"mappings":"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","file":"user.js","sourcesContent":["'use strict';\n\nangular.module('clickApp.services')\n  .factory('user', [\n    'http',\n    'localStorage',\n    'userConnection',\n    function userServiceFactory(httpService,\n                                localStorageService,\n                                userConnectionService) {\n      var STORAGE_KEY = 'clickApp.user';\n      var userService = {\n        isValid: function(user) {\n          return R.pipe(\n            R.pathOr('', ['state','name']),\n            s.trim,\n            R.length,\n            R.lt(0)\n          )(user);\n        },\n        save: function userSave(user) {\n          return R.pipeP(\n            R.bind(self.Promise.resolve, self.Promise),\n            R.prop('state'),\n            function(state) {\n              return localStorageService\n                .save(STORAGE_KEY, state);\n            },\n            R.always(user)\n          )(user);\n        },\n        load: function userLoad() {\n          return R.pipeP(\n            function() {\n              return localStorageService\n                .load(STORAGE_KEY);\n            },\n            function(state) {\n              return { state: state };\n            },\n            userConnectionService.create\n          )();\n        },\n        init: function userInit() {\n          return R.pipeP(\n            userService.load,\n            userService.checkOnline\n          )();\n        },\n        description: function userDescription(user) {\n          if(R.type(R.prop('state', user)) !== 'Object') return '';\n\n          return userService.stateDescription(user.state);\n        },\n        stateDescription: function userStateDescription(state) {\n          var ret = '';\n          if(R.exists(state.name)) {\n            ret += s(state.name).trim().capitalize().value();\n          }\n          var lang_chat = [];\n          if(R.exists(state.language)) {\n            lang_chat.push(s(state.language).trim().value());\n          }\n          if(R.exists(state.chat)) {\n            lang_chat.push(s(state.chat).trim().value());\n          }\n          if(!R.isEmpty(lang_chat)) {\n            ret += '['+lang_chat.join(' ')+']';\n          }\n          if(R.exists(state.faction) &&\n             !R.isEmpty(state.faction)) {\n            ret += ' - '+R.map(s.capitalize, state.faction).join(',');\n          }\n          if(R.exists(state.game_size)) {\n            ret += '['+s.trim(state.game_size)+'pts]';\n          }\n          if(R.exists(state.ck_position) &&\n             !R.isEmpty(state.ck_position)) {\n            ret += ' - likes '+state.ck_position.join(',');\n          }\n          return ret;\n        },\n        online: function userOnline(user) {\n          return R.path(['state','online'], user);\n        },\n        toggleOnline: function userToggleOnline(user) {\n          return ( userService.online(user) ?\n                   userGoOffline(user) :\n                   userGoOnline(user)\n                 );\n        },\n        checkOnline: function userCheckOnline(user) {\n          return R.pipeP(\n            function(user) {\n              if(!userService.online(user)) {\n                return self.Promise.reject('No online flag');\n              }\n              return self.Promise.resolve(user);\n            },\n            function(user) {\n              return userUpdateOnline(user)\n                .catch(function() {\n                  return userCreateOnline(user);\n                });\n            },\n            userOnlineStart\n          )(user)\n            .catch(function(reason) {\n              console.error('User: checkOnline error', reason);\n              return userOnlineStop(user);\n            });\n        },\n      };\n      function userGoOnline(user) {\n        return userService.checkOnline(R.assocPath(['state','online'], true, user));\n      }\n      function userGoOffline(user) {\n        return R.pipeP(\n          R.bind(self.Promise.resolve, self.Promise),\n          function(user) {\n            return httpService.delete('/api/users/'+user.state.stamp)\n              .catch(R.always(null));\n          },\n          R.always(user),\n          userOnlineStop\n        )(user);\n      }\n      function userCreateOnline(user) {\n        return R.pipeP(\n          R.bind(self.Promise.resolve, self.Promise),\n          R.prop('state'),\n          httpService.post$('/api/users'),\n          function(state) {\n            return R.assoc('state', state, user);\n          }\n        )(user);\n      }\n      function userUpdateOnline(user) {\n        if(R.isNil(user.state.stamp)) {\n          return self.Promise.reject('No valid stamp');\n        }\n\n        return R.pipeP(\n          R.bind(self.Promise.resolve, self.Promise),\n          R.prop('state'),\n          httpService.put$('/api/users/'+user.state.stamp),\n          function(state) {\n            return R.assoc('state', state, user);\n          }\n        )(user);\n      }\n      function userOnlineStart(user) {\n        return R.pipeP(\n          R.bind(self.Promise.resolve, self.Promise),\n          userConnectionService.open,\n          R.assocPath(['state','online'], true),\n          R.spy('User online start'),\n          userService.save\n        )(user);\n      }\n      function userOnlineStop(user) {\n        return R.pipeP(\n          userConnectionService.close,\n          R.assocPath(['state','stamp'], null),\n          R.assocPath(['state','online'], false),\n          R.spy('User online stop'),\n          userService.save\n        )(user);\n      }\n      return userService;\n    }\n  ]);\n"]}