{"version":3,"sources":["../../es6/services/user.js"],"names":[],"mappings":"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","file":"user.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('user', [\n    'http',\n    'localStorage',\n    'userConnection',\n    function userServiceFactory(httpService,\n                                localStorageService,\n                                userConnectionService) {\n      var STORAGE_KEY = 'clickApp.user';\n      var userService = {\n        isValid: function(user) {\n          return R.pipe(\n            R.pathOr('', ['state','name']),\n            s.trim,\n            R.length,\n            R.lt(0)\n          )(user);\n        },\n        save: function userSave(user) {\n          return R.pipePromise(\n            R.prop('state'),\n            R.spyWarn('User save'),\n            localStorageService.save$(STORAGE_KEY),\n            R.always(user)\n          )(user);\n        },\n        load: function userLoad() {\n          return R.pipeP(\n            () => {\n              return localStorageService\n                .load(STORAGE_KEY);\n            },\n            R.spyWarn('User load'),\n            (state) => {\n              return { state: state };\n            },\n            userConnectionService.init\n          )();\n        },\n        init: function userInit(state) {\n          return R.pipeP(\n            userService.load,\n            userService.checkOnline$(state)\n          )();\n        },\n        description: function userDescription(user) {\n          if(R.type(R.prop('state', user)) !== 'Object') return '';\n\n          return userService.stateDescription(user.state);\n        },\n        stateDescription: function userStateDescription({ name,\n                                                          language,\n                                                          chat,\n                                                          faction,\n                                                          game_size,\n                                                          ck_position\n                                                        } = {}) {\n          var ret = '';\n          if(R.exists(name)) {\n            ret += s(name).trim().capitalize().value();\n          }\n          var lang_chat = [];\n          if(R.exists(language)) {\n            lang_chat.push(s(language).trim().value());\n          }\n          if(R.exists(chat)) {\n            lang_chat.push(s(chat).trim().value());\n          }\n          if(!R.isEmpty(lang_chat)) {\n            ret += '['+lang_chat.join(' ')+']';\n          }\n          if(R.exists(faction) &&\n             !R.isEmpty(faction)) {\n            ret += ' - '+R.map(s.capitalize, faction).join(',');\n          }\n          if(R.exists(game_size)) {\n            ret += '['+s.trim(game_size)+'pts]';\n          }\n          if(R.exists(ck_position) &&\n             !R.isEmpty(ck_position)) {\n            ret += ' - likes '+ck_position.join(',');\n          }\n          return ret;\n        },\n        online: function userOnline(user) {\n          return R.path(['state','online'], user);\n        },\n        toggleOnline: function userToggleOnline(state, user) {\n          return ( userService.online(user) ?\n                   userGoOffline(user) :\n                   userGoOnline(state, user)\n                 );\n        },\n        checkOnline: function userCheckOnline(state, user) {\n          return R.pipePromise(\n            (user) => {\n              if(!userService.online(user)) {\n                return self.Promise.reject('No online flag');\n              }\n              return user;\n            },\n            (user) => {\n              return userUpdateOnline(user)\n                .catch(() => {\n                  return userCreateOnline(user);\n                });\n            },\n            userOnlineStart$(state)\n          )(user)\n            .catch((reason) => {\n              console.error('User: checkOnline error', reason);\n              return userOnlineStop(user);\n            });\n        }\n      };\n      function userGoOnline(state, user) {\n        return R.pipePromise(\n          R.assocPath(['state','online'], true),\n          userService.checkOnline$(state)\n        )(user);\n      }\n      function userGoOffline(user) {\n        return userOnlineStop(user);\n      }\n      function userCreateOnline(user) {\n        return R.pipePromise(\n          R.prop('state'),\n          httpService.post$('/api/users'),\n          (state) => {\n            return R.assoc('state', state, user);\n          }\n        )(user);\n      }\n      function userUpdateOnline(user) {\n        if(R.isNil(user.state.stamp)) {\n          return self.Promise.reject('No valid stamp');\n        }\n\n        return R.pipePromise(\n          R.prop('state'),\n          httpService.put$('/api/users/'+user.state.stamp),\n          (state) => {\n            return R.assoc('state', state, user);\n          }\n        )(user);\n      }\n      var userOnlineStart$ = R.curry((state, user) => {\n        return R.pipePromise(\n          userConnectionService.open$(state),\n          R.assocPath(['state','online'], true)\n        )(user);\n      });\n      function userOnlineStop(user) {\n        return R.pipePromise(\n          R.assocPath(['state','online'], false),\n          R.assocPath(['state','stamp'], null),\n          userConnectionService.close\n        )(user);\n      }\n      R.curryService(userService);\n      return userService;\n    }\n  ]);\n"]}