{"version":3,"sources":["../../../es6/services/model/charge.js"],"names":[],"mappings":"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","file":"charge.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('modelCharge', [\n    'point',\n    function modelChargeServiceFactory(pointService) {\n      var CHARGE_EPSILON = 0.1;\n      return (MOVES, modelService) => {\n        var modelChargeService = {\n          startCharge: function modelStartCharge(model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            return R.assocPath(['state','cha'], {\n              s: R.pick(['x','y','r'], model.state),\n              t: null\n            }, model);\n          },\n          isCharging: function modelIsCharging(model) {\n            return R.exists(model.state.cha);\n          },\n          chargeTarget: function modelChargeTarget(model) {\n            return new self.Promise(function(resolve, reject) {\n              if(!modelService.isCharging(model)) {\n                reject('Model is not charging');\n                return;\n              }\n              resolve(R.path(['state','cha','t'], model));\n            });\n          },\n          endCharge: function modelEndCharge(model) {\n            return R.assocPath(['state','cha'], null, model);\n          },\n          setChargeTarget: function modelSetChargeTarget(factions, other, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            if(R.exists(other)) {\n              model = R.pipe(\n                R.over(R.lensPath(['state','cha']),\n                       R.assoc('t', other.state.stamp)),\n                R.over(R.lensProp('state'),\n                       R.assoc('r', pointService.directionTo(other.state, model.state)))\n              )(model);\n            }\n            else {\n              model = R.assocPath(['state','cha','t'], null, model);\n            }\n            return modelService.checkState(factions, other, model);\n          },\n          chargeMaxLength: function modelChargeMaxLength(model) {\n            return R.path(['state','cml'], model);\n          },\n          setChargeMaxLength: function modelSetChargeMaxLength(factions, value, model) {\n            model = R.assocPath(['state','cml'], value, model);\n            return modelService.checkState(factions, null, model);\n          },\n          moveFrontCharge: function modelMoveFrontCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'MoveSmall' : 'Move'];\n            var direction = model.state.cha.s.r;\n            model = R.over(R.lensProp('state'),\n                           pointService.translateInDirection$(dist, direction),\n                           model);\n            return modelService.checkState(factions, target, model);\n          },\n          moveBackCharge: function modelMoveBackCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'MoveSmall' : 'Move'];\n            var direction = model.state.cha.s.r+180;\n            var distance = pointService.distanceTo(model.state, model.state.cha.s);\n            if(dist > distance) dist = distance;\n            model = R.over(R.lensProp('state'),\n                           pointService.translateInDirection$(dist, direction),\n                           model);\n            return modelService.checkState(factions, target, model);\n          },\n          rotateLeftCharge: function modelRotateLeftCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var angle = MOVES[small ? 'RotateChargeSmall' : 'RotateCharge'];\n            model = R.pipe(\n              R.over(R.lensProp('state'),\n                     pointService.rotateLeftAround$(angle, model.state.cha.s)),\n              R.over(R.lensPath(['state','cha','s','r']),\n                     R.subtract(R.__, angle))\n            )(model);\n            return modelService.checkState(factions, target, model);\n          },\n          rotateRightCharge: function modelRotateRightCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var angle = MOVES[small ? 'RotateChargeSmall' : 'RotateCharge'];\n            model = R.pipe( \n              R.over(R.lensProp('state'),\n                     pointService.rotateRightAround$(angle, model.state.cha.s)),\n              R.over(R.lensPath(['state','cha','s','r']), R.add(angle))\n            )(model);\n            return modelService.checkState(factions, target, model);\n          },\n          shiftLeftCharge: function modelShiftLeftCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'ShiftSmall' : 'Shift'];\n            model = R.over(R.lensProp('state'),\n                           pointService.shiftLeft$(dist),\n                           model);\n            return modelService.checkState(factions, target, model);\n          },\n          shiftRightCharge: function modelShiftRightCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'ShiftSmall' : 'Shift'];\n            model = R.over(R.lensProp('state'),\n                           pointService.shiftRight$(dist),\n                           model);\n            return modelService.checkState(factions, target, model);\n          },\n          shiftUpCharge: function modelShiftUpCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'ShiftSmall' : 'Shift'];\n            model = R.over(R.lensProp('state'),\n                           pointService.shiftUp$(dist),\n                           model);\n            return modelService.checkState(factions, target, model);\n          },\n          shiftDownCharge: function modelShiftDownCharge(factions, target, small, model) {\n            if(modelService.isLocked(model)) {\n              return self.Promise.reject('Model is locked');\n            }\n            var dist = MOVES[small ? 'ShiftSmall' : 'Shift'];\n            model = R.over(R.lensProp('state'),\n                           pointService.shiftDown$(dist),\n                           model);\n            return modelService.checkState(factions, target, model);\n          }\n        };\n        var ensureChargeLength = R.curry(function _ensureChargeLength(info, target, state) {\n          if(R.exists(state.cha) &&\n             R.exists(state.cml) &&\n             state.cml > 0) {\n            var distance = pointService.distanceTo(state, state.cha.s);\n            if(distance > state.cml*10) {\n              var direction = pointService.directionTo(state, state.cha.s);\n              var position = pointService.translateInDirection(state.cml*10, direction,\n                                                               state.cha.s);\n              return R.pipe(\n                R.assoc('x', position.x),\n                R.assoc('y', position.y)\n              )(state);\n            }\n          }\n          return state;\n        });\n        modelService.state_checkers = R.append(ensureChargeLength, modelService.state_checkers);\n        var ensureChargeOrientation = R.curry(function _ensureChargeOrientation(info, target, state) {\n          if(R.exists(state.cha)) {\n            if(R.exists(target)) {\n              return R.assoc('r', pointService.directionTo(target.state, state), state);\n            }\n            var distance = pointService.distanceTo(state, state.cha.s);\n            var direction = CHARGE_EPSILON > distance ? state.r :\n                pointService.directionTo(state, state.cha.s);\n            return R.assoc('r', direction, state);\n          }\n          return state;\n        });\n        modelService.state_checkers = R.append(ensureChargeOrientation, modelService.state_checkers);\n        \n        var updateChargeDirection = R.curry(function _updateChargeDirection(state) {\n          if(R.exists(state.cha)) {\n            var distance = pointService.distanceTo(state, state.cha.s);\n            if(distance > CHARGE_EPSILON) {\n              var direction = pointService.directionTo(state, state.cha.s);\n              return R.assocPath(['cha','s','r'], direction, state);\n            }\n          }\n          return state;\n        });\n        modelService.state_updaters = R.append(updateChargeDirection, modelService.state_updaters);\n\n        return modelChargeService;\n      };\n    }\n  ]);\n"]}