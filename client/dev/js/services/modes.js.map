{"version":3,"sources":["../../es6/services/modes.js"],"names":[],"mappings":"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","file":"modes.js","sourcesContent":["'use strict';\n\nangular.module('clickApp.services')\n  .factory('modes', [\n    function modesServiceFactory() {\n      var MODES_REG = {};\n      var modesService = {\n        registerMode: function registerMode(mode) {\n          console.log('modes: registering '+mode.name, mode);\n          MODES_REG[mode.name] = mode;\n        },\n        init: function modesInit(scope) {\n          var modes = {\n            register: MODES_REG,\n          };\n          // TODO : import customized bindings\n          return enterMode('Default', scope, modes);\n        },\n        currentModeName: function(modes) {\n          return currentMode(modes).name;\n        },\n        currentModeBindings: function(modes) {\n          return currentMode(modes).bindings;\n        },\n        currentModeBindingsPairs: function(modes) {\n          return R.pipe(\n            R.toPairsIn,\n            R.sortBy(R.head)\n          )(currentMode(modes).bindings);\n        },\n        currentModeAction: function(action /* ...args..., modes */) {\n          var args = Array.prototype.slice.call(arguments);\n          var modes = R.last(args);\n          var mode = currentMode(modes);\n          return R.pipeP(\n            R.bind(self.Promise.resolve, self.Promise),\n            function() {\n              if(R.isNil(mode.actions[action])) {\n                console.log('modes: unknown mode '+mode.name+' action '+action);\n                return self.Promise.reject('Unknown action '+action);\n              }\n            },\n            function() {\n              return mode.actions[action].apply(null, R.init(R.tail(args)));\n            }\n          )();\n        },\n        switchToMode: function(name, scope, modes) {\n          var previous_mode = currentMode(modes);\n          return R.pipeP(\n            R.bind(self.Promise.resolve, self.Promise),\n            // function() {\n            //   if(next === mode) {\n            //     console.log('modes: already in '+name+' mode');\n            //     return self.Promise.reject('already in '+name+' mode');\n            //   }\n            // },\n            function() {\n              if(R.isNil(R.prop(name, modes.register))) {\n                console.log('modes: error switching to mode '+name+' : does not exists');\n                return self.Promise.reject('mode '+name+' does not exists');\n              }\n              return modes;\n            },\n            leaveMode(scope),\n            enterMode(name, scope),\n            function(modes) {\n              console.log('modes: switch mode from '+ previous_mode.name +\n                          ' to '+ name);\n              scope.gameEvent('switchMode');\n              return modes;\n            }\n          )();\n        }\n      };\n\n      function currentMode(modes) {\n        return modes.register[modes.current];\n      }\n      var enterMode = R.curry(function _enterMode(name, scope, modes) {\n        return R.pipeP(\n          R.bind(self.Promise.resolve, self.Promise),\n          function() {\n            var next_mode = modes.register[name];\n            return ( R.exists(next_mode.onEnter) ?\n                     next_mode.onEnter(scope) :\n                     null\n                   );\n          },\n          function() {\n            modes.current = name;\n            return modes;\n          },\n          setupCurrentModeBindings(scope),\n          setupCurrentModeButtons(scope)\n        )();\n      });\n      var leaveMode = R.curry(function _leaveMode(scope, modes) {\n        var mode = currentMode(modes);\n        if(R.exists(mode.onLeave)) {\n          return self.Promise.resolve(mode.onLeave(scope))\n            .then(R.always(modes));\n        }\n        return modes;\n      });\n      var setupCurrentModeButtons = R.curry(function _setupCurrentModeButtons(scope, modes) {\n        scope.action_buttons = currentMode(modes).buttons;\n        scope.action_bindings = modesService.currentModeBindings(modes);\n        return modes;\n      });\n      var setupCurrentModeBindings = R.curry(function _setupCurrentModeBindings(scope, modes) {\n        Mousetrap.reset();\n        setupBindings(currentMode(modes), scope);\n        return modes;\n      });\n      function setupBindings(mode, scope) {\n        var own_bindings = R.keys(mode.bindings);\n        var all_bindings = R.keysIn(mode.bindings);\n        var inherited_bindings = R.difference(all_bindings,\n                                              own_bindings);\n        R.forEach(function(action) {\n          Mousetrap.bind(mode.bindings[action],\n                         actionBinding(mode.actions, action,\n                                       scope)\n                        );\n        }, inherited_bindings);\n        R.forEach(function(action) {\n          Mousetrap.bind(mode.bindings[action],\n                         actionBinding(mode.actions, action,\n                                       scope)\n                        );\n        }, own_bindings);\n      }\n      function actionBinding(actions, name, scope) {\n        return function binding(event, keys) {\n          console.log('binding', actions, name, keys, event);\n          var res = actions[name](scope, event);\n          event.preventDefault();\n          return self.Promise.resolve(res)\n            .catch(function(reason) {\n              scope.gameEvent('modeActionError', reason);\n            });\n        };\n      }\n      R.curryService(modesService);\n      return modesService;\n    }\n  ])\n  .factory('allModes', [\n    'defaultMode',\n    'rulerMode',\n    'losMode',\n    'createModelMode',\n    'modelsMode',\n    'modelMode',\n    'modelChargeMode',\n    'modelPlaceMode',\n    'createTemplateMode',\n    'aoeTemplateMode',\n    'sprayTemplateMode',\n    'wallTemplateMode',\n    function() { return {}; }\n  ]);\n"]}