{"version":3,"sources":["../../es6/services/modes.js"],"names":[],"mappings":"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","file":"modes.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('modes', [\n    function modesServiceFactory() {\n      var MODES_REG = {};\n      var modesService = {\n        registerMode: function registerMode(mode) {\n          console.log('modes: registering '+mode.name, mode);\n          MODES_REG[mode.name] = mode;\n        },\n        init: function modesInit(state) {\n          var modes = {\n            register: MODES_REG\n          };\n          // TODO : import customized bindings\n          Mousetrap.reset();\n          return enterMode$('Default', state, modes);\n        },\n        exit: function modesExit(state, modes) {\n          return cleanupCurrentModeBindings$(state, modes);\n        },\n        currentModeName: (modes) => {\n          return R.propOr('Unknown', 'name', currentMode(modes));\n        },\n        currentModeActions: (modes) => {\n          return R.propOr({}, 'actions', currentMode(modes));\n        },\n        currentModeBindings: (modes) => {\n          return R.propOr({}, 'bindings', currentMode(modes));\n        },\n        currentModeButtons: (modes) => {\n          return R.propOr({}, 'buttons', currentMode(modes));\n        },\n        currentModeBindingsPairs: (modes) => {\n          return R.pipe(\n            modesService.currentModeBindings,\n            R.toPairsIn,\n            R.sortBy(R.head)\n          )(modes);\n        },\n        currentModeAction: function(action, args, modes) {\n          let mode_name = modesService.currentModeName(modes);\n          return R.pipePromise(\n            currentMode,\n            R.path(['actions',action]),\n            R.rejectIf(R.isNil, `Unknown action \"${action}\" in \"${mode_name}\" mode`),\n            (handler) => {\n              return handler.apply(null, args);\n            }\n          )(modes);\n        },\n        switchToMode: function(name, state, modes) {\n          var previous_mode = currentMode(modes);\n          return R.pipePromise(\n            R.path(['register', name]),\n            R.rejectIf(R.isNil, `Mode ${name} does not exists`),\n            R.always(modes),\n            leaveMode$(state),\n            enterMode$(name, state),\n            R.spy(`Modes: switch mode from ${previous_mode.name} to ${name}`)\n          )(modes);\n        }\n      };\n\n      function currentMode(modes = {}) {\n        return R.pathOr({}, [\n          'register',\n          R.propOr('##', 'current', modes)\n        ], modes);\n      }\n      var enterMode$ = R.curry((name, state, modes) => {\n        return R.pipePromise(\n          R.path(['register', name]),\n          (next_mode) => {\n            return ( R.exists(next_mode.onEnter) ?\n                     next_mode.onEnter(state) :\n                     null\n                   );\n          },\n          R.always(modes),\n          R.assoc('current', name),\n          setupCurrentModeBindings$(state)\n        )(modes);\n      });\n      var leaveMode$ = R.curry((state, modes) => {\n        return R.pipePromise(\n          currentMode,\n          (mode) => {\n            return ( R.exists(mode.onLeave) ?\n                     mode.onLeave(state) :\n                     null\n                   );\n          },\n          R.always(modes),\n          cleanupCurrentModeBindings$(state),\n          R.assoc('current', null)\n        )(modes);\n      });\n      var cleanupCurrentModeBindings$ = R.curry((state, modes) => {\n        Mousetrap.reset();\n        return modes;\n      });\n      var setupCurrentModeBindings$ = R.curry((state, modes) => {\n        setupBindings(currentMode(modes), state);\n        return modes;\n      });\n      function setupBindings(mode, state) {\n        var own_bindings = R.keys(mode.bindings);\n        var all_bindings = R.keysIn(mode.bindings);\n        var inherited_bindings = R.difference(all_bindings,\n                                              own_bindings);\n        R.forEach((action) => {\n          Mousetrap.bind(mode.bindings[action],\n                         actionBinding(action, state)\n                        );\n        }, inherited_bindings);\n        R.forEach((action) => {\n          Mousetrap.bind(mode.bindings[action],\n                         actionBinding(action, state)\n                        );\n        }, own_bindings);\n      }\n      function actionBinding(name, state) {\n        return (event, keys) => {\n          console.warn('binding', name, keys, event);\n\n          state.event('Modes.current.action', name, [event]);\n        };\n      }\n      R.curryService(modesService);\n      return modesService;\n    }\n  ])\n  .factory('allModes', [\n    'defaultMode',\n    'rulerMode',\n    'losMode',\n    'createModelMode',\n    'modelsMode',\n    'modelMode',\n    'modelChargeMode',\n    'modelPlaceMode',\n    'createTemplateMode',\n    'aoeTemplateMode',\n    'sprayTemplateMode',\n    'wallTemplateMode',\n    'createTerrainMode',\n    'terrainMode',\n    () => ({})\n  ]);\n"]}