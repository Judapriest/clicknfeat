{"version":3,"sources":["../../../es6/services/game/connection.js"],"names":[],"mappings":"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","file":"connection.js","sourcesContent":["angular.module('clickApp.services')\n  .factory('gameConnection', [\n    'websocket',\n    function gameConnectionServiceFactory(websocketService) {\n      var gameConnectionService = {\n        create: function gameConnectionInit(game) {\n          var connection = {\n            state: { socket: null }\n          };\n          return R.assoc('connection', connection, game);\n        },\n        open: function gameConnectionOpen(user_name, state, game) {\n          if(R.exists(game.connection.state.socket)) {\n            return self.Promise.resolve(game);\n          }\n          user_name = s.trim(user_name);\n\n          var handlers = {\n            close: closeHandler$(state),\n            chat: chatHandler$(state),\n            replayCmd: replayCmdHandler$(state),\n            undoCmd: undoCmdHandler$(state),\n            cmdBatch: cmdBatchHandler$(state),\n            setCmds: setCmdsHandler$(state),\n            players: playersHandler$(state)\n          };\n\n          game = R.assocPath(['connection','state','socket'], null, game);\n\n          var url = [\n            '/api/games',\n            ( R.prop('private_stamp', game) ?\n              'private' :\n              'public'\n            ),\n            ( R.prop('private_stamp', game) ?\n              R.prop('private_stamp', game) :\n              R.prop('public_stamp', game)\n            )\n          ].join('/');\n          url += '?name='+user_name;\n          \n          return R.pipeP(\n            () => {\n              return websocketService\n                .create(url, 'game', handlers);\n            },\n            (socket) => {\n              return R.assocPath(['connection', 'state', 'socket'],\n                                 socket, game);\n            }\n          )();\n        },\n        close: function gameConnectionClose(game) {\n          return R.pipePromise(\n            R.path(['connection','state','socket']),\n            (socket) => {\n              if(R.isNil(game)) return null;\n\n              return websocketService.close(socket);\n            },\n            R.always(game),\n            gameConnectionService.cleanup\n          )(game);\n        },\n        cleanup: function gameConnectionCleanup(game) {\n          return R.assocPath(['connection','state','socket'], null, game);\n        },\n        active: function gameConnectionActive(game) {\n          return R.pipe(\n            R.path(['connection','state','socket']),\n            R.exists\n          )(game);\n        },\n        sendReplayCommand: function gameConnectionSendReplayCommand(command, game) {\n          return R.pipeP(\n            gameConnectionService.sendEvent$({\n              type: 'replayCmd',\n              cmd: command\n            }),\n            (game) => {\n              return R.over(R.lensProp('commands_log'),\n                            R.compose(R.append(command), R.defaultTo([])),\n                            game);\n            }\n          )(game);\n        },\n        sendUndoCommand: function gameConnectionSendUndoCommand(command, game) {\n          return R.pipeP(\n            gameConnectionService.sendEvent$({\n              type: 'undoCmd',\n              cmd: command\n            }),\n            (game) => {\n              return R.over(R.lensProp('undo_log'),\n                            R.compose(R.append(command), R.defaultTo([])),\n                            game);\n            }\n          )(game);\n        },\n        sendEvent: function gameConnectionSendEvent(event, game) {\n          return R.pipePromise(\n            () => {\n              if(!gameConnectionService.active(game)) {\n                return self.Promise.reject('Not active');\n              }\n              return websocketService\n                .send(event, game.connection.state.socket);\n            },\n            R.always(game)\n          )();\n        }\n      };\n      function closeHandler$(state) {\n        return () => {\n          console.error('Game connection: close');\n          state.event('Game.connection.close');\n        };\n      }\n      var replayCmdHandler$ = R.curry((state, msg) => {\n        console.log('Game connection: replayCmd', msg);\n        state.event('Game.command.replay', msg.cmd);\n      });\n      var undoCmdHandler$ = R.curry((state, msg) => {\n        console.log('Game connection: undoCmd', msg);\n        state.event('Game.command.undo', msg.cmd);\n      });\n      var cmdBatchHandler$ = R.curry((state, msg) => {\n        console.log('Game connection: cmdBatch', msg);\n        state.event('Game.command.replayBatch', msg.cmds);\n      });\n      var chatHandler$ = R.curry((state, msg) => {\n        console.log('Game connection: chat msg', msg);\n        state.event('Game.newChatMsg', msg);\n      });\n      var setCmdsHandler$ = R.curry((state, msg) => {\n        console.log('Game connection: setCmds', msg);\n        state.event('Game.setCmds', msg);\n      });\n      var playersHandler$ = R.curry((state, msg) => {\n        console.log('Game connection: players', msg);\n        state.event('Game.setPlayers', msg.players);\n      });\n      R.curryService(gameConnectionService);\n      return gameConnectionService;\n    }\n  ]);\n"]}