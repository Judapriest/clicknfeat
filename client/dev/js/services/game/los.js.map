{"version":3,"sources":["../../../es6/services/game/los.js"],"names":[],"mappings":"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","file":"los.js","sourcesContent":["'use strict';\n\nangular.module('clickApp.services')\n  .factory('gameLos', [\n    'point',\n    'circle',\n    'gameFactions',\n    'gameModels',\n    function gameLosServiceFactory(pointService,\n                                   circleService,\n                                   gameFactionsService,\n                                   gameModelsService\n                                  ) {\n      var gameLosService = {\n        create: function gameLosCreate() {\n          return {\n            local: {\n              display: false,\n              start: { x: 0, y: 0 },\n              end: { x: 0, y: 0 }\n            },\n            remote: {\n              display: false,\n              start: { x: 0, y: 0 },\n              end: { x: 0, y: 0 }\n            },\n            computed: {}\n          };\n        },\n        isDisplayed: function gameLosIsDisplayed(los) {\n          return R.path(['remote','display'], los);\n        },\n        origin: function gameLosOrigin(los) {\n          return R.path(['remote', 'origin'], los);\n        },\n        setOrigin: function gameLosSetOrigin(origin_model, scope, game, los) {\n          var origin = origin_model.state.stamp;\n          var target = gameLosService.target(los);\n          target = (target === origin) ? null : target;\n          let display = (target && origin);\n          return setOriginTarget(origin, target, null, display,\n                                 scope, game, los);\n        },\n        setOriginResetTarget: function gameLosSetOriginResetTarget(origin_model, scope, game, los) {\n          var origin = origin_model.state.stamp;\n          return setOriginTarget(origin, null, null, false,\n                                 scope, game, los);\n        },\n        target: function gameLosTarget(los) {\n          return R.path(['remote', 'target'], los);\n        },\n        setTarget: function gameLosSetTarget(target_model, scope, game, los) {\n          var origin = gameLosService.origin(los);\n          var target = target_model.state.stamp;\n          origin = (origin === target) ? null : origin;\n          let display = (target && origin);\n          return setOriginTarget(origin, target, null, display,\n                                 scope, game, los);\n        },\n        toggleIgnoreModel: function(model, scope, game, los) {\n          let ignore = R.pathOr([], ['remote','ignore'], los);\n          let is_ignored = R.find(R.equals(model.state.stamp),\n                                  ignore);\n          ignore = ( is_ignored ?\n                     R.reject(R.equals(model.state.stamp), ignore) :\n                     R.append(model.state.stamp, ignore)\n                   );\n          console.log('toggleIgnoreModel', ignore);\n          \n          return setOriginTarget(los.remote.origin,\n                                 los.remote.target,\n                                 ignore,\n                                 los.remote.display,\n                                 scope, game, los);\n        },\n        updateOriginTarget(scope, game, los) {\n          return setOriginTarget(los.remote.origin,\n                                 los.remote.target,\n                                 los.remote.ignore,\n                                 los.remote.display,\n                                 scope, game, los);\n        },\n        toggleDisplay: function gameLosToggleDisplay(scope, game, los) {\n          let path = ['remote','display'];\n          let display = !R.path(path, los);\n\n          return setOriginTarget(los.remote.origin,\n                                 los.remote.target,\n                                 los.remote.ignore,\n                                 display,\n                                 scope, game, los);\n        },\n        setLocal: function gameLosSetLocal(start, end, scope, los) {\n          return R.pipe(\n            R.prop('local'),\n            R.assoc('start', R.clone(start)),\n            R.assoc('end', R.clone(end)),\n            R.assoc('display', true),\n            function(local) {\n              scope.gameEvent('changeLocalLos');\n\n              return R.assoc('local', local, los);\n            }\n          )(los);\n        },\n        setRemote: function gameLosSetRemote(start, end, scope, game, los) {\n          los.local = R.pipe(\n            R.assoc('display', false)\n          )(los.local);          \n          scope.gameEvent('changeLocalLos');\n\n          los.remote = R.pipe(\n            R.assoc('start', R.clone(start)),\n            R.assoc('end', R.clone(end))\n          )(los.remote);\n\n          scope.gameEvent('changeRemoteLos', los);\n          return setOriginTarget(los.remote.origin,\n                                 los.remote.target,\n                                 los.remote.ignore,\n                                 true,\n                                 scope, game, los);\n        },\n        saveRemoteState: function gameLosSaveRemoteState(los) {\n          return R.clone(R.prop('remote', los));\n        },\n        resetRemote: function gameLosResetRemote(state, scope, game, los) {\n          los = R.assoc('remote', R.clone(state), los);\n          return setOriginTarget(los.remote.origin,\n                                 los.remote.target,\n                                 los.remote.ignore,\n                                 los.remote.display,\n                                 scope, game, los);\n        },\n      };\n      function setOriginTarget(origin, target, ignore, display,\n                               scope, game, los) {\n        los.remote = R.pipe(\n          R.assoc('origin', origin),\n          R.assoc('target', target),\n          R.assoc('display', display),\n          R.assoc('ignore', [])\n        )(los.remote);\n        los.computed = R.pipe(\n          R.assoc('envelope', null),\n          R.assoc('darkness', []),\n          R.assoc('shadow', [])\n        )(los.computed);\n\n        // registerListener('origin', origin, scope, los);\n        // registerListener('target', target, scope, los);\n\n        if( !los.remote.origin ||\n            !los.remote.target ) {\n          scope.gameEvent('changeRemoteLos', los);\n          return self.Promise.resolve(los);\n        }\n        los.remote = R.pipe(\n          R.assoc('ignore', R.defaultTo([], ignore))\n        )(los.remote);\n        \n        return R.pipeP(\n          () => {\n            return getOriginTargetInfo(scope, game,\n                                       los.remote.origin,\n                                       los.remote.target);\n          },\n          ([origin_state, origin_info, target_state, target_info]) => {\n            let origin_circle = {\n              x: origin_state.x,\n              y: origin_state.y,\n              radius: origin_info.base_radius\n            };\n            let target_circle = {\n              x: target_state.x,\n              y: target_state.y,\n              radius: target_info.base_radius\n            };\n            let envelope = circleService.envelopeTo(target_circle, origin_circle);\n            los.computed = R.assoc('envelope', envelope, los.computed);\n\n            return R.pipeP(\n              () => {\n                return computeIntervenings(scope, game, los.remote.ignore,\n                                           target, target_circle,\n                                           origin, envelope);\n              },\n              (intervenings) => {\n                return [ origin_circle, intervenings ];\n              }\n            )();\n          },\n          ([ origin_circle, intervenings ]) => {\n            console.log('gameLos intervenings', intervenings);\n\n            let darkness = computeDarkness(origin_circle, intervenings);\n            los.computed = R.assoc('darkness', darkness, los.computed);\n\n            let shadow = computeShadow(origin_circle, intervenings);\n            los.computed = R.assoc('shadow', shadow, los.computed);\n\n            scope.gameEvent('changeRemoteLos', los);\n            return los;\n          }\n        )();\n      }\n      function getOriginTargetInfo(scope, game, origin, target) {\n        return R.pipePromise(\n          () => {\n            return [\n              gameModelsService.findStamp(origin, game.models),\n              gameModelsService.findStamp(target, game.models),\n            ];\n          },\n          R.promiseAll,\n          ([{ state: origin_state }, { state: target_state }]) => {\n            return R.pipePromise(\n              () => {\n                return [\n                  gameFactionsService.getModelInfo(origin_state.info, scope.factions),\n                  gameFactionsService.getModelInfo(target_state.info, scope.factions),\n                ];\n              },\n              R.promiseAll,\n              ([origin_info, target_info]) => {\n                return [\n                  origin_state, origin_info,\n                  target_state, target_info,\n                ];\n              }\n            )();\n          }\n        )();\n      }\n      function computeIntervenings(scope, game, ignore,\n                                   target, target_circle,\n                                   origin, envelope) {\n        return R.pipePromise(\n          gameModelsService.all,\n          R.map((model) => {\n            return R.pipeP(\n              () => {\n                return gameFactionsService\n                  .getModelInfo(model.state.info, scope.factions);\n              },\n              (info) => {\n                return R.assoc('radius', info.base_radius, model.state);\n              }\n            )();\n          }),\n          R.promiseAll,\n          R.reject((circle) => {\n            return (target === circle.stamp ||\n                    origin === circle.stamp ||\n                    target_circle.radius > circle.radius ||\n                    R.find(R.equals(circle.stamp), ignore)\n                   );\n          }),\n          R.filter(circleService.isInEnvelope$(envelope))\n        )(game.models);\n      }                                      \n      function computeDarkness(origin_circle,\n                               intervenings) {\n        return R.map((circle) => {\n          return circleService.outsideEnvelopeTo(circle, [], origin_circle);\n        }, intervenings);\n      }\n      function computeShadow(origin_circle,\n                             intervenings) {\n        return R.map((circle) => {\n          return circleService.outsideEnvelopeTo(circle, intervenings, origin_circle);\n        }, intervenings);\n      }\n      R.curryService(gameLosService);\n      return gameLosService;\n    }\n  ]);\n"]}